{% extends "base.html.j2" %}

{% block title %}GitHub Rate Limits | Stockfish Testing{% endblock %}

{% block body %}

<div id="rate_limits_div">
  <h2>GitHub Rate Limits</h2>
  <table class="table table-striped table-sm">
    <thead>
      <tr>
        <th>Server</th>
        <th>Reset</th>
        <th>Client</th>
        <th>Reset</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>
          <span
            id="server_rate_limit"
            hx-get="/rate_limits"
            hx-trigger="load, every {{ poll.rate_limits_server }}s"
            hx-swap="innerHTML"
          >{{ server_rate_limit }}</span>
        </td>
        <td><span id="server_reset">{{ server_reset }}</span></td>
        <td id="client_rate_limit">-1</td>
        <td id="client_reset">00:00:00</td>
      </tr>
    </tbody>
  </table>
  <p>
    If you are frequently hitting the client rate limit then it is recommended to
    install a
    <a href="https://github.com/settings/personal-access-tokens" target="_blank" rel="noopener noreferrer">
    GitHub personal access token
    </a>
    in your
    <a href="/user">profile</a>.
  </p>
</div>
<script>
  (async () => {
    const errorCSS = "color: red;";
    const refreshTimeMs = 60000;

    await DOMContentLoaded();
    const clientRateLimitDom = document.getElementById("client_rate_limit");
    const clientResetDom = document.getElementById("client_reset");

    const refreshClientRateLimit = async () => {
      try {
        const clientRateLimit = await rateLimit();
        clientRateLimitDom.textContent = clientRateLimit.remaining;
        clientResetDom.textContent = (new Date(1000 * clientRateLimit.reset)).toLocaleTimeString();
        clientRateLimitDom.style.cssText = "";
        clientResetDom.style.cssText = "";
      } catch(e) {
        clientRateLimitDom.style.cssText = errorCSS;
        clientResetDom.style.cssText = errorCSS;
        log(e);
      }
    };

    await refreshClientRateLimit();
    setInterval(refreshClientRateLimit, refreshTimeMs);
  })();
</script>
{% endblock %}
