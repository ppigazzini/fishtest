{% extends "base.html.j2" %}

{% block body %}
<link
  rel="stylesheet"
  href="{{ static_url('fishtest:static/css/flags.css') }}"
>

<h2>Stockfish Testing Queue</h2>

{% if page_idx == 0 %}
  <div class="mw-xxl">
    <div id="homepage-stats">
      {% include "homepage_stats_fragment.html.j2" %}
    </div>
  </div>

  <script>
  (async () => {
    await DOMContentLoaded();
    const btn = document.getElementById("machines-button");
    const target = document.getElementById("machines");

    btn?.addEventListener("click", () => {
      const active = btn.textContent.trim() === "Hide";
      btn.textContent = active ? "Show" : "Hide";
      document.cookie =
        "machines_state=" + btn.textContent.trim() +
        "; max-age={{ 60 * 60 }}; SameSite=Lax";

      if (!active && target && target.dataset.machinesLoaded !== "1") {
        target.dataset.machinesLoaded = "loading";
        htmx.trigger(target, "machines:load");
      }
    });

    target?.addEventListener("htmx:beforeRequest", () => {
      if (target.dataset.machinesLoaded !== "1") {
        target.dataset.machinesLoaded = "loading";
      }
    });

    target?.addEventListener("htmx:afterSwap", (e) => {
      target.dataset.machinesLoaded = "1";
    });

    const showMachinesError = (e) => {
      target.dataset.machinesLoaded = "0";
      const container = e.target;
      container.replaceChildren();
      const wrapper = document.createElement("div");
      wrapper.className = "alert alert-danger d-flex justify-content-between align-items-center";
      const msg = document.createElement("span");
      msg.textContent = "Something went wrong. Please try again.";
      const btn = document.createElement("button");
      btn.className = "btn btn-primary";
      btn.textContent = "Retry";
      btn.setAttribute("hx-get", "/tests/machines");
      btn.setAttribute("hx-target", "#machines");
      btn.setAttribute("hx-swap", "innerHTML");
      btn.setAttribute("hx-disabled-elt", "this");
      wrapper.append(msg, btn);
      container.append(wrapper);
      htmx.process(container);
    };

    target?.addEventListener("htmx:responseError", (e) => {
      showMachinesError(e);
    });
    target?.addEventListener("htmx:sendError", (e) => {
      showMachinesError(e);
    });
  })();
  </script>

  <h4>
    <a id="machines-button" class="btn btn-sm btn-light border"
      data-bs-toggle="collapse" href="#machines" role="button" aria-expanded="false"
      aria-controls="machines">
      {{ 'Hide' if machines_shown else 'Show' }}
    </a>
    <span id="workers-count">
      Workers - {{ machines_count }} machines
    </span>
  </h4>
  {% set height = (machines_count * 37) | string ~ "px" %}
  {% set min_height = "37px" %}
  {% set max_height = "34.7vh" %}
  <section id="machines"
      data-machines-loaded="0"
      class="overflow-auto {{ 'collapse show' if machines_shown else 'collapse' }}"
      hx-get="/tests/machines"
      hx-trigger="{% if machines_shown %}load, {% endif %}machines:load, every {{ poll.machines_homepage }}s [document.getElementById('machines').classList.contains('show')]"
      hx-swap="innerHTML"
      >
      <div id="machines-loading" class="skeleton-wrap">
        <div class="skeleton-line"></div>
        <div
          class="skeleton-block"
          style="height: clamp({{ min_height }}, {{ height }}, {{ max_height }});">
          </div>
      </div>
  </section>
{% endif %}

{% if run_tables_ctx is defined %}
  {% with
    pending_approval_runs=run_tables_ctx.pending_approval_runs,
    paused_runs=run_tables_ctx.paused_runs,
    active_runs=run_tables_ctx.active_runs,
    failed_runs=run_tables_ctx.failed_runs,
    finished_runs=run_tables_ctx.finished_runs,
    num_finished_runs=run_tables_ctx.num_finished_runs,
    finished_runs_pages=run_tables_ctx.finished_runs_pages,
    page_idx=run_tables_ctx.page_idx,
    prefix=run_tables_ctx.prefix,
    toggle_states=run_tables_ctx.toggle_states,
    finished_title_text=run_tables_ctx.finished_title_text,
    show_gauge=run_tables_ctx.show_gauge
  %}
    {% include "run_tables.html.j2" %}
  {% endwith %}
{% else %}
  {% include "run_tables.html.j2" %}
{% endif %}
{% endblock %}
