{% extends "base.html.j2" %}

{% block body %}
<link
  rel="stylesheet"
  href="{{ static_url('fishtest:static/css/flags.css') }}"
>

<h2>Stockfish Testing Queue</h2>

{% if page_idx == 0 %}
  <div class="mw-xxl">
    <div class="row g-3 mb-3">
      <div class="col-6 col-sm">
        <div class="card card-lg-sm text-center">
          <div class="card-header text-nowrap" title="Cores">Cores</div>
          <div class="card-body">
            <h4 class="card-title mb-0 monospace">{{ cores }}</h4>
          </div>
        </div>
      </div>
      <div class="col-6 col-sm">
        <div class="card card-lg-sm text-center">
          <div class="card-header text-nowrap" title="Nodes per second">Nodes / sec</div>
          <div class="card-body">
            <h4 class="card-title mb-0 monospace">{{ nps_m }}</h4>
          </div>
        </div>
      </div>
      <div class="col-6 col-sm">
        <div class="card card-lg-sm text-center">
          <div class="card-header text-nowrap" title="Games per minute">Games / min</div>
          <div class="card-body">
            <h4 class="card-title mb-0 monospace">{{ games_per_minute }}</h4>
          </div>
        </div>
      </div>
      <div class="col-6 col-sm">
        <div class="card card-lg-sm text-center">
          <div class="card-header text-nowrap" title="Time remaining">Time remaining</div>
          <div class="card-body">
            <h4 class="card-title mb-0 monospace">{{ pending_hours }}h</h4>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div data-signals:machines-loaded="false"
       data-signals:machines-shown="{{ 'true' if machines_shown else 'false' }}">

    <h4>
      <a id="machines-button" class="btn btn-sm btn-light border"
        data-bs-toggle="collapse" href="#machines" role="button"
        aria-expanded="{{ 'true' if machines_shown else 'false' }}"
        aria-controls="machines"
        data-on:click="
          $machinesShown = !$machinesShown;
          document.cookie = 'machines_state=' + ($machinesShown ? 'Hide' : 'Show') + '; max-age={{ 60 * 60 }}; SameSite=Lax';
          if ($machinesShown && !$machinesLoaded) {
            $machinesLoaded = true;
            @get('/tests/machines', {retry: 'error', retryMaxCount: 3});
          }
        "
        data-text="$machinesShown ? 'Hide' : 'Show'">
        {{ 'Hide' if machines_shown else 'Show' }}
      </a>
      <span id="workers-count">
        Workers - {{ machines_count }} machines
      </span>
    </h4>
    {% set height = (machines_count * 37) | string ~ "px" %}
    {% set min_height = "37px" %}
    {% set max_height = "34.7vh" %}
    <section id="machines"
        class="overflow-auto {{ 'collapse show' if machines_shown else 'collapse' }}"
        {% if machines_shown %}
          data-init="$machinesLoaded = true; @get('/tests/machines', {retry: 'error', retryMaxCount: 3})"
        {% endif %}
        data-indicator:machines-loading>
        <div class="skeleton-wrap">
          <div class="skeleton-line"></div>
          <div
            class="skeleton-block"
            style="height: clamp({{ min_height }}, {{ height }}, {{ max_height }});">
            </div>
        </div>
    </section>

    <script>
      // Update workers count after machines are loaded.
      document.getElementById("machines")?.addEventListener("datastar-fetch", (e) => {
        if (e.detail?.type === "finished") {
          const tbody = document.querySelector("#machines-table tbody");
          let count = tbody?.childElementCount ?? 0;
          if (count === 1 && document.getElementById("no-machines")) count = 0;
          document.getElementById("workers-count").textContent =
            "Workers - " + count + " machines";
        }
      });
    </script>
  </div>
{% endif %}

{% if run_tables_ctx is defined %}
  {% with
    pending_approval_runs=run_tables_ctx.pending_approval_runs,
    paused_runs=run_tables_ctx.paused_runs,
    active_runs=run_tables_ctx.active_runs,
    failed_runs=run_tables_ctx.failed_runs,
    finished_runs=run_tables_ctx.finished_runs,
    num_finished_runs=run_tables_ctx.num_finished_runs,
    finished_runs_pages=run_tables_ctx.finished_runs_pages,
    page_idx=run_tables_ctx.page_idx,
    prefix=run_tables_ctx.prefix,
    toggle_states=run_tables_ctx.toggle_states,
    finished_title_text=run_tables_ctx.finished_title_text,
    show_gauge=run_tables_ctx.show_gauge
  %}
    {% include "run_tables.html.j2" %}
  {% endwith %}
{% else %}
  {% include "run_tables.html.j2" %}
{% endif %}
{% endblock %}
