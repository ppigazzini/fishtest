# Template metrics (legacy Mako vs Jinja2)

Date: 2026-02-12

This document records the current template metrics and the scripts used to generate them.
All commands run from [WIP/docs](WIP/docs) and invoke the template-focused tooling under [WIP/tools](../tools).

## Scripts (run from WIP/docs)

Legacy Mako metrics:

```
/home/usr00/_git/fishtest-fastapi/server/.venv/bin/python ../tools/templates_mako_metrics.py \
  --templates-dir ../../server/fishtest/templates --json
```

Jinja2 metrics:

```
/home/usr00/_git/fishtest-fastapi/server/.venv/bin/python ../tools/templates_jinja_metrics.py \
  --templates-dir ../../server/fishtest/templates_jinja2 --json
```

Comparative metrics (nesting, script interpolation, escaping heuristics):

```
/home/usr00/_git/fishtest-fastapi/server/.venv/bin/python ../tools/templates_comparative_metrics.py --json
```

HTML parity (raw + normalized + minified score):

```
/home/usr00/_git/fishtest-fastapi/server/.venv/bin/python ../tools/compare_template_parity.py --json
```

## Metrics snapshot (2026-02-12)

Totals (templates, lines, statements, code tags, expressions, score):

- Legacy Mako: templates=26, lines=5611, statements=350, code_tags=78, expressions=492, score=1698
- Jinja2: templates=26, lines=5205, statements=517, code_tags=N/A, expressions=424, score=1975

Heuristic complexity metrics:

- Max nesting (any template): legacy Mako=5, Jinja2=6
- Avg max nesting: legacy Mako=1.58, Jinja2=2.42
- Script interpolation lines: legacy Mako=56, Jinja2=48
- Unescaped occurrences (|n / |safe): legacy Mako=14, Jinja2=0

Notes:
- The score is the same formula used by the analysis scripts: statements*3 + code_tags*2 + expressions.
- Code tags are not applicable to Jinja2 templates and are reported as N/A in summaries.
- Script interpolation lines count template expressions inside <script> blocks.
- Unescaped occurrences are counts of |n (Mako) or |safe (Jinja2) usage.

## Parity scripts (status quo)

- HTML parity: [WIP/tools/compare_template_parity.py](WIP/tools/compare_template_parity.py)
- Parity diff summary: [WIP/tools/compare_template_parity_summary.py](WIP/tools/compare_template_parity_summary.py)
- Response parity: [WIP/tools/compare_template_response_parity.py](WIP/tools/compare_template_response_parity.py)
- Context coverage: [WIP/tools/template_context_coverage.py](WIP/tools/template_context_coverage.py)
- Jinja2 vs legacy Mako runner (legacy name): [WIP/tools/compare_jinja_mako_parity.py](WIP/tools/compare_jinja_mako_parity.py)
- Full parity wrapper (all parity scripts): [WIP/tools/run_parity_all.sh](WIP/tools/run_parity_all.sh)

## HTML parity snapshot (2026-02-12)

Whitespace-minified comparison (spaces/newlines removed) is reported via `minified_score`.

- Templates compared: 25
- Raw equal: 0
- Normalized equal: 25
- Minified equal: 5
- Minified score (avg): 0.9928
- Minified score (min): 0.9371

Validation:
- Re-run after parity/lint verification (2026-02-12); values unchanged.

Notes on normalization:
- The normalization layer handles known deterministic differences between legacy
  Mako and idiomatic Jinja2 output: `document.title` scripts â†’ `<title>` tag,
  `data-options` JSON key ordering, head asset links/scripts, empty script tags.
- Minified diffs are expected because Jinja2 uses `{% block title %}` (head) vs
  Mako's `document.title` scripts (body), `|tojson` vs literal JSON, etc.
- All 25 templates are normalized-equal with idiomatic Jinja2 patterns.

## Response parity snapshot (2026-02-12)

Response-level parity (`compare_template_response_parity.py`) now distinguishes between hard mismatches and known normalized HTML differences.

- Templates compared: 25
- Normalized equal: 5
- Expected normalized diffs (informational): 20
- Hard mismatches: 0

Notes:
- The default mode treats the current known normalized diffs as informational and exits clean.
- Use `--strict` to fail on any normalized HTML mismatch.
