# Iteration plan (Milestone 6 — Contract tests & dual‑suite tests)

Date: 2026-01-29

Status: **Complete (2026-01-30)** — worker route contract tests are covered in the FastAPI suite; legacy Pyramid tests/stubs retained for rebase safety.

This iteration defines Milestone 6: consolidate contract tests for worker and UI protocols while keeping legacy Pyramid tests/stubs for upstream rebase safety, and ensure CI validates the active FastAPI HTTP surface.

Goals
- Replace legacy Pyramid‑importing tests with FastAPI TestClient-based equivalents.
- Document the legacy Pyramid test list and keep those tests for upstream rebase safety.
- Add missing plumbing tests for middleware, dependencies, UI pipeline, and streaming downloads.
- Keep parity scripts and the runbook aligned with the HTTP layout under `server/fishtest/http/`.

Constraints
- Preserve protocol contracts from [1-FASTAPI-REFACTOR.md](1-FASTAPI-REFACTOR.md) (worker `duration`, UI HTML errors).
- Do not change runtime behavior while converting tests.
- Do not delete `server/tests/pyramid/` or any legacy Pyramid‑based test; keep them to ease rebases against upstream.

Acceptance criteria
- CI passes with both the legacy Pyramid tests and the HTTP tests present.
- Full worker protocol contract coverage (all `/api/*` worker endpoints): success + error + validation shapes.
- Full UI contract coverage: login/logout, CSRF, 403/404 HTML rendering, representative list/detail page rendering, and session cookie commit on errors.
- Tests for middleware behaviors: `ShutdownGuardMiddleware`, `AttachRequestStateMiddleware`, `RedirectBlockedUiUsersMiddleware`, `RejectNonPrimaryWorkerApiMiddleware`.
- Tests for dependency helpers and template token cache.
- Each Pyramid‑based test has a `test_http_*` twin that covers at least the same test cases.
- `fishtest.app` entrypoint is covered by a focused test.

Metrics
- Contract coverage includes all worker endpoints and at least one UI list + detail page.
- HTTP middleware tests cover all four middleware classes.

Phases

Phase 0 — Inventory & gaps
- Enumerate tests importing `pyramid.*` and map each to a FastAPI test replacement.
- Confirm parity script paths target `server/fishtest/http/*`.
- Record the legacy Pyramid test list and their `test_http_*` twins in this iteration report.

Phase 1 — FastAPI test equivalents
- For each legacy test importing `pyramid.*`, create a FastAPI equivalent using `fastapi_util.make_test_client` or `build_test_app`.
- Prioritize worker endpoints and UI critical paths (Protocol A/B in [1-FASTAPI-REFACTOR.md](1-FASTAPI-REFACTOR.md)).
- Use the bloat branch tests as reference patterns (adapt to `http/`):
	- [__fishtest-bloat/server/tests/test_web_api_worker.py](__fishtest-bloat/server/tests/test_web_api_worker.py)
	- [__fishtest-bloat/server/tests/test_web_middleware.py](__fishtest-bloat/server/tests/test_web_middleware.py)
	- [__fishtest-bloat/server/tests/test_web_session.py](__fishtest-bloat/server/tests/test_web_session.py)
	- [__fishtest-bloat/server/tests/test_web_ui_actions.py](__fishtest-bloat/server/tests/test_web_ui_actions.py)

Phase 2 — Plumbing tests
- Add unit tests for middleware behavior and error shaping.
- Add tests for cookie/session commit semantics on UI error pages.
- Add tests for `request.form(...)` limits and JSON decode error shaping.
- Add streaming download tests: headers + content match the protocol expectations.

Concrete test targets (current repo):
- Worker protocol contract: [server/tests/test_http_api.py](server/tests/test_http_api.py)
- UI actions pagination: [server/tests/test_http_actions_view.py](server/tests/test_http_actions_view.py)
- Middleware behavior: add coverage comparable to [__fishtest-bloat/server/tests/test_web_middleware.py](__fishtest-bloat/server/tests/test_web_middleware.py)
- Session semantics: extend [server/tests/test_http_ui_session_semantics.py](server/tests/test_http_ui_session_semantics.py)
- Error shaping: [server/tests/test_http_errors.py](server/tests/test_http_errors.py)
- Helpers/invariants: [server/tests/test_http_helpers.py](server/tests/test_http_helpers.py)
- App entrypoint: [server/tests/test_http_app.py](server/tests/test_http_app.py)

Phase 3 — Keep Pyramid stubs (rebase safety)
- Retain `server/tests/pyramid/` and legacy tests alongside `test_http_*` twins.
- Run CI to ensure both suites remain green and rebases stay clean.

Phase 4 — Harden contract tests
- Add negative cases for malformed JSON, missing fields, and auth failures.
- Add UI route tests for CSRF failures and forbidden/notfound HTML responses.

Notes and rationale
- Keeping tests focused on the active server reduces maintenance and ensures parity scripts test the running surface.
- Removing `server/tests/pyramid/` is conditional on coverage completeness; do not remove earlier than the acceptance gates.

Phase results (current branch)
- Phase 0: Pyramid-importing tests documented in [server/tests/test_actions_view.py](server/tests/test_actions_view.py), [server/tests/test_api.py](server/tests/test_api.py), [server/tests/test_users.py](server/tests/test_users.py); stubs live under [server/tests/pyramid/](server/tests/pyramid/). Legacy tests are retained for rebase safety.
- Phase 1: HTTP equivalents present in [server/tests/test_http_actions_view.py](server/tests/test_http_actions_view.py), [server/tests/test_http_api.py](server/tests/test_http_api.py), [server/tests/test_http_users.py](server/tests/test_http_users.py).
- Phase 2: Middleware coverage in [server/tests/test_http_middleware.py](server/tests/test_http_middleware.py) for `ShutdownGuardMiddleware`, `AttachRequestStateMiddleware`, `RedirectBlockedUiUsersMiddleware`, `RejectNonPrimaryWorkerApiMiddleware`.
- Phase 2: Added missing legacy cases in [server/tests/test_http_api.py](server/tests/test_http_api.py): `get_active_runs`, `get_run`, `get_elo`, `request_task`, `duplicate_workers`, `auto_purge_runs`.
- Phase 2: Completed UI session commit/error shaping coverage, request.form limit handling, JSON decode assertions, and streaming download verification inside the FastAPI surface (tests under `server/tests/test_http_*`).
- Phase 3: Pyramid stubs preserved alongside HTTP twins; CI validation showed both suites running (legacy + HTTP) without regressions.
- Phase 4: Hardened contract coverage with additional negative cases for malformed JSON, missing fields, auth failures, CSRF errors, and 403/404 HTML responses.
- App entrypoint coverage in [server/tests/test_http_app.py](server/tests/test_http_app.py).
Iteration 6 deliverables
- FastAPI worker contract tests ( `server/tests/test_http_api.py` and related helpers) cover every `/api/*` path with positive, negative, and validation cases plus the middleware guards that had been missing previously.
- UI surface tests (`server/tests/test_http_*`) now exercise session error handling, CSRF/403/404 rendering, dependency helpers, streaming endpoints, and template token cache invariants.
- Legacy Pyramid tests retained for rebase safety while CI now runs both suites in lockstep.
- Documented the completed test migration effort in the parity report and linked tools.

Verification
- CI run (2026-01-29): `uv run python -m unittest discover -s server/tests -q` (passes all FastAPI + Pyramid tests).
- CI run (2026-01-29): `uv run python WIP/tools/parity_check_*` suite (ensures route/AST parity with `server/fishtest/http`).
