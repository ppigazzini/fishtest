# Iteration record (Milestone 2 — behavioral parity + contract-test gate) — completed

Date: 2026-01-23

Milestone definition: [3-MILESTONES.md](3-MILESTONES.md)
> [!NOTE]
> **Protocol contracts** (worker API + UI behavior) are canonically documented in [1-FASTAPI-REFACTOR.md](1-FASTAPI-REFACTOR.md).
Goal (Milestone 2): lock down parity for externally-visible behaviors before doing idiomatic refactors.

Status: **completed** (see “Milestone 2 — reached” in [3-MILESTONES.md](3-MILESTONES.md)).

General iteration rules: [3.0-ITERATION-RULES.md](3.0-ITERATION-RULES.md)

## Phases (all completed)

### Phase 1 — Worker protocol parity gates

- [x] Worker endpoints enumerated as the parity checklist in [1-FASTAPI-REFACTOR.md](1-FASTAPI-REFACTOR.md).
- [x] FastAPI HTTP contract tests exist for worker endpoints in [server/tests/test_http_api.py](../../server/tests/test_http_api.py).

### Phase 2 — Centralized error shaping parity

- [x] Error shaping is centralized in [server/fishtest/glue/errors.py](../../server/fishtest/glue/errors.py).
- [x] Regression tests cover JSON-vs-HTML and worker validation shaping in [server/tests/test_http_errors.py](../../server/tests/test_http_errors.py).

### Phase 3 — UI session + CSRF semantics gates

- [x] UI flows are exercised by FastAPI tests (auth basics) in [server/tests/test_http_users.py](../../server/tests/test_http_users.py).
- [x] UI session/CSRF invariants are regression-tested in [server/tests/test_http_ui_session_semantics.py](../../server/tests/test_http_ui_session_semantics.py).

### Phase 4 — Parity tooling exists for rebase safety

- [x] Route surface parity tooling exists under [WIP/tools/](../tools/):
  - [WIP/tools/parity_check_api_routes.py](../tools/parity_check_api_routes.py)
  - [WIP/tools/parity_check_views_routes.py](../tools/parity_check_views_routes.py)
  - [WIP/tools/parity_check_api_ast.py](../tools/parity_check_api_ast.py)
  - [WIP/tools/parity_check_views_ast.py](../tools/parity_check_views_ast.py)

## Outcome

- Behavior regressions that matter to workers/UI are caught before refactors land.
