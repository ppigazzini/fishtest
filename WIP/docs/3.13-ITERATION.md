# Iteration plan (Milestone N — Finalize branch for upstream merge)

Date: 2026-02-14
Status: not started

## Goals

- Remove all legacy Pyramid code, test stubs, and spec modules from the repository.
- Move active HTTP route modules (`http/api.py`, `http/views.py`) to their final locations (`server/fishtest/api.py`, `server/fishtest/views.py`), replacing the legacy Pyramid twins.
- Remove Mako templates, test dependency, and parity tooling that depends on Mako.
- Update authoritative documentation (`1-FASTAPI-REFACTOR.md`, `2-ARCHITECTURE.md`) to describe the final FastAPI/Jinja2 architecture, not the migration process.
- Create permanent project documentation in `server/fishtest/docs/` (architecture, threading model, API reference, UI reference, templates, deployment).
- Write the conventional commit message for squashing the branch into a single commit for the upstream PR.
- Optionally (PR branch only): delete the `WIP/` folder.

## Non-goals

- No feature changes to the FastAPI server.
- No template redesign (Jinja2 migration is complete).
- No DB adapter or scheduling redesign.
- No worker protocol shape changes.
- No new middleware, dependencies, or HTTP modules.

## Requirements

- All contract tests pass after each phase.
- Full local test suite passes (`bash WIP/tools/run_local_tests.sh`).
- No runtime imports from `pyramid.*` or `mako.*` remain in `server/fishtest/`.
- `server/pyproject.toml` lists only FastAPI/Starlette/Jinja2/Uvicorn as server framework dependencies.
- Authoritative docs describe the final state, not the migration.

## References

- Roadmap: [3-MILESTONES.md](3-MILESTONES.md) (Milestone N)
- Iteration rules: [3.0-ITERATION-RULES.md](3.0-ITERATION-RULES.md)
- Architecture: [2-ARCHITECTURE.md](2-ARCHITECTURE.md)
- Migration plan: [1-FASTAPI-REFACTOR.md](1-FASTAPI-REFACTOR.md)
- M12 iteration: [3.12-ITERATION.md](3.12-ITERATION.md)
- Rebase strategy: [5-REBASE.md](5-REBASE.md)
- Current views: [server/fishtest/http/views.py](../../server/fishtest/http/views.py)
- Current api: [server/fishtest/http/api.py](../../server/fishtest/http/api.py)
- Current app: [server/fishtest/app.py](../../server/fishtest/app.py)

---

## Current State Inventory (post-M12)

### Legacy Pyramid artifacts still in tree

| Artifact | Location | Purpose | Action |
|----------|----------|---------|--------|
| `api.py` (Pyramid) | `server/fishtest/api.py` | Behavioral spec; legacy tests import it | Delete; replace with `http/api.py` move |
| `views.py` (Pyramid) | `server/fishtest/views.py` | Behavioral spec; legacy tests import it | Delete; replace with `http/views.py` move |
| `models.py` (Pyramid ACL) | `server/fishtest/models.py` | `pyramid.security.Allow/Everyone` | Delete (unused by FastAPI) |
| `__init__.py` (Pyramid app factory) | `server/fishtest/__init__.py` | Pyramid `main()` + `includeme()` | Rewrite to minimal package init |
| `test_actions_view.py` | `server/tests/` | Tests Pyramid views | Delete |
| `test_api.py` | `server/tests/` | Tests Pyramid API | Delete |
| `test_users.py` | `server/tests/` | Tests Pyramid users | Delete |
| `test_rundb.py` | `server/tests/` | Domain RunDb coverage | Keep |
| `test_github_api.py` | `server/tests/` | Domain GitHub API coverage | Keep |
| `tests/pyramid/` | `server/tests/pyramid/` | Pyramid stub package for imports | Delete entire directory |
| Mako templates | `server/fishtest/templates/` | Legacy parity anchor | Delete entire directory |
| `mako>=1.3.10` | `server/pyproject.toml` test deps | Parity script dependency | Remove from `[dependency-groups] test` |

### Files that import from legacy modules

Files that import from `server/fishtest/api.py` or `server/fishtest/views.py` (Pyramid twins):
- `server/tests/test_actions_view.py` (deleted in Phase 1)
- `server/tests/test_api.py` (deleted in Phase 1)
- `server/tests/test_users.py` (deleted in Phase 1)

Files that import from `server/tests/pyramid/`:
- `server/fishtest/api.py` (Pyramid twin — deleted in Phase 2)
- `server/fishtest/views.py` (Pyramid twin — deleted in Phase 2)
- `server/fishtest/models.py` (Pyramid ACL — deleted in Phase 2)
- `server/tests/test_actions_view.py` (deleted in Phase 1)
- `server/tests/test_api.py` (deleted in Phase 1)
- `server/tests/test_rundb.py` (kept; domain-layer coverage)
- `server/tests/test_github_api.py` (kept; domain-layer coverage)

### Files that import from `server/fishtest/http/api.py` or `server/fishtest/http/views.py`

These must be updated when the route modules move up (Phase 2):
- `server/fishtest/app.py` (`from fishtest.http.api import router as api_router`, `from fishtest.http.views import router as views_router`)
- `server/fishtest/http/errors.py` (if it imports from `http.api` or `http.views`)
- `server/fishtest/http/middleware.py`
- `server/tests/fastapi_util.py`
- `server/tests/test_http_actions_view.py`
- `server/tests/test_http_api.py`
- `server/tests/test_http_boundary.py`
- `server/tests/test_http_helpers.py`
- `server/tests/test_http_users.py`

### Parity tooling that uses legacy paths

- `WIP/tools/parity_check_api_ast.py` — compares `server/fishtest/api.py` (Pyramid) vs `server/fishtest/http/api.py` (FastAPI)
- `WIP/tools/parity_check_views_ast.py` — compares `server/fishtest/views.py` (Pyramid) vs `server/fishtest/http/views.py` (FastAPI)
- `WIP/tools/parity_check_api_routes.py` — reads both Pyramid and FastAPI route surfaces
- `WIP/tools/parity_check_views_routes.py` — reads both route surfaces
- `WIP/tools/parity_check_hotspots_similarity.py` — computes similarity between Pyramid and FastAPI twins
- `WIP/tools/parity_check_urls_dict.py`
- `WIP/tools/compare_template_parity.py` — compares Mako vs Jinja2 output
- `WIP/tools/compare_jinja_mako_parity.py` — Mako/Jinja2 parity
- `WIP/tools/template_context_coverage.py` — checks Mako + Jinja2 context

---

## Phases

### Phase 0 — Test baseline and dependency audit

Checklist:
- [x] Run full local test suite and record baseline pass/fail count.
- [x] Run all parity scripts and record baseline.
- [x] Run `grep -rn 'from pyramid\|import pyramid\|from mako\|import mako' server/fishtest/ --include='*.py'` and catalog every hit (excluding `__pycache__`).
- [x] Catalog all test files that import from the legacy Pyramid spec modules (`server/fishtest/api.py`, `server/fishtest/views.py`, `server/fishtest/models.py`).
- [x] Catalog all test files that import from `server/tests/pyramid/`.
- [x] Catalog all code/test files that import from `server/fishtest/http/api.py` or `server/fishtest/http/views.py` (these need path updates in Phase 2).
- [x] Verify `server/fishtest/__init__.py` state and replacement plan.

Phase 0 baseline results (2026-02-14):

- Full local suite (`bash WIP/tools/run_local_tests.sh`): **133 tests run, 20 skipped, OK**.
- Skip reason: FastAPI HTTP `TestClient` tests are skipped because `httpx` is missing in the current environment.
- Parity suite (`bash WIP/tools/run_parity_all.sh`):
  - Passed: `parity_check_api_routes.py`, `parity_check_views_routes.py`, `parity_check_api_ast.py`, `parity_check_views_ast.py`, `parity_check_hotspots_similarity.py`, `parity_check_urls_dict.py`, `parity_check_views_no_renderer.py`.
  - Failed: `compare_template_parity.py` with `ModuleNotFoundError: No module named 'mako'`.
- Runtime import audit (`server/fishtest/**/*.py`) found `pyramid` imports only in:
  - `server/fishtest/api.py`
  - `server/fishtest/views.py`
  - `server/fishtest/models.py`
  - No `mako` imports in `server/fishtest/**/*.py`.
- Tests importing legacy spec modules:
  - `server/tests/test_actions_view.py`
  - `server/tests/test_api.py`
  - `server/tests/test_users.py`
  - `server/tests/test_rundb.py`
  - `server/tests/test_github_api.py`
- Tests importing Pyramid surfaces/stubs:
  - `server/tests/test_actions_view.py`
  - `server/tests/test_api.py`
  - `server/tests/test_users.py`
  - `server/tests/pyramid/__init__.py` (stub re-export)
- Code/tests importing `fishtest.http.api` or `fishtest.http.views`:
  - `server/fishtest/app.py`
  - `server/fishtest/http/errors.py`
  - `server/fishtest/http/middleware.py`
  - `server/tests/fastapi_util.py`
  - `server/tests/test_http_actions_view.py`
  - `server/tests/test_http_api.py`
  - `server/tests/test_http_boundary.py`
  - `server/tests/test_http_helpers.py`
- `server/fishtest/__init__.py` is already a minimal package file and does **not** contain Pyramid `main()`/`includeme()`; no replacement needed in Phase 2.

### Phase 1 — Delete legacy Pyramid tests

Target: remove test modules that test Pyramid-era surfaces and depend on Pyramid stubs.

Checklist:
- [x] Delete `server/tests/test_actions_view.py`.
- [x] Delete `server/tests/test_api.py`.
- [x] Delete `server/tests/test_users.py`.
- [x] Keep `server/tests/test_rundb.py` (domain-layer coverage).
- [x] Keep `server/tests/test_github_api.py` (domain-layer coverage).
- [x] Delete `server/tests/pyramid/` directory (all stubs: `__init__.py`, `security.py`, `httpexceptions.py`, `view.py`, `response.py`, `testing.py`).
- [x] Run remaining test suite — verify no import errors from deleted modules.
- [x] Run `bash WIP/tools/run_local_tests.sh` and record new baseline.

Phase 1 results (2026-02-14):

- Deleted files:
  - `server/tests/test_actions_view.py`
  - `server/tests/test_api.py`
  - `server/tests/test_users.py`
  - `server/tests/pyramid/` (entire directory)
- Post-deletion import check (`server/tests/**/*.py`): no remaining imports from `fishtest.api`, `fishtest.views`, or `pyramid.*`.
- Post-deletion test baseline (`bash WIP/tools/run_local_tests.sh`): **91 tests run, 20 skipped, OK**.
- Skip reason unchanged: FastAPI HTTP `TestClient` tests are skipped because `httpx` is missing in the current environment.

Impact:
- Pyramid-facing tests were removed while domain-layer tests were kept.
- `test_rundb.py` and `test_github_api.py` remain in-suite to preserve core-domain coverage.
- FastAPI contract tests (`test_http_*.py`) remain the primary HTTP test suite.

### Phase 2 — Delete Pyramid spec modules and move HTTP routes up

Target: replace the Pyramid-era `server/fishtest/api.py` and `server/fishtest/views.py` with the active FastAPI versions from `http/`.

Checklist:
- [x] Delete `server/fishtest/models.py` (Pyramid ACL — `Allow`, `Everyone`).
- [x] Delete `server/fishtest/api.py` (Pyramid behavioral spec).
- [x] Delete `server/fishtest/views.py` (Pyramid behavioral spec).
- [x] Move `server/fishtest/http/api.py` → `server/fishtest/api.py`.
- [x] Move `server/fishtest/http/views.py` → `server/fishtest/views.py`.
- [x] Update `server/fishtest/app.py` imports:
  - `from fishtest.http.api import router as api_router` → `from fishtest.api import router as api_router`
  - `from fishtest.http.views import router as views_router` → `from fishtest.views import router as views_router`
- [x] Update `server/fishtest/http/errors.py` imports if it references `http.api` or `http.views`.
- [x] Update all test imports:
  - Move `server/tests/fastapi_util.py` code into `server/tests/test_support.py`.
  - Rename `server/tests/util.py` to `server/tests/test_support.py`.
  - Delete `server/tests/fastapi_util.py` and update imports in test files to use `test_support.py`.
  - Simplify imports: use direct `import test_support` in tests (remove fallback import patterns).
  - Move shared teardown helpers into `test_support.py` and update tests to use them.
  - Rename route-level tests that no longer target `server/fishtest/http/*` modules:
    - `server/tests/test_http_api.py` → `server/tests/test_api.py`
    - `server/tests/test_http_actions_view.py` → `server/tests/test_actions_view.py`
    - `server/tests/test_http_users.py` → `server/tests/test_users.py`
    - `server/tests/test_http_app.py` → `server/tests/test_app.py`
  - Keep `_http_` in filenames only for tests that exercise `server/fishtest/http/*` modules.
  - Remaining `_http_` tests after rename:
    - `server/tests/test_http_boundary.py`
    - `server/tests/test_http_errors.py`
    - `server/tests/test_http_helpers.py`
    - `server/tests/test_http_middleware.py`
    - `server/tests/test_http_ui_session_semantics.py`
- [x] Update internal imports within `api.py` and `views.py` if they reference `fishtest.http.api` or `fishtest.http.views` paths.
- [x] Verify `server/fishtest/__init__.py` is already a minimal package init (no rewrite needed).
- [x] Run full test suite — verify all imports resolve and tests pass.
- [x] Run lint: `bash WIP/tools/lint_http.sh`.

Phase 2 results (2026-02-14):

- Legacy Pyramid spec modules removed from active server tree:
  - `server/fishtest/models.py`
  - old Pyramid `server/fishtest/api.py`
  - old Pyramid `server/fishtest/views.py`
- Active FastAPI route modules moved to final locations:
  - `server/fishtest/http/api.py` → `server/fishtest/api.py`
  - `server/fishtest/http/views.py` → `server/fishtest/views.py`
- Runtime imports updated:
  - `server/fishtest/app.py`
  - `server/fishtest/http/errors.py`
  - `server/fishtest/http/middleware.py`
- Test helper consolidation completed:
  - `server/tests/fastapi_util.py` merged into `server/tests/test_support.py`
  - `server/tests/util.py` renamed to `server/tests/test_support.py`
  - `server/tests/fastapi_util.py` deleted
  - Shared `cleanup_test_rundb()` helper added to `test_support.py` and adopted by multiple test modules
- Test file renames completed:
  - `test_http_api.py` → `test_api.py`
  - `test_http_actions_view.py` → `test_actions_view.py`
  - `test_http_users.py` → `test_users.py`
  - `test_http_app.py` → `test_app.py`
- Verification:
  - Full suite (`bash WIP/tools/run_local_tests.sh`): **91 tests run, 20 skipped, OK**.
  - Lint (`bash WIP/tools/lint_http.sh`): **all checks passed**.
  - Import audit (`server/fishtest/**/*.py`): no remaining `pyramid.*` imports.

Impact:
- `server/fishtest/api.py` and `server/fishtest/views.py` are now the active FastAPI modules — no more "legacy twin" distinction.
- Parity scripts that compared Pyramid vs FastAPI twins are no longer applicable (handled in Phase 3).

### Phase 3 — Remove Mako templates and test dependency

Target: remove Mako templates/dependency from active runtime and retire obsolete
tooling by moving it under `WIP/tools/retired` (do not delete retired tools).

Checklist:
- [x] Delete `server/fishtest/templates/` directory (all `.mak` files).
- [x] Remove `mako>=1.3.10` from `server/pyproject.toml` `[dependency-groups] test`.
- [x] Move retired Mako-dependent scripts to `WIP/tools/retired` (do not delete):
  - `compare_template_parity.py`, `compare_jinja_mako_parity.py`, `compare_template_parity_summary.py`, `compare_template_response_parity.py`
  - `template_context_coverage.py`, `template_missing_tags.py`, `templates_mako_metrics.py`, `templates_comparative_metrics.py`, `templates_benchmark.py`
  - `_stubs.py`, `verify_template_response_metadata.py`
- [x] Move retired Pyramid-twin parity scripts to `WIP/tools/retired` (do not delete):
  - `parity_check_api_ast.py`, `parity_check_api_routes.py`, `parity_check_views_ast.py`, `parity_check_views_routes.py`, `parity_check_views_no_renderer.py`, `parity_check_hotspots_similarity.py`
  - `run_parity_all.sh`
- [x] Move related generated parity artifacts to `WIP/tools/retired` (do not delete):
  - `actions_parity_diff.json`, `contributors_parity_diff.json`, `template_context_coverage.json`, `template_parity_context.json`, `template_parity_diff_summary.json`, `template_parity_latest.json`
- [x] Keep reusable non-retired scripts in `WIP/tools` for future analysis tooling work:
  - `lint_http.sh`, `lint_tools.sh`, `run_local_tests.sh`, `parity_check_urls_dict.py`, `templates_jinja_metrics.py`
- [x] Run `uv lock` in `server/` to regenerate lockfile without Mako.
- [x] Run full test suite.

Phase 3 results (2026-02-14):

- Runtime/template cleanup:
  - Deleted `server/fishtest/templates/`.
  - Removed `mako>=1.3.10` from `server/pyproject.toml` test dependencies.
  - Regenerated lockfile (`uv lock`): `mako v1.3.10` removed.
- Tooling retirement policy applied exactly as requested:
  - No retired files were deleted from `WIP/tools`; they were moved into `WIP/tools/retired`.
  - `WIP/tools` now keeps only active/reusable scripts for ongoing analysis and validation.
- Verification:
  - Full suite (`bash WIP/tools/run_local_tests.sh`): **91 tests run, 20 skipped, OK**.
  - Import audit (`server/fishtest/**/*.py`): no remaining `mako.*` imports.

### Phase 3.1 — Rename Jinja2 templates directory to `templates`

Target: rename runtime Jinja2 directory `server/fishtest/templates_jinja2/` to
`server/fishtest/templates/` and update all references across runtime code,
tooling, and documentation.

Checklist:
- [x] Rename directory: `server/fishtest/templates_jinja2/` → `server/fishtest/templates/`.
- [x] Update runtime template loader path:
  - `server/fishtest/http/jinja.py`
- [x] Update docs under `docs/` (exhaustive):
  - `docs/1-architecture.md`
  - `docs/4-ui-reference.md`
  - `docs/5-templates.md`
  - `docs/8-references.md`
- [x] Verify there are no remaining `templates_jinja2` references in the active tree (excluding this Phase 3.1 record text).
- [x] Run full test suite.
- [x] Run HTTP lint script.

Phase 3.1 results (2026-02-14):

- Renamed runtime Jinja2 template directory to `server/fishtest/templates/`.
- Updated runtime/template loader path in `server/fishtest/http/jinja.py`.
- Updated all known docs and tooling references listed above.
- Validation: `grep -RIn "templates_jinja2" . --exclude-dir=.venv --exclude-dir=__pycache__ --exclude-dir=__fishtest-bloat --exclude='3.13-ITERATION.md'` returns no matches.
- Test verification (`cd server && uv run python -m unittest discover -s tests -q`): **Ran 91 tests in 3.319s, OK (skipped=20)**.
- Lint verification (`cd server && bash ../WIP/tools/lint_http.sh`): **All checks passed**.

### Phase 4 — Update authoritative documentation

Target: update file paths and remove references to deleted Pyramid artifacts
in `1-FASTAPI-REFACTOR.md` and `2-ARCHITECTURE.md`. No information loss —
only surgical adjustments reflecting the Phase 2–3 file moves/deletions.
WIP docs are NOT retired or restructured; they remain as reference material.
New permanent documentation will be created in Phase 6 under `server/fishtest/docs/`.

Checklist:
- [x] Update `2-ARCHITECTURE.md`: change `http/api.py` → `api.py` and `http/views.py` → `views.py` in the module map and all path references.
  - Remove `api.py` / `views.py` from the "reference/spec only" section (they are now the active modules).
  - Remove `models.py` references (Pyramid ACL — deleted).
  - Remove `templates/` (Mako) from the module map.
  - Remove `tests/pyramid/` stub references.
  - Update Section 7.3 to note that Pyramid spec modules no longer exist (keep architectural comparison information).
  - Update Section 9 test references (`util.py` → `test_support.py`, remove Pyramid stub note).
  - Keep all other content intact.
- [x] Update `1-FASTAPI-REFACTOR.md`:
  - Change `http/api.py` → `api.py` and `http/views.py` → `views.py` in all path references.
  - Update "Current status" section: remove "Reference/spec only" block, remove CI pyramid stub note.
  - Update "What stays stable" paths.
  - Keep all protocol contracts, strategy, and operational content intact.
- [x] Do NOT touch `0-INDEX.md` or any other WIP docs.
- [x] Run full test suite to verify no docs were accidentally imported.

Phase 4 results (2026-02-14):

- `2-ARCHITECTURE.md` updated:
  - Server package layout: `api.py` and `views.py` listed as top-level active modules (not in `http/` subdirectory).
  - Removed Pyramid spec module entries, Mako `templates/` directory, and legacy Pyramid layout section.
  - Section 7.3 rewritten: "How the HTTP layer differs from the original Pyramid design" (notes spec modules removed; keeps architectural comparison).
  - Section 9: Pyramid stubs paragraph updated to note removal; `util.py` → `test_support.py`; parity tools reference removed.
  - All `http/api.py` and `http/views.py` path references updated throughout.
- `1-FASTAPI-REFACTOR.md` updated:
  - Merge hotspots, Current status, Tooling rules, What stays stable, and Cutover architecture all updated with correct paths.
  - "Reference/spec only" block removed; CI testing status updated to note Pyramid stubs removed.
  - Mako parity references updated to note retirement.
  - M13 status entry added.
- No other WIP docs were touched.
- Verification:
  - Full suite (`bash WIP/tools/run_local_tests.sh`): **91 tests run, 20 skipped, OK**.

### Phase 5 — Final verification

Checklist:
- [x] Run full local test suite: `bash WIP/tools/run_local_tests.sh` (or re-located equivalent).
- [x] Run lint: `bash WIP/tools/lint_http.sh` (or re-located equivalent).
- [x] Verify no remaining `pyramid` or `mako` imports: `grep -rn 'from pyramid\|import pyramid\|from mako\|import mako' server/ --include='*.py' | grep -v __pycache__`.
- [x] Verify `server/pyproject.toml` has no Pyramid or Mako references.
- [x] Verify deployment entrypoint: `uvicorn fishtest.app:app` imports cleanly.
- [x] Record final metrics in this document.

Phase 5 results (2026-02-14):

- Full suite (`bash WIP/tools/run_local_tests.sh`): **91 tests run, 20 skipped, OK**.
- Lint (`bash WIP/tools/lint_http.sh`): **all checks passed**.
- Import audit (`server/**/*.py`): no remaining `pyramid.*` or `mako.*` imports.
- Packaging audit (`server/pyproject.toml`): no `pyramid` or `mako` references.
- Entrypoint import check (`cd server && uv run python -c 'import fishtest.app'`): **OK**.

### Phase 6 — Create permanent project documentation (`docs/`)

Target: create authoritative, contributor-facing documentation for the fishtest projec:
FastAPI server and worker. These describe the finished system (not the migration). WIP docs
remain as a retirement folder and source material.

Source material and detailed document layouts are in [Appendix A](#appendix-a--documentation-layouts-for-phase-6).

Checklist:
- [x] Create `docs/` directory.
- [x] Write `docs/README.md` (index).
- [x] Write `docs/architecture.md`.
- [x] Write `docs/threading-model.md`.
- [x] Write `docs/api-reference.md`.
- [x] Write `docs/ui-reference.md`.
- [x] Write `docs/templates.md`.
- [x] Write `docs/deployment.md`.
- [x] Cross-check every file path, module name, and function name against the codebase.
- [x] Review each doc for migration-era language and remove it.
- [x] Run full test suite (docs don't break imports but verify nothing was accidentally touched).

Phase 6 results (2026-02-15):

- Created `docs/` directory at repo root with 7 documents:
  - `README.md` — documentation index, tech stack, quick start
  - `architecture.md` — full module map, middleware stack, startup/shutdown, request flow, primary/secondary model, domain adapters, validation, error handling
  - `threading-model.md` — [LOOP]/[THREAD]/[STREAM/THREAD] domains, component inventory, event-loop hotspots, 5 rules for new code
  - `api-reference.md` — protocol invariants, 9 authenticated endpoints with request/response shapes, CORS support (2 OPTIONS endpoints), 11 read-only endpoints, validation, error shape, adding endpoint guide
  - `ui-reference.md` — 29 routes table, _dispatch_view pipeline (11 steps), session handling, CSRF, auth flows, URL generation
  - `templates.md` — Jinja2 environment config, 3 filters + 27 globals, rendering flow, shared base context, 26 template catalog with full context contracts, authoring rules
  - `deployment.md` — prerequisites, dev/prod running, 11 environment variables, systemd unit template, primary/secondary model, nginx URI-based routing, signals, 6-step update procedure, session cookie notes
- Cross-check verification:
  - All 20 API endpoints verified (9 worker + 11 read-only + 2 OPTIONS for CORS)
  - All 29 UI routes verified against `_VIEW_ROUTES`
  - All 26 templates verified against `templates/` directory listing
  - All 5 middleware names and execution order verified
  - All 19 schemas verified
  - All 15 `http/` module files verified
  - All 27 Jinja2 globals and 3 filters verified
  - All 11 env vars verified across source locations
  - `WORKER_VERSION = 311` verified
  - `secrets.compare_digest()` CSRF validation verified
  - `iterate_in_threadpool` streaming pattern verified
  - `PRIMARY_ONLY_WORKER_API_PATHS` exclusion of `upload_pgn` verified
  - `build_template_context()` location in `http/boundary.py` verified
  - `_dispatch_view()` 11-step pipeline verified
  - 4 session keys verified
- Migration-era language audit: no instances of "pyramid", "mako", "legacy twin", "spec module", "parity", or "porting" found in any `docs/` file
- Full suite (`bash WIP/tools/run_local_tests.sh`): **91 tests run, 20 skipped, OK**

Phase 6 iteration 2 results (2026-02-16):

- Renamed all docs with numbered prefixes (matching `WIP/docs/` convention):
  - `README.md` → `0-README.md`
  - `architecture.md` → `1-architecture.md`
  - `threading-model.md` → `2-threading-model.md`
  - `api-reference.md` → `3-api-reference.md`
  - `ui-reference.md` → `4-ui-reference.md`
  - `templates.md` → `5-templates.md`
  - `deployment.md` → `6-deployment.md`
- Updated `0-README.md` index table with numbered filenames and 2 new document entries.
- Expanded `6-deployment.md` with full ready-to-copy configuration templates:
  - Complete systemd unit template (`fishtest_fastapi@.service`) — ready to copy to `/etc/systemd/system/`
  - Complete nginx configuration (~120 lines, 4 upstreams, map directive, HTTP→HTTPS, TLS, static/nn locations, proxy headers) — ready to copy to `/etc/nginx/sites-available/`
  - Complete update script (`fastapi_update_fishtest.sh`) — ready to run
- Created `7-worker.md` — worker architecture documentation:
  - Control flow (`worker()` → `fetch_and_handle_task()` → `run_games()` → `launch_fastchess()` → `parse_fastchess_output()`)
  - All 10 fishtest API endpoints used by worker (request_version, request_task, nn download, update_task, request_spsa, beat, failed_task, stop_run, upload_pgn, worker_log)
  - All 4 external GitHub API endpoints used
  - Configuration file format (3 sections, all options documented)
  - Self-update mechanism (updater.py flow)
  - Engine build pipeline, compiler detection, fastchess setup
  - Heartbeat thread (120s interval), signal handling (4 signals)
  - UUID generation, fleet mode, global cache, file management, exception hierarchy, logging
  - All constants documented (WORKER_VERSION, FASTCHESS_SHA, timeouts, compiler minimums)
- Created `8-references.md` — developer reference documentation:
  - FastAPI: 11 canonical URLs, router structure, dependency injection, lifespan, error shaping, testing patterns
  - Starlette: 9 canonical URLs, session middleware, pure ASGI middleware pattern, request form limits, URL generation, response classes, thread pool
  - Jinja2: 4 canonical URLs, environment setup, rendering flow, registered globals, autoescaping rules
  - 5 tooling references with paths
- Final doc count: 9 files in `docs/` (0-README through 8-references)

### Phase 7 — Write and verify the conventional commit message

Target: finalize the commit message and verify it is ready.

Checklist:
- [x] Verify the conventional commit message in [3-MILESTONES.md](3-MILESTONES.md) Task 7 is accurate and complete.
- [x] Confirm all file paths in the commit message match post-Phase-2 locations.
- [x] Confirm the breaking changes section is accurate.
- [x] Verify body lines are wrapped at 80 characters.
- [x] Record the commit message in this document for easy copy-paste during squash.

Phase 7 results (2026-02-20):

- Commit message updated to reflect current codebase state.
- Verified counts: 22 API routes, 29 UI routes, 15 http/ modules,
  26 templates, 5 middleware, 17 schemas, 161 tests, 10 docs.
- Removed migration-era language (no "replaces", "preserved",
  "converted from", "legacy" phrasing).
- All file paths verified against current file tree.
- All body lines verified ≤ 80 characters.

Conventional commit (ready for squash):

```
feat(server): replace Pyramid/Mako with FastAPI/Jinja2

Replace the Pyramid WSGI framework and Mako template engine with
FastAPI/Starlette (ASGI) and Jinja2. Deploy via Uvicorn instead
of Waitress.

Runtime stack:
- FastAPI + Starlette + Uvicorn (ASGI).
- Jinja2 templates (.html.j2, StrictUndefined).
- itsdangerous TimestampSigner cookie sessions.
- Pure ASGI middleware stack (5 layers: shutdown guard, request
  state, worker routing, blocked-user redirect, session).
- vtjson validation layer (17 schemas).

Server implementation:
- fishtest/api.py: 22 API routes (9 worker POST, 1 actions POST,
  10 read-only GET, 2 CORS OPTIONS).
- fishtest/views.py: 29 UI routes (data-driven _VIEW_ROUTES +
  centralized _dispatch_view pipeline).
- fishtest/http/: 15 support modules (session, CSRF, middleware,
  errors, dependencies, template helpers, boundary, settings).
- 26 Jinja2 templates with shared base context construction
  (build_template_context + template_helpers).
- Worker API: JSON responses with duration field, HTTP 200 for
  application errors, CORS for /api/actions and /api/get_run.
- UI pipeline: cookie sessions, CSRF enforcement, flash messages,
  per-route primary-instance guard, HTTP cache headers.

Build system:
- hatchling build backend for both server and worker.
- uv dependency management; single uv.lock at repo root.
- Pre-commit hooks: ruff lint + format, uv-lock check.
- CI workflows: lint, server tests (MongoDB), worker tests
  (POSIX + MSYS2).

Dependencies:
- Added: fastapi, uvicorn, itsdangerous, jinja2,
  python-multipart, hatchling, httpx (test).
- Removed: pyramid, pyramid-debugtoolbar, pyramid-mako, waitress,
  setuptools, mako.

Documentation:
- 10 docs in docs/ (architecture, threading model, API reference,
  UI reference, templates, worker, development guide, deployment
  with systemd + nginx configs, references).

Test suite:
- 161 tests (unittest discover) covering worker API, UI flows,
  HTTP boundary, middleware, session semantics, domain layer.
- Test helpers consolidated in test_support.py.

Breaking changes:
- Deployment entrypoint: `uvicorn fishtest.app:app` (was
  `pserve development.ini`).
- Session cookies invalidated on first deploy (itsdangerous
  TimestampSigner format); users re-authenticate once.
- Python >= 3.14 required (server); >= 3.8 (worker).
```

### Phase 8 — OPTIONAL: delete `WIP/` folder (PR branch only)

> [!IMPORTANT]
> This phase is executed **only in the branch that will open the upstream PR**, not in the development branch.

Checklist:
- [ ] Migrate useful tools from `WIP/tools/` to permanent locations:
  - `run_local_tests.sh` → `server/scripts/` or `Makefile` target.
  - `lint_http.sh` → `server/scripts/` or `Makefile` target.
  - Any other tools that remain useful for ongoing development.
- [ ] Update any code/doc references to `WIP/` paths.
- [ ] Delete `WIP/` directory.
- [ ] Verify no remaining references: `grep -rn 'WIP/' server/ --include='*.py' --include='*.md' --include='*.sh' | grep -v __pycache__`.
- [ ] Run full test suite one final time.
- [ ] Commit.

---

## Verification gates (per phase)

From `server/`:
- `uv run python -m unittest discover -s tests -q`
- Or: `bash WIP/tools/run_local_tests.sh` (full suite with timeout)

Lint:
- `bash WIP/tools/lint_http.sh`

Import cleanliness (post-Phase 2):
- `grep -rn 'from pyramid\|import pyramid' server/fishtest/ --include='*.py' | grep -v __pycache__` → must be empty
- `grep -rn 'from mako\|import mako' server/fishtest/ --include='*.py' | grep -v __pycache__` → must be empty

## "Stop the line" conditions

- Any FastAPI contract test fails after a deletion/move.
- A runtime import from `pyramid.*` or `mako.*` survives in `server/fishtest/`.
- `uvicorn fishtest.app:app` fails to import after the route module move.
- Documentation still references Pyramid as the "behavioral spec" or "source of truth" after Phase 4.

---

## Success metrics

| Metric | Current (M12) | Target (M N) |
|--------|---------------|--------------|
| Legacy Pyramid spec modules | 3 (`api.py`, `views.py`, `models.py`) | 0 |
| Pyramid test stubs (`tests/pyramid/`) | 6 files | 0 |
| Legacy Pyramid tests | 5 files | 0 |
| Mako templates | ~26 files in `templates/` | 0 |
| `mako` in `pyproject.toml` | test dependency | absent |
| `pyramid` imports in `server/fishtest/` | 3 files (spec modules) | 0 |
| Route module location | `http/api.py`, `http/views.py` | `api.py`, `views.py` (top level) |
| Authoritative docs describe | migration process | final state |
| Permanent project docs (`docs/`) | 0 files | 9 files (0-README + 6 server docs + worker + references) |
| Conventional commit | not written | ready for squash |
| Contract tests | all pass | all pass |
| `WIP/` folder | present | present (dev) / deleted (PR branch, optional) |

---

## Appendix A — Documentation layouts for Phase 6

> These outlines define the structure and content of each document to be created
> in `server/fishtest/docs/` during Phase 6. They serve as blueprints — the
> actual documents should be written against the live codebase.

**Key principles for the new docs:**
- Describe what exists now, not what changed from Pyramid.
- No migration language ("port", "parity", "legacy twin", "spec module").
- Authoritative and self-contained — a new contributor reads these, not the WIP folder.
- Accurate file paths, module names, function names — verified against the codebase.
- Each doc has a clear audience and purpose statement.

**Source material** (WIP docs to refactor into permanent docs):
- `WIP/docs/2-ARCHITECTURE.md` — runtime architecture, module map, request flows
- `WIP/docs/2.1-ASYNC-INVENTORY.md` — async/blocking boundary inventory
- `WIP/docs/2.3-JINJA2.md` — Jinja2 runtime snapshot
- `WIP/docs/6-FASTAPI-REFERENCES.md` — FastAPI patterns used in this project
- `WIP/docs/7-STARLETTE-REFERENCES.md` — Starlette patterns used in this project
- `WIP/docs/9-JINJA2-REFERENCES.md` — Jinja2 references for this project
- `WIP/docs/11.1-JINJA2-CONTEXT-CONTRACTS.md` — template context contracts
- `WIP/docs/4-VPS.md` — deployment configuration (systemd + nginx)
- `WIP/docs/1-FASTAPI-REFACTOR.md` — protocol contracts (Protocol A + B)

---

### Doc 1: `README.md` — Documentation index

**Purpose:** Entry point for all server documentation. Tells a new contributor
what each doc covers and in what order to read them.

**Outline:**

```
# Fishtest Server Documentation

## Overview
One-paragraph description: fishtest is a distributed chess engine
testing system; the server assigns testing tasks to workers, collects
results, and computes statistics.

## Docs in this folder

| Document | Audience | Description |
|---|---|---|
| architecture.md | All contributors | Server structure, modules, request flow |
| threading-model.md | Backend contributors | Async/sync boundaries, threadpool usage |
| api-reference.md | Worker/integration devs | Worker API endpoints and protocol |
| ui-reference.md | UI contributors | UI routes, view dispatch, session/CSRF |
| templates.md | UI contributors | Jinja2 environment, template catalog, context contracts |
| deployment.md | Operators | systemd, nginx, environment variables |

## Quick start (for contributors)
- Clone, install: `cd server && uv sync`
- Run tests: `uv run python -m unittest discover -s tests -q`
- Start dev server: `uvicorn fishtest.app:app --reload`
- The entrypoint is `server/fishtest/app.py`.
```

---

### Doc 2: `architecture.md` — Server architecture

**Purpose:** Give any contributor a complete mental model of the server: what the
major components are, how they connect, and where to find them in the source tree.

**Source material:** `2-ARCHITECTURE.md` §1–§5 (big picture, repo structure,
runtime architecture, primary instance, core domain), `1-FASTAPI-REFACTOR.md`
(cutover architecture, signals/shutdown).

**Outline:**

```
# Server Architecture

## What fishtest does
- Distributed chess engine testing: server assigns tasks, workers run
  games, server computes statistics and publishes results.
- Single MongoDB instance is the system of record.

## Server package layout
server/fishtest/
├── app.py              — ASGI application factory, lifespan, middleware
│                         installation, router registration
├── api.py              — Worker API router (20 endpoints)
├── views.py            — UI router (29 endpoints, data-driven dispatch)
├── rundb.py            — RunDb: run lifecycle, task distribution, caching
├── userdb.py           — UserDb: authentication, groups, registration
├── actiondb.py         — ActionDb: audit log
├── workerdb.py         — WorkerDb: worker blocking
├── kvstore.py          — KVStore: key-value metadata (legacy usernames,
│                         flags)
├── scheduler.py        — Periodic task scheduler (primary only)
├── schemas.py          — vtjson validation schemas (19 schemas)
├── run_cache.py        — In-memory run cache with dirty-page flush
├── lru_cache.py        — Generic LRU cache
├── spsa_handler.py     — SPSA tuning parameter handler
├── github_api.py       — GitHub integration (commit metadata)
├── util.py             — Shared utilities
├── http/               — HTTP support modules (see below)
├── templates/   — Jinja2 templates (26 templates, .html.j2)
├── static/             — Static assets (JS, CSS, images)
└── stats/              — Statistical computation modules

server/fishtest/http/
├── boundary.py         — API request adapter (ApiRequestShim)
├── cookie_session.py   — Session secret key, cookie configuration
├── csrf.py             — CSRF token generation and validation
├── dependencies.py     — FastAPI dependency functions
├── errors.py           — Centralized error handler installation
├── jinja.py            — Jinja2 environment and template instance
├── middleware.py        — Pure ASGI middleware (shutdown guard, request
│                         state, worker routing, blocked-user redirect)
├── session_middleware.py — FishtestSessionMiddleware (itsdangerous)
├── settings.py         — AppSettings (environment variable parsing)
├── template_helpers.py — Jinja2 filters and globals
├── template_renderer.py — Template rendering helper
├── ui_context.py       — UI base context builder (build_template_context)
├── ui_errors.py        — HTML error page rendering
└── ui_pipeline.py      — UI view dispatch pipeline (_dispatch_view)

## Application startup (lifespan)
- `create_app()` in `app.py` builds the FastAPI instance.
- Lifespan context manager:
  1. Reads `AppSettings` from environment variables.
  2. Enforces single Uvicorn worker on primary instance.
  3. Creates `RunDb` (connects to MongoDB, initializes adapters).
  4. Stores `rundb`, `userdb`, `actiondb`, `workerdb` on `app.state`.
  5. On primary: initializes GitHub API, updates aggregated data,
     starts the periodic scheduler.
  6. On shutdown: sets `_shutdown` flag, stops scheduler, flushes
     run cache, saves persistent data, logs system event, closes
     MongoDB connection.

## Middleware stack (execution order)
Middleware runs in reverse installation order (outermost first):

1. FishtestSessionMiddleware — reads/writes signed session cookie
2. RedirectBlockedUiUsersMiddleware — 302 blocked users to /workers
3. RejectNonPrimaryWorkerApiMiddleware — 503 worker API on secondaries
4. AttachRequestStateMiddleware — copies app.state → request.state
5. ShutdownGuardMiddleware — 503 all requests during shutdown

All middleware is pure ASGI (no BaseHTTPMiddleware).

## Request flow
- Client → nginx → Uvicorn → ASGI middleware stack → FastAPI router
- Worker API: `api_router` handles `/api/*` endpoints
- UI: `views_router` handles all HTML-rendering endpoints
- Static: `StaticFiles` mount serves `/static/*`

## Primary instance concept
- Multiple Uvicorn instances run behind nginx (ports 8000–8003).
- Exactly one instance is designated "primary" via FISHTEST_PRIMARY_PORT.
- Primary owns: scheduler, aggregated data updates, GitHub integration,
  run cache flush, persistent data save.
- nginx routes worker API traffic to primary; UI traffic is distributed.

## Signals and shutdown
- SIGINT/SIGTERM: Uvicorn initiates shutdown; lifespan cleanup runs.
- ShutdownGuardMiddleware rejects new requests with 503 during drain.
- SIGUSR1: dumps all thread stacks (via faulthandler).

## Core domain adapters (not HTTP)
- RunDb: manages test runs, task assignment, result aggregation.
  Single instance per process, stored on app.state.
- UserDb: user CRUD, password hashing, group membership.
- ActionDb: audit trail for user/system actions.
- WorkerDb: worker ban list.
- KVStore: lightweight key-value pairs in MongoDB.
- Scheduler: periodic tasks (cleanup, ELO recalc) on primary only.

## Validation
- vtjson is the sole validation layer (19 schemas in schemas.py).
- Validates plain Python dicts; no Pydantic models.
- Used in domain adapters (rundb, userdb, actiondb) and API endpoints.
```

---

### Doc 3: `threading-model.md` — Threading and async model

**Purpose:** Explain what runs on the event loop vs the threadpool, and why.
Essential reading for anyone adding new endpoints or middleware.

**Source material:** `2.1-ASYNC-INVENTORY.md` (complete inventory),
`2-ARCHITECTURE.md` §3 (runtime architecture), `7-STARLETTE-REFERENCES.md`
(threadpool notes).

**Outline:**

```
# Threading Model

## Principle
The event loop is a thin HTTP dispatcher. All blocking work runs in
Starlette's default threadpool via `run_in_threadpool()`.

Blocking work includes:
- MongoDB queries (pymongo is synchronous)
- File I/O (template rendering, PGN uploads, neural net files)
- CPU-bound computation (ELO calculations, SPSA)
- Network calls (GitHub API via `requests`)

## What runs where

### Event loop [LOOP]
- All ASGI middleware __call__ methods
- FastAPI route dispatch (before entering handler body)
- Lifespan startup/shutdown orchestration
- CSRF token generation (hmac.new — CPU, microseconds)

### Threadpool [THREAD]
- All API endpoint handler bodies (sync functions → auto-offloaded)
- All UI endpoint handler bodies (via _dispatch_view → run_in_threadpool)
- RunDb construction and shutdown
- Scheduler start/stop
- GitHub API initialization
- Template rendering (Jinja2 Environment.get_template + render)
- Aggregated data updates

### Streaming [STREAM/THREAD]
- PGN file downloads: async generator yields chunks; each chunk read
  in threadpool

## Component inventory

### Lifespan (app.py)
- create_app/lifespan          [LOOP] — orchestrates startup/shutdown
- RunDb(...)                   [THREAD] — MongoDB connect
- gh.init(...)                 [THREAD] — GitHub API setup
- rundb.schedule_tasks()       [THREAD] — starts scheduler
- _shutdown_rundb(...)         [LOOP] — coordinates threadpool shutdown calls

### Middleware (http/middleware.py)
- ShutdownGuardMiddleware      [LOOP] — checks flag, calls app
- AttachRequestStateMiddleware [LOOP] — copies state, calls app
- RejectNonPrimaryWorkerApi... [LOOP] — checks flag, returns 503 or calls app
- RedirectBlockedUiUsers...    [LOOP] — reads session, returns 302 or calls app

### Session middleware (http/session_middleware.py)
- FishtestSessionMiddleware    [LOOP] — signs/unsigns cookie

### API router (api.py)
- All 20 endpoint handlers     [THREAD] — sync functions, auto-offloaded
- File streaming (upload_pgn)  [STREAM/THREAD]

### UI router (views.py)
- _dispatch_view()             [LOOP] → run_in_threadpool(handler_body)
- All 29 view handler bodies   [THREAD] — via _dispatch_view
- Template rendering           [THREAD] — inside handler body

### Error handlers (http/errors.py)
- http_exception_handler       [LOOP] — routes to JSON or HTML
- render_notfound_response     [THREAD] — template rendering
- render_forbidden_response    [THREAD] — template rendering

## Rules for adding new code
1. New endpoints: write as sync functions. FastAPI auto-offloads them.
2. New middleware: write as pure ASGI (never use BaseHTTPMiddleware).
3. If you must call blocking code from async context: wrap in
   `await run_in_threadpool(fn, *args)`.
4. Never do MongoDB queries, file I/O, or `requests.get()` directly
   in an async function body.
```

---

### Doc 4: `api-reference.md` — Worker API reference

**Purpose:** Document the worker API protocol so that worker developers and
integration testers know exactly what each endpoint expects and returns.

**Source material:** `2-ARCHITECTURE.md` §6 (API surface, routing matrix),
`1-FASTAPI-REFACTOR.md` Protocol A, `6-FASTAPI-REFERENCES.md` (dependency
injection patterns).

**Outline:**

```
# Worker API Reference

## Protocol invariants
- Every response is a JSON object containing a `duration` field (float,
  seconds elapsed server-side).
- Application errors return HTTP 200 with `{"error": "...", "duration": N}`.
- Transport/validation errors return non-200 with JSON error payloads.
- Content-Type is always `application/json`.

## Authentication
- Workers authenticate via `username` + `password` fields in every
  POST body.
- Invalid credentials → HTTP 200 + `{"error": "Invalid password ..."}`.

## Endpoints

### POST /api/request_version
Request: `{"username": str, "password": str}`
Response: `{"version": int, "duration": float}`
Purpose: returns the current worker protocol version.

### POST /api/request_task
Request: worker info dict (username, password, worker_info with
  concurrency, system specs, etc.)
Response on success: `{"run": {...}, "task_id": int, "duration": float}`
Response on no work: `{"task_waiting": false, "duration": float}`
Purpose: requests a testing task assignment.

### POST /api/update_task
Request: `{"username", "password", "run_id", "task_id", "stats", ...}`
Response: `{"duration": float}` on success
Purpose: reports partial or final results for a task.

### POST /api/beat
Request: `{"username", "password", "run_id", "task_id"}`
Response: `{"duration": float}`
Purpose: heartbeat — keeps the task lease alive.

### POST /api/request_spsa
Request: `{"username", "password", "run_id", "task_id"}`
Response: `{"w_params": [...], "b_params": [...], "duration": float}`
Purpose: requests SPSA tuning parameters for the current iteration.

### POST /api/failed_task
Request: `{"username", "password", "run_id", "task_id"}`
Response: `{"duration": float}`
Purpose: marks a task as failed (worker-side crash or timeout).

### POST /api/stop_run
Request: `{"username", "password", "run_id", "task_id"}`
Response: `{"duration": float}`
Purpose: requests early stop of a run (SPRT bounds reached).

### POST /api/upload_pgn
Request: multipart form with `run_id`, `task_id`, `pgn` file
Response: `{"duration": float}`
Purpose: uploads PGN game records for a completed task.

### POST /api/worker_log
Request: `{"username", "password", "message"}`
Response: `{"duration": float}`
Purpose: logs a worker-side diagnostic message on the server.

## Read-only endpoints (no auth)
### GET /api/active_runs
### GET /api/finished_runs
### GET /api/actions
### GET /api/calc_elo
### GET /api/get_run/{run_id}
### GET /api/get_task/{run_id}/{task_id}
### GET /api/nn/{filename}
### GET /api/pgn/{pgn_id}
### GET /api/run_pgns/{run_id}

## Validation
- Request bodies are validated against vtjson schemas
  (e.g., `api_schema`, `update_schema`).
- Schema validation failures → HTTP 400 JSON error response.

## Error shape
All error responses follow this shape:
  {"error": "<path>: <message>", "duration": float}
The error message is prefixed with the endpoint path for client-side
disambiguation.

## Adding a new API endpoint
1. Add the route in `api.py` with `@router.post` or `@router.get`.
2. Write the handler as a sync function (auto-offloaded to threadpool).
3. Always return a dict containing `"duration"`.
4. For application errors, return HTTP 200 + `{"error": "..."}`.
5. Add a vtjson schema if the endpoint accepts structured input.
6. Add a contract test in `tests/test_api.py`.
```

---

### Doc 5: `ui-reference.md` — UI routes and view dispatch

**Purpose:** Explain how UI routes work, how the centralized dispatch pipeline
operates, and how session/CSRF/auth are handled. Essential for anyone adding
or modifying a UI page.

**Source material:** `2-ARCHITECTURE.md` §7 (UI surface), `7-STARLETTE-REFERENCES.md`
(session middleware, URL generation), `6-FASTAPI-REFERENCES.md` (dependencies,
router structure).

**Outline:**

```
# UI Routes and View Dispatch

## Overview
All UI routes are defined in `views.py`. The server uses a data-driven
registration model: `_VIEW_ROUTES` is a list of route descriptors,
and `_dispatch_view()` is the centralized dispatch function that handles
cross-cutting concerns for every UI request.

## Route registration
Routes are declared in `_VIEW_ROUTES` as tuples of:
  (http_method, path, handler_function, options_dict)

At module load time, `_make_endpoint()` wraps each handler with
`_dispatch_view()` and registers it on the FastAPI router.

## _dispatch_view() pipeline
For every UI request, `_dispatch_view()` handles (in order):
1. Session extraction from `request.session`
2. POST body parsing (form data)
3. CSRF token enforcement (POST requests)
4. _ViewContext construction (bundles request, session, rundb, userdb)
5. Primary-instance guard (some views are primary-only)
6. Threadpool dispatch of the handler body
7. Redirect handling (handler returns redirect → RedirectResponse)
8. Template rendering (handler returns template name + context)
9. Session commit (write-back to cookie)
10. HTTP cache headers
11. Response header propagation

## Session handling
- `FishtestSessionMiddleware` (pure ASGI) manages signed cookies.
- Session data is a plain dict at `request.session`.
- Keys used: `username`, `csrf_token`, `flash` (error/warning/info lists),
  `blocked` flag, `theme` preference.
- "Remember me": per-request `max_age` override via `scope["session_max_age"]`.

## CSRF protection
- Token generated per session (stored in `request.session["csrf_token"]`).
- Validated on every UI POST via `_dispatch_view()`.
- Token exposed to templates via base context and HTML meta tag.

## Authentication
- Login sets `request.session["username"]`.
- Logout clears the session dict.
- `ensure_logged_in()` checks session and returns 401 if unauthenticated.
- Group-based authorization: `userdb.has_permission(username, group)`.

## URL generation
- Templates use `url_for(route_name, **params)` (Starlette builtin).
- All routes have explicit `name=` for URL generation.
- `static_url(path)` maps to `/static/{path}` with cache-busting.

## Adding a new UI route
1. Write a sync handler function that receives `_ViewContext` and
   returns `(template_name, context_dict)` or a redirect.
2. Add an entry to `_VIEW_ROUTES` with method, path, handler, and
   options (e.g., `require_login`, `primary_only`).
3. Create the Jinja2 template in `templates/`.
4. Add a contract test in `tests/test_http_*.py`.
```

---

### Doc 6: `templates.md` — Jinja2 templates

**Purpose:** Document the Jinja2 environment configuration, the template
catalog, and the context contract for each template. Essential for anyone
editing templates or adding new pages.

**Source material:** `2.3-JINJA2.md` (rendering flow, environment, catalog),
`11.1-JINJA2-CONTEXT-CONTRACTS.md` (full context contracts per template),
`9-JINJA2-REFERENCES.md` (Jinja2 + Starlette templating).

**Outline:**

```
# Jinja2 Templates

## Environment configuration
- Templates directory: `server/fishtest/templates/`
- File extension: `.html.j2`
- Autoescape: enabled for HTML/XML/J2 files
- Undefined: `StrictUndefined` (missing variables raise errors)
- Single `Environment` instance created at import time in `http/jinja.py`
- Filters and globals registered via `http/template_helpers.py`

## Rendering flow
1. View handler returns `(template_name, context_dict)`.
2. `_dispatch_view()` calls template renderer.
3. `build_template_context()` in `http/ui_context.py` constructs the
   shared base context (urls, csrf_token, current_user, theme, flash).
4. Handler-specific context is merged with base context.
5. `Jinja2Templates.TemplateResponse(request, name, context)` renders
   the template and returns an HTML response.
6. Rendering is synchronous, executed in the threadpool.

## Shared base context (all pages)
Every template receives these keys from `build_template_context()`:
- `static_url(path)` — static asset URL helper
- `url_for(name, **params)` — named route URL helper
- `csrf_token` — CSRF token string
- `theme` — "dark", "light", or empty
- `current_user` — authenticated user object or null
- `pending_users_count` — int (user management badge)
- `flash` — dict with `error`, `warning`, `info` string lists
- `urls` — dict of route names to URL strings for navigation

## Template catalog

| Template | Purpose |
|----------|---------|
| base.html.j2 | Base layout (navbar, footer, asset loading) |
| actions.html.j2 | Paginated action log (admin) |
| contributors.html.j2 | Contributor leaderboard |
| elo_results.html.j2 | ELO result display (partial) |
| login.html.j2 | Login form |
| machines.html.j2 | Connected worker machines table |
| nn_upload.html.j2 | Neural network upload form |
| nns.html.j2 | Neural network listing with pagination |
| notfound.html.j2 | 404 error page |
| pagination.html.j2 | Reusable pagination partial |
| rate_limits.html.j2 | API rate limit info page |
| run_table.html.j2 | Single run table partial |
| run_tables.html.j2 | Run listing (pending/active/finished) |
| signup.html.j2 | User registration form |
| sprt_calc.html.j2 | SPRT calculator page |
| tasks.html.j2 | Task table partial for a run |
| tests.html.j2 | Main tests dashboard |
| tests_finished.html.j2 | Finished tests listing |
| tests_live_elo.html.j2 | Live ELO chart page |
| tests_run.html.j2 | New test / rerun form |
| tests_stats.html.j2 | Statistical analysis page |
| tests_user.html.j2 | Per-user test listing |
| tests_view.html.j2 | Single test detail page |
| user.html.j2 | User profile page |
| user_management.html.j2 | User admin page |
| workers.html.j2 | Worker blocking admin page |

## Context contracts (per template)
Each template has an explicit context contract documenting the required
keys, their types, and their purpose. Templates do not fetch data;
views provide fully shaped context.

[Full context contracts for each template — transcribe from
11.1-JINJA2-CONTEXT-CONTRACTS.md, removing migration-era language.
Each template section lists: required keys with types, optional keys,
and which shared base context keys it uses beyond the defaults.]

## Authoring rules
- Templates are declarative: data shaping stays in view handlers.
- JS data is passed via `|tojson` filter (never interpolated into JS).
- Prefer preformatted display strings (use `*_label` keys).
- Prefer explicit URLs (`*_url` keys) over building URLs in templates.
- Use macros for repeated patterns (pagination, run tables).
- The `request` object is not used directly in templates except via
  `url_for` and `static_url` helpers.

## Adding a new template
1. Create `templates/mypage.html.j2` extending `base.html.j2`.
2. Define the context contract (required keys + types) in this doc.
3. Build the context in the view handler using `build_template_context()`
   plus page-specific keys.
4. Return `("mypage.html.j2", context)` from the handler.
5. Add a test that verifies the template renders without errors.
```

---

### Doc 7: `deployment.md` — Deployment and operations

**Purpose:** Tell operators how to deploy, configure, and operate the fishtest
server. Covers systemd, nginx, environment variables, and the primary/secondary
instance model.

**Source material:** `4-VPS.md` (systemd unit, nginx config, update script),
`2-ARCHITECTURE.md` §4 (primary instance), `1-FASTAPI-REFACTOR.md`
(signals/shutdown).

**Outline:**

```
# Deployment

## Prerequisites
- Python >= 3.14
- MongoDB (mongod service)
- nginx (reverse proxy)
- uv (Python package manager)

## Installation
cd server && uv sync

## Running the server

### Development
uvicorn fishtest.app:app --reload --port 8000

### Production
Managed via systemd service template (one unit per port):
  systemctl start fishtest_fastapi@{8000..8003}

The service runs:
  uvicorn fishtest.app:app --host 127.0.0.1 --port $PORT \
    --proxy-headers --forwarded-allow-ips=127.0.0.1 \
    --limit-concurrency 10 --backlog 100 \
    --log-level warning --workers 1

## Environment variables

| Variable | Required | Description |
|----------|----------|-------------|
| FISHTEST_PORT | Yes | Port for this instance |
| FISHTEST_PRIMARY_PORT | Yes | Fixed primary port (usually 8000) |
| FISHTEST_URL | Yes | Public URL (https://...) |
| FISHTEST_NN_URL | Yes | Neural network download URL |
| FISHTEST_AUTHENTICATION_SECRET | Yes | Cookie signing secret |
| FISHTEST_CAPTCHA_SECRET | No | reCAPTCHA secret key |
| FISHTEST_INSECURE_DEV | No | Set to "1" for dev-mode (no secret) |
| UVICORN_WORKERS | No | Must be "1" on primary (enforced) |

## Primary / secondary instance model
- Port matching FISHTEST_PRIMARY_PORT is the primary instance.
- Primary runs scheduler, GitHub integration, aggregated data, cache
  flush.
- Secondary instances serve UI traffic only.
- nginx `map $uri $backends` routes worker API to primary,
  distributes UI and read-only API across all instances.

## nginx configuration
- Four upstream blocks (backend_8000 through backend_8003).
- URI-based routing via `map $uri $backends`.
- Static files served directly by nginx from /var/www/fishtest/static/.
- Neural network files served with gzip_static from /var/www/fishtest/nn/.
- TLS via Let's Encrypt.
- Proxy headers: X-Forwarded-For, X-Forwarded-Proto, X-Real-IP.
- Client max body size: 200 MB (PGN uploads).

## Signals
- SIGINT / SIGTERM: graceful shutdown (scheduler stop, cache flush,
  MongoDB close).
- SIGUSR1: dump all thread stacks to stderr (debugging).

## Update procedure
1. Enable nginx maintenance page.
2. Stop all fishtest instances.
3. Restart mongod.
4. Pull new code, run `uv sync`.
5. Start all instances.
6. Switch nginx back to fishtest config.

## Session cookie notes
- Signed with itsdangerous TimestampSigner.
- Cookie name: configurable (default: "session").
- SameSite: "lax".
- Deploying a new secret key invalidates all sessions (users must
  re-login).
```
