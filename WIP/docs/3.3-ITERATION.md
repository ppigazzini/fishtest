# Iteration record (Milestone 3 — make async/blocking boundaries explicit) — completed

Date: 2026-01-23

Milestone definition: [3-MILESTONES.md](3-MILESTONES.md)
> [!NOTE]
> **Async/blocking boundaries** (event loop vs threadpool) are canonically documented in [2.1-ASYNC-INVENTORY.md](2.1-ASYNC-INVENTORY.md).
Goal (Milestone 3): ensure the concurrency model is intentional and observable.

Status: **completed** (see “Milestone 3 — reached” in [3-MILESTONES.md](3-MILESTONES.md)).

General iteration rules: [3.0-ITERATION-RULES.md](3.0-ITERATION-RULES.md)

## Phases (all completed)

### Phase 1 — Document the boundaries

- [x] Async/threadpool boundaries are inventoried in [2.1-ASYNC-INVENTORY.md](2.1-ASYNC-INVENTORY.md).

### Phase 2 — Ensure blocking work is off the event loop

- [x] Lifespan startup/shutdown work is offloaded via `run_in_threadpool` in [server/fishtest/app.py](../../server/fishtest/app.py).
- [x] Middleware blocking operations are offloaded (e.g., blocked-user DB lookup) in [server/fishtest/glue/middleware.py](../../server/fishtest/glue/middleware.py).
- [x] API handler bodies run in a threadpool in [server/fishtest/glue/api.py](../../server/fishtest/glue/api.py).
- [x] Streaming file-like reads are performed via `iterate_in_threadpool` in [server/fishtest/glue/api.py](../../server/fishtest/glue/api.py).
- [x] UI view bodies + template rendering run in a threadpool in [server/fishtest/glue/views.py](../../server/fishtest/glue/views.py).

### Phase 3 — Codify runtime invariants

- [x] Primary instance enforces single-worker mode in [server/fishtest/app.py](../../server/fishtest/app.py).
- [x] Shutdown guard rejects new requests once shutdown begins in [server/fishtest/glue/middleware.py](../../server/fishtest/glue/middleware.py).

## Outcome

- The serving event loop remains a thin wrapper; legacy sync logic stays sync and is executed safely.
