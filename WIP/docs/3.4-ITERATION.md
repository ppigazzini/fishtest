# Iteration plan (Milestone 4 — explicit + maintainable FastAPI/Starlette glue, parity-safe)

Date: 2026-01-23

This doc is the Milestone 4 work plan: make the FastAPI/Starlette glue more explicit and maintainable
while preserving **worker protocol** and **UI protocol** parity.

> [!NOTE]
> **Canonical sources:**
> - Protocol contracts: [1-FASTAPI-REFACTOR.md](1-FASTAPI-REFACTOR.md)
> - Iteration rules (hotspots, two-step landing): [3.0-ITERATION-RULES.md](3.0-ITERATION-RULES.md)
> - Async boundaries: [2.1-ASYNC-INVENTORY.md](2.1-ASYNC-INVENTORY.md)
> - Architecture snapshot: [2-ARCHITECTURE.md](2-ARCHITECTURE.md)
> - Rebase + parity tooling: [5-REBASE.md](5-REBASE.md)

Quick navigation: [0-INDEX.md](0-INDEX.md)

## North star (Milestone 4)

Reduce “because we haven’t refactored yet” glue, while keeping parity for behavior clients rely on.

Idiomatic means (practical, not aesthetic):

- Middleware stack is explicit, minimal, and one-responsibility each.
- Shared behavior is centralized (errors, session commit, redirects).
- Dependencies are explicit and testable.
- Refactors are small, reversible, and gated by protocol tests.

Non-goals:

- No DB/scheduler redesign.
- No template engine migration (Milestone N-1).
- No Pydantic adoption in Milestone 4 (see Milestone 6).

## Milestone 4 work plan (phases / tasks)

Land each numbered item as its own PR/commit where feasible.

### Phase 1 — Contract-test gate hardening (make refactors safe)

Status: **completed** ✅

Evidence (protocol gates now exist in tests):

- Worker API contract gates: [server/tests/test_http_api.py](../../server/tests/test_http_api.py)
- Centralized error shaping regression: [server/tests/test_http_errors.py](../../server/tests/test_http_errors.py)
- UI session + CSRF semantics regression: [server/tests/test_http_ui_session_semantics.py](../../server/tests/test_http_ui_session_semantics.py)

1) Ensure worker protocol endpoints listed in [1-FASTAPI-REFACTOR.md](1-FASTAPI-REFACTOR.md) are covered by FastAPI HTTP tests that lock:
   - status behavior (200-with-error vs non-200)
   - required JSON keys including `duration`
   - worker-compatible error strings for invalid/transport failures

2) Add regression tests for centralized error shaping in `server/fishtest/glue/errors.py`:
   - UI 404 is HTML (not JSON)
   - API 404 is JSON
   - worker validation error becomes `{"error": "<path>: invalid request", "duration": ...}`

3) Add regression tests for UI session semantics:
   - session cookie is committed on UI error pages when the session is dirty
   - CSRF failure preserves UI behavior (403 as UI, not JSON)

Acceptance:

- A no-behavior-change refactor that breaks protocol contracts is caught by tests.

### Phase 2 — Consolidate duplicated UI pipeline code (shrink glue safely)

Status: **completed** ✅

4) Step 1 — Helpers-only commit: extract a small helper module for UI pipeline primitives (name is flexible):
   - build `TemplateRequest`
   - finalize response (commit vs clear session cookie)
   - apply Pyramid-era response shim headers
   - set `Cache-Control` from view config when missing
   - constraint: do not change route order, dispatcher structure, or handler order in `glue/views.py` in this step

5) Step 2 — Minimal call-site swap: update `server/fishtest/glue/views.py` to call those helpers with minimal edits:
   - keep route order and handler order
   - avoid formatting-only churn
   - keep variable names and control flow stable where possible

Parity guardrails (Phase 2):

- **Spec reference**: treat [server/fishtest/views.py](../../server/fishtest/views.py) as the behavioral spec; helpers must preserve observable behavior.
- **No behavior drift invariants** (examples of drift that breaks UI parity):
   - `request.route_url(...)` returns **absolute** URLs (and preserves query strings).
   - Redirects preserve status codes and `Location` semantics.
   - UI error pages remain **HTML** (avoid FastAPI JSON validation errors leaking to UI routes).
   - Session cookie semantics are preserved: commit vs clear cookie, remember/max-age, flashes.
   - Response header behavior is preserved (Pyramid-era response shim headers + `Cache-Control` defaults).
- **Gates required for Step 2** (call-site swap):
   - From `server/`: `uv run python -m unittest discover -s tests -q`
   - From repo root: `uv run python WIP/tools/parity_check_views_routes.py`
   - From repo root: `uv run python WIP/tools/parity_check_views_ast.py`
   - Optional churn visibility: `uv run python WIP/tools/parity_check_hotspots_similarity.py --show`
- **Stop-the-line rule**: if an invariant breaks, revert the swap commit and fix helpers first (keep the two-step landing strategy in [3.0-ITERATION-RULES.md](3.0-ITERATION-RULES.md)).

Acceptance:

- `glue/views.py` has less duplicated “session/template/headers” code and tests remain green.

### Phase 3 — Standardize state/dependency access patterns

Status: **completed** ✅

6) Prefer typed getters from `server/fishtest/glue/dependencies.py` (request-scoped) over ad-hoc `request.app.state` access inside routes/dispatch code.

7) Where helpful, add a typed “request context” helper (UI-only) that assembles:
   - user/session identity
   - DB handles
   - URL/base URL
   - TemplateRequest

Parity guardrails (Phase 3):

- **Scope constraint**: this phase is about *centralizing how we access state*, not changing what state is accessed.
- **No behavior drift invariants**:
   - UI routes must still render the same templates with the same context keys.
   - Session/CSRF behavior must not change (commit/clear semantics, token checks, flash messages).
   - Request shim surfaces stay stable (e.g., `request.params`, `request.matchdict`, `request.route_url`).
- **Gates** (at least):
   - From `server/`: `uv run python -m unittest discover -s tests -q`
   - When UI dispatch/shims are touched: `uv run python WIP/tools/parity_check_views_routes.py`
   - When UI glue bodies are touched: `uv run python WIP/tools/parity_check_views_ast.py`

Acceptance:

- DB/state access patterns are consistent and testable.

### Phase 4 — Keep error shaping declarative and centralized

Status: **completed** ✅

8) Keep all JSON-vs-HTML decisions centralized in `server/fishtest/glue/errors.py`.
   - Avoid introducing new ad-hoc error shaping in route wrappers.

9) Reduce drift risk for worker endpoints by ensuring the worker-path registry remains derived from the mounted router surface and is test-protected.

Parity guardrails (Phase 4):

- **Spec reference**:
   - Worker/API behavior spec: [server/fishtest/api.py](../../server/fishtest/api.py)
   - UI behavior spec: [server/fishtest/views.py](../../server/fishtest/views.py)
- **No behavior drift invariants**:
   - UI 404/403 remain HTML pages (no JSON errors leaking to UI routes).
   - Worker endpoints always return JSON dicts with `duration` (including error paths).
   - Error strings remain worker-compatible for validation/transport failures.
- **Gates** (targeted):
   - From `server/`: `uv run python -m unittest discover -s tests -q`
   - If touching error shaping: ensure [server/tests/test_http_errors.py](../../server/tests/test_http_errors.py) stays green.
   - If touching API glue bodies: `uv run python WIP/tools/parity_check_api_ast.py`

Acceptance:

- One place determines JSON-vs-HTML and worker error semantics.

### Phase 5 — Optional: request parsing cleanup (no Pydantic in Milestone 4)

Status: **completed** ✅

10) If there are repeated parsing footguns, extract them into dependencies/helpers using existing parsing + vtjson validation.
    - Do not refactor existing endpoints just to “modernize”.
    - Preserve output shape and existing error shaping (avoid leaking FastAPI default validation responses).

Phase 5 scope (concrete list):

- **DONE**: API `/api/finished_runs` parsing helpers (page + UNIX timestamp) while preserving error strings and JSON error shaping.
- **DONE**: UI page parsing helper (`page` → `page_idx`) for list-style pages (`/nns`, `/actions`, finished runs pagination) while preserving default-to-first-page behavior.
- **DONE**: Consolidate duplicated `show_task` parsing (used by run/task UI pages) into a helper and swap call sites.
- **DONE**: Consolidate duplicated “page 2+ shows only finished runs” gating used by `/tests` and `/tests_user`.
- **Explicit non-goal (parity)**: do **not** “tighten” UI `/actions` parsing for `before`/`max_actions` (Pyramid spec does `float(...)`/`int(...)` directly; changing error behavior risks UI contract drift).

Next task after Phase 5:

- If we are staying in Milestone 4: proceed to Phase 6 (operational hardening) only if we can define a stable, worker-safe error response for misrouted primary-only writes.
- If Milestone 4 is considered complete: switch to the Milestone 5 plan in [3.5-ITERATION.md](3.5-ITERATION.md).

Parity guardrails (Phase 5):

- **Scope constraint**: only reduce known duplication/footguns; no style-driven churn.
- **No behavior drift invariants**:
   - Preserve response shapes, status behavior, and error messages.
   - Preserve worker `duration` behavior and “200-with-error” semantics where historically used.
   - Avoid introducing new FastAPI validation error responses on worker/UI paths; route through existing error shaping.
- **Gates**:
   - From `server/`: `uv run python -m unittest discover -s tests -q`
   - If touching `/api/...` glue endpoints: `uv run python WIP/tools/parity_check_api_routes.py`
   - If touching API glue bodies: `uv run python WIP/tools/parity_check_api_ast.py`

Acceptance:

- Parsing duplication is reduced without protocol drift.

### Phase 6 — Optional: operational hardening (deliberate, gated)

Status: **completed** ✅

11) (Optional) Add an explicit guard for primary-only endpoints to return a predictable error on non-primary.
    - Must be documented.
    - Must be validated against worker/client expectations.

12) (Optional) Extend the primary-only guard beyond workers: identify UI mutation (POST) endpoints that should require a primary instance.
      - Goal: prevent secondary instances from performing mutations that rely on primary-only machinery (especially `RunDb.buffer` / run-cache side effects).
      - Policy for UI: **HTML 503 only** (no silent redirect).

      Deployment cross-check (Nginx routing already sends most mutations to primary):
      - See the current `map $uri $backends` in [4-VPS.md](4-VPS.md).
      - Primary-routed umbrella rule: `~^/(api|tests)/` → `backend_8000` (primary).
         - This means `/tests/<...>` and most `/api/<...>` traffic is already forced to the primary.
      - Explicit non-primary exceptions (must be safe to serve from a non-primary and require sticky routing):
         - `/tests` → `backend_8001`
         - `~^/tests/(finished|machines|user)` → `backend_8003`
         - `~^/api/(actions|active_runs|calc_elo)` → `backend_8003`
         - `~^/api/(nn|pgn|run_pgns)/` → `backend_8003`
         - `~^/api/upload_pgn` → `backend_8003`
         - `~^/(actions/|contributors)` → `backend_8003`
         - `default` → `backend_8001`

      Concrete UI functions to triage (and the reason to check them):
      - Run management mutations (already **primary-routed** by Nginx because they live under `/tests/...`, but still worth guarding defensively):
         - `tests_run` (`/tests/run`): calls `request.rundb.new_run(...)`.
         - `tests_modify` (`/tests/modify`): calls `request.rundb.set_active_run(run)`.
         - `tests_stop` (`/tests/stop`): calls `request.rundb.stop_run(...)`.
         - `tests_approve` (`/tests/approve`): calls `request.rundb.approve_run(...)` and updates nets (`request.rundb.update_nn(...)`).
         - `tests_purge` (`/tests/purge`): calls `request.rundb.purge_run(...)`.
         - `tests_delete` (`/tests/delete`): calls `request.rundb.set_inactive_run(run)` and `request.rundb.buffer(...)`.
         - UI mutation paths that are **NOT** primary-routed by the current Nginx map and therefore are the highest-risk candidates.
      - Also review other UI POST-style mutations for consistency (not necessarily primary-only): `workers` (block/unblock), `user` (profile edits / admin block/accept), `signup`, `logout`.

      Suggested clean implementation approach:
      - Add an explicit `require_primary=True` flag to `@view_config(...)` for the endpoints above.
      - Enforce it in one place in the UI dispatcher (`_dispatch_view` in `server/fishtest/glue/views.py`) by checking `shim.rundb.is_primary_instance()` before calling the handler.
      - If not primary: return an HTML `503` (and still commit the cookie session).
      - Keep the behavior deliberate and documented; avoid changing unrelated UI semantics (sessions, CSRF, redirects) beyond the new guard.

Parity guardrails (Phase 6):

- **Scope constraint**: operational hardening is only acceptable if it is deliberate, documented, and covered by tests.
- **No behavior drift invariants**:
   - Any new “non-primary” response must be stable (status + body shape) and must not break workers.
   - UI behavior (redirects, HTML errors, sessions) must remain unchanged.
- **Gates**:
   - From `server/`: `uv run python -m unittest discover -s tests -q`
   - Ensure worker contract tests remain green (see [server/tests/test_http_api.py](../../server/tests/test_http_api.py)).
   - If the change touches mounted route surfaces: run the route parity scripts (`parity_check_api_routes.py`, `parity_check_views_routes.py`).

Acceptance:

- Misrouting is detected and yields an intentional, stable error.

Milestone 4 completion record:

- Completed through Phase 6 (operational hardening).
- Evidence (implementation):
   - Worker misroute guard middleware: [server/fishtest/glue/middleware.py](../../server/fishtest/glue/middleware.py)
   - UI primary-only guard via `require_primary=True` enforced in UI dispatcher: [server/fishtest/glue/views.py](../../server/fishtest/glue/views.py)
- Next: proceed with Milestone 5 plan in [3.5-ITERATION.md](3.5-ITERATION.md).
