# Iteration rules (apply to every milestone)

Date: 2026-01-23

This document defines the **rules of engagement** for day-to-day work in this repo.
It is intentionally framework-agnostic: it applies to parity work, refactors, and ops hardening.

Quick navigation: [0-INDEX.md](0-INDEX.md)

Sources of truth:

- Authoritative migration plan + parity checklist: [1-FASTAPI-REFACTOR.md](1-FASTAPI-REFACTOR.md)
- Current architecture snapshot: [2-ARCHITECTURE.md](2-ARCHITECTURE.md)
- Rebase process + parity tooling: [5-REBASE.md](5-REBASE.md)

---

## Iteration scopes (pick exactly one per PR/commit)

- **Parity sync**: port an upstream behavior delta (spec → glue), preserving protocol.
- **Refactor (parity-safe)**: reduce duplication / centralize shared behavior without changing externally-visible behavior.
- **Ops hardening (parity-safe)**: make runtime constraints/guardrails more explicit.

Avoid mixing scopes unless strictly required.

---

## General rules

- **Protocol safety first.** Do not change externally-visible behavior unless explicitly intended and gated.
- **Keep diffs small.** Prefer “extract helper + keep call sites” over rewriting endpoints.
- **Protect the mechanical hotspots.** Avoid formatting-only churn and broad rewrites in:
  - [server/fishtest/glue/api.py](../../server/fishtest/glue/api.py)
  - [server/fishtest/glue/views.py](../../server/fishtest/glue/views.py)
- **Event loop stays thin.** Blocking work stays off the loop (threadpool) unless deliberately redesigned.
- **Centralize cross-cutting behavior.** Prefer shared helpers for: error shaping, session commit/clear, redirects, template request construction.

---

## Two-step landing strategy (keeps rebases cheap)

When refactoring anything that touches the hotspots:

1) **Helpers-only commit** (additive): introduce new helper(s) in supporting glue modules, no call-site churn.
2) **Minimal call-site swap commit** (surgical): replace one duplicated block at a time in the hotspot file.

If upstream conflicts occur on rebase, prefer re-applying the small call-site swap commit rather than rebasing a large mixed diff.

---

## Verification gates (minimum bar)

From `server/`:

- `uv run python -m unittest discover -s tests -q` (or a narrowed module)

If you changed helper modules (not hotspots):

- `uv run ruff check <changed_files...>`
- `uv run ty check <changed_files...>`

Parity scripts (repo root), when relevant:

- `uv run python WIP/tools/parity_check_api_routes.py`
- `uv run python WIP/tools/parity_check_views_routes.py`
- `uv run python WIP/tools/parity_check_api_ast.py` (when touching API glue bodies)
- `uv run python WIP/tools/parity_check_views_ast.py` (when touching UI glue bodies)
- Parity scripts compare the runtime Jinja2 output to the parity-only legacy Mako templates under `server/fishtest/templates`.
- Parity helper modules live entirely under `WIP/tools`, keeping runtime modules free of parity-only imports.

---

## “Stop the line” conditions

Pause and fix before proceeding if any of these occur:

- Worker response shape changes unintentionally.
- Worker `duration` is missing, wrong type, or disappears on error paths.
- UI errors start returning JSON (404/403/etc).
- Cookie session breaks login persistence, flashes, or CSRF.
- A change moves blocking work onto the event loop.

---

## Per-iteration recordkeeping (what to write down)

For each PR/commit, record:

- Scope (parity sync / refactor / ops)
- What got centralized/extracted/changed
- Which tests/scripts gate it
- Any intentionally preserved legacy quirks
