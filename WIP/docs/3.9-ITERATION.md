# Iteration plan (Milestone 9 — template rendering alignment: Starlette Jinja2 + Mako)

Date: 2026-02-05
Status: In progress (Phases 0-2 complete; sprint updates applied)

Note: The new Mako track was retired in Milestone 10. References to
`templates_mako` and `mako_new` in this closed iteration are historical.

## Goals
- Adopt Starlette `Jinja2Templates` best practices or reuse the class directly.
- Align Mako rendering behavior with the Starlette Jinja2 response semantics where practical.
- Document ASGI risks and decision points for Jinja2 and Mako rendering.

## Requirements
- Legacy templates remain in [server/fishtest/templates](server/fishtest/templates) for rebase safety.
- Legacy templates are read-only; make changes only in [server/fishtest/templates_mako](server/fishtest/templates_mako) and [server/fishtest/templates_jinja2](server/fishtest/templates_jinja2).
- Rendering stays off the event loop (threadpool boundary preserved).
- UI behavior and parity remain unchanged.
- Shared helper base remains authoritative for formatting and common logic.
- ASCII-only source where practical; use HTML entities when needed.

## References
- Starlette templates docs: [WIP/docs/7-STARLETTE-REFERENCES.md](WIP/docs/7-STARLETTE-REFERENCES.md)
- FastAPI templates docs: [WIP/docs/6-FASTAPI-REFERENCES.md](WIP/docs/6-FASTAPI-REFERENCES.md)
- Jinja2 docs: [WIP/docs/9-JINJA2-REFERENCES.md](WIP/docs/9-JINJA2-REFERENCES.md)
- Mako docs: [WIP/docs/10-MAKO-REFERENCES.md](WIP/docs/10-MAKO-REFERENCES.md)
- Renderers: [server/fishtest/http/jinja.py](server/fishtest/http/jinja.py), [server/fishtest/http/mako.py](server/fishtest/http/mako.py), [server/fishtest/http/mako_new.py](server/fishtest/http/mako_new.py)
- Renderer switch: [server/fishtest/http/template_renderer.py](server/fishtest/http/template_renderer.py)

## Phases

### Phase 0 — Inventory and gap analysis (complete)
- Reviewed Starlette `Jinja2Templates` behavior vs the custom renderer.
- Identified gaps for `TemplateResponse`, `url_for`, `context_processors`, and debug/test hooks.
- Recorded current Mako renderer behavior and its differences vs Starlette semantics.

### Phase 1 — Jinja2 alignment plan (complete)

Decision 1: adopt Starlette `Jinja2Templates` directly with a preconfigured `jinja2.Environment`.

Pros:
- Battle-tested behavior (`TemplateResponse`, `url_for`, request context) with predictable test/debug hooks.
- Fewer custom shims to maintain; aligns with upstream FastAPI/Starlette practices.
- Supports `context_processors` cleanly and keeps template context rules explicit.

Cons:
- Requires careful environment setup to preserve current globals and `MakoUndefined` behavior.
- Migration requires touching the renderer integration points and tests that expect string-only rendering.

Recommendation:
- Use `Jinja2Templates(env=custom_env)` and keep all helper globals/filters in that `Environment`.
- Provide a thin compatibility helper for legacy call sites that expect a rendered HTML string.

Definition of how `url_for` and request context are provided:
- Use `Jinja2Templates.TemplateResponse(request=..., name=..., context=...)` for UI responses.
- For non-response rendering (if needed), use `templates.get_template(...).render(...)` and inject `request` explicitly.

Filters/globals policy:
- Build the `Environment` once, configure globals/filters before any template load, and avoid mutations after first render.

### Phase 2 — Mako alignment plan (complete)

Decision 2: add a Mako `TemplateResponse`-style wrapper for tests/debug parity.

Pros:
- Parity with Jinja2 response semantics improves test visibility and debugging.
- Enables consistent request context handling across renderers.

Cons:
- Adds an extra response wrapper to maintain.
- Requires care to keep output identical and preserve current threadpool boundaries.

Recommendation:
- Introduce a small response wrapper that stores `template` and `context` and renders HTML once, mirroring Starlette's pattern.
- Keep the current string-rendering helper for non-response use cases.

Context processor alignment:
- If context processors are adopted for Jinja2, keep Mako parity by applying them in the same pipeline step before render.

Caching options and strict undefined:
- Document `module_directory` and `filesystem_checks` as production configuration choices.
- Keep `strict_undefined=False` in runtime; allow `strict_undefined=True` in tests only.

### Phase 3 — ASGI risks and options
- Document blocking risks and confirm threadpool rendering.
- Decide if async template rendering is out of scope (default: keep sync).
- Document escaping policies and trust boundaries for `|safe` / `|n`.

Analysis (Jinja2Templates + Mako TemplateResponse-style wrapper):

Starlette `Jinja2Templates` behavior that matters (confirmed against current usage):
- `Jinja2Templates` accepts `directory` or `env`, not both; we pass a custom `env` and preserve existing globals/filters.
- `TemplateResponse(request=..., name=..., context=...)` injects `request` into context and applies `context_processors`.
- `url_for` uses the request from context, so missing or wrong request objects break routing in templates.
- Response objects expose `template` and `context`, which is useful for tests/debug hooks.

ASGI risk analysis (sync rendering, threadpool boundaries):
- Risk: template rendering is synchronous; executing it on the event loop blocks all other requests.
	- Current mitigation: rendering stays in synchronous helpers and should be offloaded by the UI pipeline.
	- Option A (recommended): keep sync rendering, ensure all response builds happen in a threadpool.
	- Option B: switch to Jinja2 async rendering; this adds template complexity and does not remove blocking I/O inside helpers.
- Risk: template helper functions might touch disk or network (directly or indirectly).
	- Mitigation: keep helpers pure and ensure any I/O is in route handlers before rendering.
- Risk: `TemplateResponse` still renders synchronously and returns an ASGI response; do not call it directly on the event loop.
	- Mitigation: keep response construction behind the same threadpool boundary as string rendering.

ASGI risk analysis (response instrumentation):
- `TemplateResponse` pushes `template` and `context` into debug extensions; Mako wrapper mirrors this.
	- Pros: consistent test visibility and debugging across engines.
	- Cons: accidental retention of large context objects if tests keep references; keep context minimal.

Escaping and trust boundaries:
- Jinja2 autoescape is enabled for HTML/XML and should remain enabled for UI parity.
- Mako uses default filters and has explicit `|n` for no-escape; the parity contract must document where raw HTML is expected.
- Recommended practice: keep all unsafe HTML generation in a single helper per feature and audit it.

Pros and cons of adopting Starlette TemplateResponse semantics (Jinja2 + Mako wrapper):

Pros:
- Aligns with Starlette/FastAPI expectations (`request` in context, `url_for`, `context_processors`).
- Standard debug/test hooks (`template`, `context`) for both engines.
- Reduces custom rendering shims and keeps templating behavior predictable.
- Eases eventual migration to pure Jinja2 responses since call sites match upstream patterns.

Cons:
- Adds a response wrapper for Mako that must be kept in sync with Starlette behavior.
- Requires more structured context passing; missing request now fails loudly (good for correctness, but stricter).
- The response object does not remove sync rendering; threadpool discipline is still required.

Decision clarity for this iteration:
- Net assessment: pros outweigh cons as long as we keep rendering off the event loop and maintain strict context discipline.
- Adoption criterion: any UI endpoint returning HTML must either return a TemplateResponse-style object or render in a threadpool with the same context rules.
- Mako wrapper adoption is justified because it makes tests and debug output match Jinja2 behavior without changing HTML output.

### Phase 4 — Documentation and decision record
- Update architecture and reference docs with final decisions.
- Add a short decision log and next steps for any implementation changes.

Status: complete (2026-02-05)

Decision log (short):
- Adopt Starlette `Jinja2Templates` directly with a preconfigured `Environment`.
- Keep rendering synchronous and enforce threadpool usage for HTML responses.
- Add a Mako `TemplateResponse`-style wrapper to match Jinja2 response semantics.
- Preserve strict context rules (request must be present) to keep `url_for` behavior correct.

Task: parity script for Jinja2 vs new Mako
- Added [WIP/tools/compare_jinja_mako_parity.py](WIP/tools/compare_jinja_mako_parity.py).
- Run result (2026-02-05): normalized parity OK for 25 templates; raw output differs as expected.

Verification notes (feature parity assurance):
- Run the parity tool against Jinja2 and new Mako outputs on the same context data.
- Add a focused debug test that asserts both response objects expose `template` and `context`.
- Compare normalized HTML for a representative set of templates before any rollout.

Sprint update (2026-02-06):
- Added a response adapter so UI rendering attaches debug metadata (`template`, `context`) without changing HTML.
- UI dispatch and UI error rendering now use the response adapter while staying in the threadpool.
- Mako TemplateResponse debug metadata now checks `raw_request` for ASGI extensions.
- Jinja2 autoescape now applies to `.mak` templates to match the new Mako defaults.
- Added response-level parity script: [WIP/tools/compare_template_response_parity.py](WIP/tools/compare_template_response_parity.py).
- Parity runs: `compare_jinja_mako_parity.py` OK, `compare_template_response_parity.py` OK (normalized).

Sprint update (2026-02-06, continued):
- Lint/type checks: `ruff check --select ALL --fix` and `ty check` pass for `server/fishtest/http` excluding `api.py` and `views.py`.
- Added a typed debug response protocol for the response adapter so type checking understands `template`/`context` attributes.
- Parity runs: `compare_template_parity.py --context WIP/tools/template_parity_context.json` OK (normalized).
- Parity runs: `compare_jinja_mako_parity.py` OK (normalized response parity).

Metrics (latest runs):
- Templates checked: 25
- Normalized HTML parity: 25/25 OK
- Response parity fields: status/content-type/cache-control/set-cookie/template/context all OK across 25 templates

Sprint update (2026-02-06, coverage):
- Added template context coverage tool: [WIP/tools/template_context_coverage.py](WIP/tools/template_context_coverage.py).
- Run result (2026-02-06): missing context keys reported for multiple templates; exit status 1.
- Missing keys observed (non-exhaustive):
	- Mako-only gaps: actions.mak, contributors.mak, machines.mak, nns.mak, pagination.mak, run_table.mak, tasks.mak, tests_finished.mak, tests_run.mak, tests_stats.mak, tests_view.mak, user_management.mak, workers.mak.
	- Jinja gaps: actions.mak, elo_results.mak (show_gauge), nns.mak (pages), run_table.mak (cookie_name), run_tables.mak, tasks.mak, tests.mak, tests_run.mak (rescheduled_from), tests_stats.mak, tests_view.mak (spsa_data), user.mak (blocked).

Coverage details (full missing keys, 2026-02-06):
```
actions.mak:
	mako: [action, agent, agent_link, locals, n, u, user]
	jinja: [agent, agent_link, pages, short_agent, task_query, task_suffix]
contributors.mak:
	mako: [UTC, index, u, user]
	jinja: []
elo_results.mak:
	mako: [elo_ptnml_run, helpers, i, info, l, list_info, n, nelo_summary, results_info, show_gauge]
	jinja: [show_gauge]
login.mak:
	mako: []
	jinja: []
machines.mak:
	mako: [branch, compiler, formatted_time_ago, gcc_version, helpers, locals, machine, python_version, run_id, sort_value_time_ago, task_id, version, worker_name_]
	jinja: []
nn_upload.mak:
	mako: []
	jinja: []
nns.mak:
	mako: [locals, nn]
	jinja: [pages]
notfound.mak:
	mako: []
	jinja: []
pagination.mak:
	mako: [page]
	jinja: []
rate_limits.mak:
	mako: []
	jinja: []
run_table.mak:
	mako: [cookie_name, run]
	jinja: [cookie_name]
run_tables.mak:
	mako: []
	jinja: [paused_runs, pending_approval_runs, prefix]
signup.mak:
	mako: []
	jinja: []
sprt_calc.mak:
	mako: []
	jinja: []
tasks.mak:
	mako: [ARCH, active_style, compiler, d, gcc_version, helpers, p, python_version, stats, task, task_id, version, worker_arch]
	jinja: [ARCH, active_style, compiler, d, gcc_version, p, python_version, stats, task_id, total, version, worker_arch, worker_info, worker_username]
tests.mak:
	mako: [height, max_height, min_height]
	jinja: [height, max_height, min_height]
tests_finished.mak:
	mako: [title]
	jinja: []
tests_live_elo.mak:
	mako: []
	jinja: []
tests_run.mak:
	mako: [arch_filter, base_branch, book, comp, compiler, default_book, elo_model, fb, h, is_odds, json, latest_bench, n, pt_book, pt_branch, pt_signature, pt_version, rescheduled_from, test_book]
	jinja: [rescheduled_from]
tests_stats.mak:
	mako: [LLRjumps3, LLRjumps5, alpha, batch_size_games, beta, elo0, elo1, elo_model, games3, games5, has_pentanomial, has_sprt, has_spsa, pdf3_s, pdf5_s, results3, results5]
	jinja: [LLR3, LLR3_alt, LLR3_alt2, LLR3_be, LLR3_exact, LLR3_l, LLR3_normalized, LLR3_normalized_alt, LLR3_u, LLR5, LLR5_alt, LLR5_alt2, LLR5_exact, LLR5_l, LLR5_normalized, LLR5_normalized_alt, LLR5_u, LLRjumps3, LLRjumps5, LOS3, LOS5, N5, R3_, RMS_bias, RMS_bias_elo, a3, a5, alpha, avg5, avg5_l, avg5_u, batch_size_games, batch_size_units, belo0, belo1, beta, elo0, elo0_, elo1, elo1_, elo3, elo3_l, elo3_u, elo5, elo5_l, elo5_u, elo95_3, elo95_5, elo_model, elo_model_, exkurt5, games5, lelo0, lelo03, lelo1, lelo13, llrjumps3_raw, llrjumps3_vals, llrjumps5_raw, llrjumps5_vals, nelo0, nelo03, nelo1, nelo13, nelo5, nelo5_l, nelo5_u, nt5, nt5_l, nt5_u, o, o0, o1, pdf5, pdf5_s, pentanomial_draw_ratio, ratio, results5, results5_, results5_DD_prob, results5_WL_prob, score0, score03, score1, score13, skewness5, sp, sqrt2, stdev5_per_game, stdev5_per_game_l, stdev5_per_game_u, t5, t5_l, t5_u, t5_var, var5, var5_per_game, var5_per_game_l, var5_per_game_u, var_diff, var_t5]
tests_user.mak:
	mako: []
	jinja: []
tests_view.mak:
	mako: [arg, element, helpers, idx, json, n, note, row, spsa_data, warning]
	jinja: [spsa_data]
user.mak:
	mako: [blocked]
	jinja: [blocked]
user_management.mak:
	mako: [user]
	jinja: []
workers.mak:
	mako: [quote, w]
	jinja: []
```

Sprint update (2026-02-06, parity + lint + tooling):
- Added benchmark helper: [WIP/tools/templates_benchmark.py](WIP/tools/templates_benchmark.py).
- Lint/type checks (http only, excluding api.py/views.py):
	- `cd server && uv run ruff check --select ALL --fix` OK
	- `cd server && uv run ty check` OK
	- `cd server && uv run ruff format` OK (no changes)
- Parity runs (2026-02-06):
	- `compare_template_parity.py` OK (25 templates, normalized)
	- `compare_template_response_parity.py` OK (25 templates, normalized)
	- `compare_jinja_mako_parity.py` OK (25 templates, normalized)
	- `parity_check_api_routes.py` OK (normalized coverage; informational extras)
	- `parity_check_views_routes.py` OK
	- `parity_check_api_ast.py` OK (2 expected drifts)
	- `parity_check_views_ast.py` OK
	- `parity_check_hotspots_similarity.py`: UI similarity 0.9087, API similarity 0.7817
	- `parity_check_views_no_renderer.py`: 7 views without renderer (expected)

Sprint update (2026-02-06, parity rerun):
- Re-ran parity scripts after cleanup; all results unchanged and OK.

## Issues and possibilities (ASGI)
- Template rendering must remain off the event loop; any I/O inside templates is a bug.
- Jinja2 supports async rendering, but it adds overhead and is not needed if templates avoid I/O.
- Response objects should expose `template` and `context` for test visibility.
- Autoescape differences between Jinja2 and Mako must be explicit and documented.
- Environment globals should be stable after templates load to avoid runtime drift.

## Implementation notes (current branch)
- Jinja2 rendering now uses Starlette `Jinja2Templates` with a custom `Environment`.
- TemplateRequest now retains the raw FastAPI request and exposes `url_for`.
- New Mako renderer includes a TemplateResponse-style wrapper for tests/debug parity.

## Deliverables
- Decision on `Jinja2Templates` adoption (direct or wrapped).
- Mako response alignment plan (TemplateResponse-equivalent).
- ASGI risks/choices documented and referenced from architecture and references.
