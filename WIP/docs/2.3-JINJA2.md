# Jinja2 runtime (status quo)

Date: 2026-02-11

This document describes the current Jinja2 runtime in this repo. It is a status
quo snapshot, not a migration plan.

## Status (authoritative)

- Runtime HTML rendering uses Jinja2 only.
- Templates live in [server/fishtest/templates_jinja2](server/fishtest/templates_jinja2) and use the `.html.j2` extension.
- Legacy Mako templates in [server/fishtest/templates](server/fishtest/templates) are read-only and used only by parity tooling.
- Rendering runs off the event loop via threadpool boundaries.
- Responses use `TemplateResponse(request=..., name=..., context=...)` and expose `response.template` and `response.context` for tests.

## Runtime rendering flow

1. UI routes build an explicit context (`build_template_context` + per-view context).
2. Rendering is offloaded to a threadpool and uses `render_template_to_response`.
3. Starlette `TemplateResponse` renders the template and returns HTML.
4. Session cookies, headers, and cache controls are applied in the UI pipeline.

## Environment configuration

- Jinja2 is configured via a custom `Environment` in [server/fishtest/http/jinja.py](server/fishtest/http/jinja.py).
- Autoescape is enabled for `html`, `xml`, and `j2` extensions.
- `MakoUndefined` is used to preserve legacy `UNDEFINED` rendering semantics.
- Shared helpers from [server/fishtest/http/template_helpers.py](server/fishtest/http/template_helpers.py) are registered as filters/globals.
- `static_url` is registered as a Jinja2 global for cache-busted static asset URLs (uses `_static_file_token` with `@lru_cache`).
- `url_for` is injected by Starlette when using `Jinja2Templates`.

## Context model

- `request` (FastAPI `Request`) is always present for `url_for` and Starlette behavior.
- `static_url` is provided as a Jinja2 global (via `env.globals`) and also in the shared base context for consistency.
- The shared base context includes `csrf_token`, `current_user`, `theme`,
  `pending_users_count`, `flash`, and `urls`.
- Session data is available via `request.scope["session"]` (populated by `FishtestSessionMiddleware`);
  `CookieSession` wraps this dict with CSRF/flash helpers.
- No `template_request` object exists; templates access request data via `request.query_params`,
  `request.cookies`, and other native Starlette `Request` attributes.
- Per-template contracts are documented in
  [WIP/docs/11.1-JINJA2-CONTEXT-CONTRACTS.md](WIP/docs/11.1-JINJA2-CONTEXT-CONTRACTS.md).

## Authoring patterns used in this repo

- Templates are declarative; heavy logic lives in helpers or view builders.
- URLs are prebuilt (`*_url`) or generated via `url_for`.
- JS payloads are passed via `|tojson`, not string interpolation.
- `|safe` is used only for audited HTML.

## Parity tooling

- HTML parity: [WIP/tools/compare_template_parity.py](WIP/tools/compare_template_parity.py)
- Response parity: [WIP/tools/compare_template_response_parity.py](WIP/tools/compare_template_response_parity.py)
- Context coverage: [WIP/tools/template_context_coverage.py](WIP/tools/template_context_coverage.py)
- Metrics: [WIP/docs/11.3-TEMPLATES-METRICS.md](WIP/docs/11.3-TEMPLATES-METRICS.md)

## Template catalog (base + helpers, then lexicographic)

This section mirrors the Mako catalog structure but describes the Jinja2
templates under [server/fishtest/templates_jinja2](server/fishtest/templates_jinja2).

### base.html.j2

- Purpose: Global base layout, navbar, flash messages, and page body slot.
- Inputs: Shared base context (includes `static_url`).
- Notes: Provides `block title`, `block head`, and `block body`.

### elo_results.html.j2

- Purpose: Elo/LLR rendering block used by run tables and run detail.
- Inputs: `elo` context (see [WIP/docs/11.1-JINJA2-CONTEXT-CONTRACTS.md](WIP/docs/11.1-JINJA2-CONTEXT-CONTRACTS.md)).
- Notes: Outputs optional gauge and preformatted stats.

### pagination.html.j2

- Purpose: Pagination component used by list pages.
- Inputs: `pages` list of items with `idx`, `url`, and `state`.

### actions.html.j2

- Purpose: Actions log with filters and pagination.
- Inputs: `actions`, `filters`, `pages`, `usernames`, `is_approver`.

### contributors.html.j2

- Purpose: Contributors summary and table (monthly toggle supported).
- Inputs: `summary`, `users`, `is_monthly`, `is_approver`.

### login.html.j2

- Purpose: Login form.
- Inputs: Shared base context; CSRF handled via base context.

### machines.html.j2

- Purpose: Machines table fragment for the workers page.
- Inputs: `machines` rows with formatted labels/URLs.

### nn_upload.html.j2

- Purpose: NN upload form.
- Inputs: `upload_url`, `testing_guidelines_url`, `cc0_url`, `nn_stats_url`.

### nns.html.j2

- Purpose: NN list with filters and pagination.
- Inputs: `filters`, `pages`, `nns` rows.

### notfound.html.j2

- Purpose: 404 page.
- Inputs: Shared base context.

### rate_limits.html.j2

- Purpose: GitHub rate limit status page (client-side fetch).
- Inputs: Shared base context.

### run_table.html.j2

- Purpose: Run table component used across list pages.
- Inputs: `runs`, `pages`, `toggle`, `show_delete`, and per-run URLs/labels.

### run_tables.html.j2

- Purpose: Composite of multiple run tables (pending, active, finished).
- Inputs: `runs`, `failed_runs`, `finished_runs`, `finished_runs_pages`.

### signup.html.j2

- Purpose: Signup form + recaptcha include.
- Inputs: `csrf_token`, `recaptcha_site_key`.

### sprt_calc.html.j2

- Purpose: SPRT calculator page.
- Inputs: Shared base context.

### tasks.html.j2

- Purpose: Task rows for a run (fetched via UI).
- Inputs: `tasks` rows with formatted stats and links.

### tests.html.j2

- Purpose: Main tests overview and run tables.
- Inputs: `page_idx`, `runs`, `finished_runs`, and summary stats.

### tests_finished.html.j2

- Purpose: Finished tests list with filters.
- Inputs: `finished_runs`, `finished_runs_pages`, `title`.

### tests_live_elo.html.j2

- Purpose: Live Elo chart page.
- Inputs: `run`, `page_title`.

### tests_run.html.j2

- Purpose: Create new test form (large form page).
- Inputs: `args`, `master_info`, `pt_info`, `supported_arches`, `supported_compilers`, `tests_repo`, `is_rerun`, `rescheduled_from`.

### tests_stats.html.j2

- Purpose: Statistics page for a run.
- Inputs: `run`, `page_title`, `stats_context`.

### tests_user.html.j2

- Purpose: User-specific tests list.
- Inputs: `username`, `is_approver`, `runs`.

### tests_view.html.j2

- Purpose: Run detail page (largest UI surface).
- Inputs: `run`, `page_title`, `run_args`, `warnings`, `notes`, `tasks`, `approver`, `same_user`, `can_modify_run`.

### user.html.j2

- Purpose: User profile page.
- Inputs: `profile`, `user`, `limits`, `hours`, `format_date`, `extract_repo_from_link`.

### user_management.html.j2

- Purpose: User management dashboard.
- Inputs: `all_users`, `pending_users`, `blocked_users`, `idle_users`, `approvers_users`.

### workers.html.j2

- Purpose: Worker management page and blocked-worker list.
- Inputs: `show_admin`, `worker_name`, `last_updated`, `blocked_workers`, `blocked`, `message`, `show_email`.
