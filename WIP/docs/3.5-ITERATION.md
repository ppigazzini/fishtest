# Iteration plan (Milestone 5 — idiomatic plumbing, readable glue entrypoints)

Date: 2026-01-29

This doc is the Milestone 5 plan: adopt idiomatic FastAPI/Starlette **plumbing** while keeping
`http/api.py` and `http/views.py` as the primary, human‑readable entrypoints. The core requirement
is *linear readability* without the folder explosion seen in later milestones.

> [!NOTE]
> **Canonical sources:**
> - Protocol contracts: [1-FASTAPI-REFACTOR.md](1-FASTAPI-REFACTOR.md)
> - Current architecture snapshot: [2-ARCHITECTURE.md](2-ARCHITECTURE.md)
> - Iteration rules (hotspots, two-step landing): [3.0-ITERATION-RULES.md](3.0-ITERATION-RULES.md)
> - FastAPI references: [6-FASTAPI-REFERENCES.md](6-FASTAPI-REFERENCES.md)
> - Starlette references: [7-STARLETTE-REFERENCES.md](7-STARLETTE-REFERENCES.md)
> - Rebase + parity tooling: [5-REBASE.md](5-REBASE.md)

Quick navigation: [0-INDEX.md](0-INDEX.md)

## North star (Milestone 5)

- **Idiomatic plumbing**: dependencies + middleware + explicit threadpool boundaries per FastAPI/Starlette guidance.
- **Readable glue**: keep `http/api.py` and `http/views.py` as the primary story files.
- **No file‑spread**: avoid splitting routes into multi‑module router trees.
- **Protocol parity**: worker API + UI behavior contracts remain stable.

Milestone 5 is **not** a “split routes into modules” milestone. It is a **plumbing‑only** milestone with a human‑readable glue requirement.

Non-goals:

- No UI redesign.
- No “make everything async” rewrite.
- No template engine migration.

## Inputs from references (what we must honor)

From FastAPI references:

- Use `APIRouter` and `include_router` **only if** it improves clarity; do not split for style.
- Prefer dependency injection for request‑scoped data (auth, session, CSRF, db handles).
- Keep middleware minimal and order explicit.
- Keep UI errors HTML and API errors JSON; use explicit exception handlers.

From Starlette references:

- Keep middleware order explicit and justified.
- Use `request.form(...)` limits for uploads.
- Use `request.url_for(...)` / explicit route names for URL stability.
- Keep blocking work off the event loop (threadpool).

## Template + session/CSRF contract (from fastapi‑bloat reference)

Observed in fastapi‑bloat:

- Templates remain Mako; `base.mak` uses:
  - `request.session` for CSRF token and flash queues.
  - `request.static_url(...)` for static assets and cache‑busting.
  - `request.cookies` for theme selection.
  - `request.authenticated_userid` and `request.userdb` for UI context.
- CSRF logic uses header or form token and compares to session token.
- Session cookie plumbing uses signed cookies with migration support and commit flags on `request.state`.

Implication for this milestone:

- Keep a minimal template request surface (session, static_url, cookies, authenticated_userid, userdb, url helpers).
- Preserve CSRF and session semantics exactly; only relocate plumbing if it simplifies the glue flow.

## Fastapi‑bloat comparison: keep vs reject

**Useful to reuse (plumbing only):**

- `server/fishtest/web/session.py` (cookie signing, migration flags, explicit commit semantics).
- `server/fishtest/web/csrf.py` (single, explicit CSRF check with header + form token).
- `server/fishtest/web/rendering/templates.py` (template lookup + `static_url` with cache‑busting).

**Not useful for this milestone (avoid):**

- `server/fishtest/web/ui/routes_*` and `web/api/routes_*` (route split across many files).
- Router/deps proliferation (`web/ui/deps.py`, `web/api/deps.py`) when it hides flow.
- Multi‑module “big app” structure when it increases hop count.

## Decision: itsdangerous + Starlette session cookies?

We do **not** switch just for style. We switch **only** if it improves correctness or reduces risk.

**Keep current glue session/cookie** when:

- The existing cookie/session behavior already matches legacy and tests.
- Changing session storage would add risk without readability gains.

**Adopt the fastapi‑bloat session/csrf plumbing** when:

- We need the explicit commit/forget semantics and migration support (dual‑read / dual‑write).
- We need consistent cookie flags (secure/samesite/max‑age) centralized in middleware.

If we adopt it, we **must** keep the Mako template contract intact:

- `.mak` templates continue to use `request.session`, `request.static_url`, `request.cookies`, and `request.authenticated_userid`.
- We **do not** copy or rewrite templates unless a behavior change is explicitly approved.

## Option A vs Option B report (session/CSRF)

**Option A — keep glue helpers**

Pros:

- Human readability stays strong: glue handlers keep session/CSRF control flow explicit.
- Minimal parity risk: current behavior already matches legacy in [server/fishtest/http/cookie_session.py](server/fishtest/http/cookie_session.py) and [server/fishtest/http/csrf.py](server/fishtest/http/csrf.py).
- Smaller diff surface; lower chance of cookie flag regressions.

Cons:

- Less “idiomatic” than Starlette middleware‑based sessions.
- Session commit/forget is per‑handler, which requires discipline and review.

**Option B — adopt fastapi‑bloat session/CSRF plumbing**

Pros:

- More idiomatic Starlette: explicit session middleware, `request.state` commit flags, migration modes.
- Easier future Jinja2 swap: session plumbing is middleware‑level, less tied to templates.

Cons:

- Lower readability: commit/forget logic becomes implicit via middleware.
- Higher parity risk: dual‑read/dual‑write migration increases edge‑case complexity.
- Larger diff surface; harder to audit in glue flow.

**Final recommendation (Milestone 5): choose Option A.**

Reason: Milestone 5 prioritizes human‑readable glue entrypoints; Option A keeps session/CSRF behavior explicit in the route narrative and avoids new hidden control flow. Revisit Option B in a later milestone if/when Jinja2 migration becomes the primary goal.

## Human readability metrics (target values)

- Hop count ≤ 1 per endpoint (route → domain call).
- File hops ≤ 1 for UI/API entrypoints (stay in glue).
- Helper calls ≤ 2 per endpoint.
- Single‑pass readability: endpoint is understandable without opening other files.

## Constraints and guardrails

- Minimize churn in [server/fishtest/http/views.py](../../server/fishtest/http/views.py) and
  [server/fishtest/http/api.py](../../server/fishtest/http/api.py).
- Use the two‑step landing strategy from [3.0-ITERATION-RULES.md](3.0-ITERATION-RULES.md).

Stop‑the‑line invariants:

- Worker responses preserve JSON shape and `duration`.
- UI errors remain HTML (not JSON).
- Login persistence, flashes, and CSRF semantics do not drift.
- Blocking work does not move onto the event loop.

## Milestone 5 work plan (phases / tasks)

Land each numbered item as its own PR/commit where feasible.

### Phase 0 — Clarify goals + baseline

1) Add this explicit goal statement in PR description:
   - “Plumbing becomes idiomatic; glue remains the readable entrypoint.”
2) Capture baseline human metrics for glue files (hop count, helper count, file hops).
3) Record which fastapi‑bloat plumbing modules are allowed to copy.
4) Update WIP parity scripts to enforce glue‑first parity and detect unintended route/module splits.

Acceptance:

- Goals are unambiguous and measurable in the PR description.

#### Phase 0 results (current branch)

- Glue‑first baseline confirmed: route entrypoints live in `http/api.py` and `http/views.py` only.
- No `server/fishtest/web/` route modules present in the working tree.
- Allowed fastapi‑bloat plumbing modules for reuse:
  - `server/fishtest/web/session.py`
  - `server/fishtest/web/csrf.py`
  - `server/fishtest/web/rendering/templates.py`
- Template contract verified from `templates/base.mak`:
  - `request.session` (flashes + csrf token)
  - `request.static_url(...)`
  - `request.cookies` (theme)
  - `request.authenticated_userid`
  - `request.userdb`

### Phase 1 — Template + session/CSRF contract lock

4) Document the minimal template contract required by Mako templates.
5) Document CSRF/session behavior (token sources, cookie flags, commit timing).
6) Confirm that `request.static_url(...)` semantics match existing templates.

Acceptance:

- Reviewers can verify template/session/CSRF behavior without reading code.

#### Phase 1 results (current branch)

- Template/session/CSRF contract documented (see section above).
- Parity scripts after Phase 1:
  - UI routes parity: OK (29 route_names, 0 method/renderer mismatches).
  - UI AST parity: OK (0 changed function bodies).
  - API routes parity: OK (20 normalized endpoints; OPTIONS ignored; extras informational).
  - API AST parity: OK (0 changed bodies; 2 expected drift bodies for downloads).

### Phase 2 — Idiomatic plumbing **inside glue** (no route splitting)

Goal: adopt Starlette/FastAPI plumbing patterns **without** changing the glue narrative.

7) **Explicit dependency surfaces in glue**
  - Introduce minimal dependency helpers that return *plain data*, not request‑shims.
  - Dependency helpers must live in glue modules (no new `web/` split).
  - Examples to standardize (keep names explicit):
    - `get_request_context(request)` → `{"session": ..., "user": ..., "userdb": ..., "rundb": ...}`
    - `get_csrf_form_token(form)` → `str | None`
  - **Rule:** dependencies must not hide control flow (no redirects, no implicit response mutation).

8) **Request parsing is explicit and bounded**
  - Use Starlette `request.form(max_files=..., max_fields=..., max_part_size=...)` for upload routes.
  - Parse query and form parameters in the route body (avoid helper chains).
  - **Rule:** any default value must be visible in the handler (no hidden defaults).

9) **Threadpool boundaries are explicit**
  - All blocking DB, file, and template rendering work is wrapped in `run_in_threadpool`.
  - **Rule:** no blocking call inside async context without explicit threadpool wrap.

10) **Middleware order remains explicit**
   - Keep middleware registration order in [server/fishtest/app.py](../../server/fishtest/app.py).
   - **Rule:** no implicit middleware via “magical” decorators.

11) **Error shaping stays explicit**
   - UI: always HTML responses on error; API: always JSON responses on error.
   - **Rule:** no FastAPI default `422` leaks on worker endpoints.

Acceptance:

- Glue files remain the primary narrative, with no new router trees.
- No new module splits were introduced under `server/fishtest/web/`.
- Each modified handler still reads linearly in `http/api.py` / `http/views.py`.

#### Phase 2 results (current branch)

- Added explicit form limits in `http` UI dispatch (Starlette `request.form` bounds).
- Introduced `get_request_context()` in [server/fishtest/http/dependencies.py](server/fishtest/http/dependencies.py) to keep dependencies as plain data.
- Parity scripts after Phase 2: OK (UI routes, API routes, UI AST, API AST).

Human readability re‑score (Phase 2):

- Hop count: unchanged (≤ 1 for glue endpoints).
- File hops: unchanged (≤ 1; routes still in glue files).
- Helper calls: unchanged (no new helper chains introduced).

### Phase 3 — Session + CSRF option (choose and execute)

Goal: keep legacy cookie/session semantics while making plumbing explicit.

12) **Decision checkpoint (required before code changes)**
  - **Option A (default):** keep current glue session/cookie helpers.
  - **Option B:** adopt fastapi‑bloat `web/session.py` + `web/csrf.py` plumbing.
  - **Decision rule:** choose the smallest change that preserves parity and improves clarity.

13) **If Option A (keep glue helpers)**
  - Document exact cookie flags used today (secure, samesite, max‑age) in glue.
  - Ensure session commit/forget is explicit in each handler path.
  - Keep CSRF checks centralized (header + form token) and visible in handler flow.
  - Add a checklist item for UI routes: “CSRF checked + session commit/forget explicit.”

14) **If Option B (adopt bloat plumbing)**
  - Copy only these modules:
    - `server/fishtest/web/session.py`
    - `server/fishtest/web/csrf.py`
  - Wire them **inside glue** (no `web/ui` or `web/api` route splits).
  - Replace any legacy session cookie helper calls with `commit_session(...)` / `clear_session_cookie(...)` from the copied module.
  - Keep `request.session` and `request.authenticated_userid` available to templates (no changes to `.mak`).
  - **Rule:** do not change template rendering or template context shape.

Acceptance:

- Templates still receive the same session/CSRF surface; no UI behavior drift.
- Cookie behavior is identical (secure/samesite/max‑age), verified against legacy.

#### Phase 3 results (Option A)

- Option A selected and documented.
- Cookie flag semantics documented in [server/fishtest/http/cookie_session.py](server/fishtest/http/cookie_session.py).
- Session commit/forget remains explicit in the HTTP UI flow via `apply_session_cookie`.
- CI tests passed (regen).

### Phase 4 — Readability enforcement

12) Re‑score hop count / helper count after each plumbing change.
13) Reject any change that increases hop count or file hops.

Acceptance:

- Human metrics stay within target values.

#### Phase 4 results (current branch)

- Hop count: unchanged (≤ 1 for HTTP entrypoints).
- File hops: unchanged (≤ 1; routes still in HTTP files).
- Helper calls: unchanged (≤ 2 per endpoint).

### Phase 5 — Rename glue folder (this milestone)

Goal: rename the glue folder to a permanent, idiomatic name **now**. `api.py`/`views.py` will be moved to root after Milestone N.

Naming options:

| Option | Pros | Cons |
| --- | --- | --- |
| `server/fishtest/http/` | Idiomatic “HTTP layer” naming; aligns with FastAPI/Starlette mental model. | Can be confused with generic HTTP utilities. |
| `server/fishtest/web_core/` | Signals “web layer core” while avoiding route‑split connotations. | Slightly non‑standard name. |
| `server/fishtest/core/` | Short, familiar bucket for internal plumbing. | Too generic; risks mixing non‑web concerns. |
| `server/fishtest/framework/` | Explicit about framework boundary. | Vague; doesn’t communicate HTTP/UI/API focus. |
| `server/fishtest/legacy_web/` | Honest about legacy UI contract. | “Legacy” can imply deprecated even when active. |
| `server/fishtest/web/` | Matches common FastAPI layouts. | Conflicts with the old “bloat” layout and risks re‑splitting. |

Recommendation: **`http/`**

Reason: it is idiomatic for the request/response layer and keeps the glue boundary clear without invoking the old route‑split `web/` layout.

Tasks:

16) Rename `server/fishtest/glue/` → `server/fishtest/http/`.
17) Update all imports, tests, and parity scripts to use the new folder name.
18) Defer moving `api.py`/`views.py` to root until after Milestone N.

Acceptance:

- No broken imports; tests + parity scripts pass.
- Entry points remain in `http/api.py` and `http/views.py` for now.

#### Phase 5 results (current branch)

- Renamed `server/fishtest/glue/` → `server/fishtest/http/`.
- Updated imports in app, tests, and HTTP helpers.
- Updated parity scripts to target the HTTP layer.
- Parity scripts after Phase 5:
  - UI routes parity: OK (29 route_names, 0 method/renderer mismatches).
  - UI AST parity: OK (0 changed function bodies).
  - API routes parity: OK (20 normalized endpoints; OPTIONS ignored; extras informational).
  - API AST parity: OK (0 changed bodies; 2 expected drift bodies for downloads).

### Phase 6 — Verification gates

19) Run existing parity scripts when touching UI/API glue flows.
20) Run unit tests for UI actions and API routes touched by changes.

## Verification gates (minimum bar)

From `server/`:

- `uv run python -m unittest discover -s tests -q`

Parity scripts (repo root), when touching HTTP routes:

- `uv run python WIP/tools/parity_check_api_routes.py`
- `uv run python WIP/tools/parity_check_views_routes.py`
- `uv run python WIP/tools/parity_check_api_ast.py` (API glue bodies)
- `uv run python WIP/tools/parity_check_views_ast.py` (UI glue bodies)

## Final results

- CI tests: `uv run python -m unittest discover -s tests -q` (pass after the rename + parity updates).
- Human metrics: hop count ≤ 1, file hops ≤ 1, helper calls ≤ 2 (all targets preserved through the plumbing work).
- Parity script runbook: [WIP/tools/parity_check_views_routes.py](WIP/tools/parity_check_views_routes.py#L1) → OK (29 route_names, 0 method/renderer mismatches); [WIP/tools/parity_check_api_routes.py](WIP/tools/parity_check_api_routes.py#L1) → OK (20 normalized endpoints, OPTIONS ignored); [WIP/tools/parity_check_views_ast.py](WIP/tools/parity_check_views_ast.py#L1) → OK (0 changed function bodies); [WIP/tools/parity_check_api_ast.py](WIP/tools/parity_check_api_ast.py#L1) → OK (0 changed bodies, 2 expected drift bodies for downloads).

## Notes for reviewers

- “Idiomatic FastAPI” is a tool for correctness, not a reason to split files.
- Keep glue readable; avoid helper chains and hidden control flow.
- Any behavior change must be explicit and test‑gated.
