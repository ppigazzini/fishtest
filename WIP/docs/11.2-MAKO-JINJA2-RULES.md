# Mako to Jinja2 conversion rules (project standard)

Date: 2026-02-09

This document defines the authoritative rules for converting legacy Mako
templates to Jinja2 in this repo. It consolidates the practical guidance from
Jinja2 runtime docs and references so ownership is clear here.

## Scope

- Applies to all template conversions from legacy Mako to Jinja2.
- Runtime is Jinja2-only; legacy Mako templates remain read-only for parity.
- New template work and template updates are Jinja2-only (`templates_jinja2`).
- These rules describe the status quo; they are not a migration plan.

## Core rules (must follow)

1. **Preserve behavior.** Keep IDs, form field names, URLs, and text content
   stable unless a change is explicitly approved.
2. **No embedded Python in templates.** Move logic into helpers or view-built
   context.
3. **Keep rendering off the event loop.** Rendering remains synchronous and
   runs in a threadpool.
4. **Use `TemplateResponse` for UI.** Always render with
   `TemplateResponse(request=..., name=..., context=...)`.
5. **Keep context explicit.** All template inputs must be provided by the view
   layer or helpers; avoid implicit globals beyond the approved shared set.
6. **Use `|tojson` for JS payloads.** Do not build JS by string interpolation.
7. **Use `|safe` only for audited HTML.** Treat it as a trust boundary.

## Starlette/Jinja2 integration rules

- Use `Jinja2Templates(env=...)` with a custom `Environment` or
  `Jinja2Templates(directory=...)`, not both.
- Ensure `request` is in the template context so `url_for` works.
- Rely on Starlette-injected `url_for`; do not reintroduce a custom `url_for`.
- Keep a single, stable `Environment`; set globals and filters before any
  template loads.
- Autoescape is enabled for `html`, `xml`, and `j2` extensions.

## Context rules

- Use the shared base context from `build_template_context()`.
- Use the `static_url` global for cache-busted static assets.
- Per-template contracts must match
   [WIP/docs/11.1-JINJA2-CONTEXT-CONTRACTS.md](WIP/docs/11.1-JINJA2-CONTEXT-CONTRACTS.md).

## Syntax and structure rules

- Mako inheritance (`<%inherit>`) maps to Jinja2 `{% extends %}` + `{% block %}`.
- Mako defs (`<%def>`) map to Jinja2 macros.
- Mako `${...}` expressions map to `{{ ... }}`.
- Mako control lines (`% if`, `% for`) map to `{% if %}` and `{% for %}`.
- Prefer includes and macros over duplicated markup.

## Escaping rules

- Default to autoescape; use `|e` for explicit escapes when clarity helps.
- Use `|safe` only on trusted HTML produced by helpers.
- Avoid mixing HTML strings and raw user input.

## Runtime compatibility rules

- Keep Jinja2 globals and shared context stable (`static_url`, `request`, `urls`).
- Do not add new Mako renderers or new template directories.
- Legacy Mako templates remain the parity anchor; do not edit except for
   upstream rebase safety.

## Parity rules

- Use HTML parity and response parity scripts after any conversion work.
- Use context coverage to detect missing keys.
- Normalize HTML before diffing; whitespace-only diffs are acceptable.

## Recommended workflow

1. Shape view context to match the contract.
2. Convert template syntax with minimal markup churn.
3. Move remaining logic into helpers or view builders.
4. Run parity and context coverage checks.
5. Record any approved behavioral differences.

## Tooling

- HTML parity: [WIP/tools/compare_template_parity.py](WIP/tools/compare_template_parity.py)
- Response parity: [WIP/tools/compare_template_response_parity.py](WIP/tools/compare_template_response_parity.py)
- Context coverage: [WIP/tools/template_context_coverage.py](WIP/tools/template_context_coverage.py)
- Metrics: [WIP/docs/11.3-TEMPLATES-METRICS.md](WIP/docs/11.3-TEMPLATES-METRICS.md)
