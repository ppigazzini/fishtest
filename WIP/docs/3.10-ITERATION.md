# Iteration plan (Milestone 10 — Jinja2-only runtime, legacy Mako for parity)

Date: 2026-02-07
Status: Complete (2026-02-09)

## Goals
- Rewrite the Jinja2 template set in an idiomatic, modern style rooted in Starlette best practices.
- Run only Jinja2 templates at runtime using Starlette best practices.
- Keep legacy Mako templates in [server/fishtest/templates](server/fishtest/templates) read-only for parity scripts.
- Keep parity tooling comparing the runtime Jinja2 output against the legacy Mako set.
- Retire runtime Mako renderer modules and temporary parity wiring so Jinja2 is the sole production renderer.
- Retire the new Mako parity renderer wiring so only the default Jinja2 set remains active for production.
- Keep `http/api.py` and `http/views.py` changes minimal to preserve parity metrics vs the legacy twins.
- Centralize parity helper scripts in WIP/tools so runtime code stays lean and parity coverage lives outside the serving path.
- Rename the Jinja2 templates to `.html.j2` (done 2026-02-08).

## Requirements
- Legacy templates remain read-only and runnable for parity scripts.
- Rendering stays off the event loop (threadpool boundary preserved).
- `TemplateResponse(request=..., name=..., context=...)` remains the UI return path. (done 2026-02-08)
- The Jinja2 templates are not required to be line-for-line comparable with Mako.
- Parity scripts compare legacy Mako vs the default Jinja2 set.
- Avoid large refactors in `http/api.py` and `http/views.py`; only small context changes that preserve parity tracking are allowed.
- ASCII-only source where practical; use HTML entities when needed.
- Shared Jinja2 context is explicit (urls, csrf_token, current_user, theme, pending_users_count, flash) and does not rely on request-side helpers.
- Parity helper scripts run from `WIP/tools` against the read-only legacy Mako templates so rendering helpers never leak into the runtime bundle.
- The Jinja2 files in [server/fishtest/templates_jinja2](server/fishtest/templates_jinja2) use the `.html.j2` extension instead of the legacy `.mak` suffix (done 2026-02-08).

## References
- Roadmap: [WIP/docs/3-MILESTONES.md](WIP/docs/3-MILESTONES.md)
- Iteration rules: [WIP/docs/3.0-ITERATION-RULES.md](WIP/docs/3.0-ITERATION-RULES.md)
- Jinja2 plan: [WIP/docs/2.3-JINJA2.md](WIP/docs/2.3-JINJA2.md)
- Report: [WIP/docs/70-M10-REPORT-JINJA2](WIP/docs/70-M10-REPORT-JINJA2)
- Context contracts: [WIP/docs/11.1-JINJA2-CONTEXT-CONTRACTS.md](WIP/docs/11.1-JINJA2-CONTEXT-CONTRACTS.md)
- Starlette templates: [WIP/docs/7-STARLETTE-REFERENCES.md](WIP/docs/7-STARLETTE-REFERENCES.md)
- Jinja2 references: [WIP/docs/9-JINJA2-REFERENCES.md](WIP/docs/9-JINJA2-REFERENCES.md)
- Template metrics: [WIP/docs/11.3-TEMPLATES-METRICS.md](WIP/docs/11.3-TEMPLATES-METRICS.md)
- Renderers: [server/fishtest/http/jinja.py](server/fishtest/http/jinja.py), [server/fishtest/http/template_renderer.py](server/fishtest/http/template_renderer.py)
- Parity tools: [WIP/tools/compare_template_parity.py](WIP/tools/compare_template_parity.py), [WIP/tools/compare_template_response_parity.py](WIP/tools/compare_template_response_parity.py)

## Phases

### Phase 0 — Inventory and cutover map
Checklist:
- [x] List every template and its legacy Mako counterpart.
- [x] Identify templates that rely on request-side effects or helper globals.
- [x] Record templates with heavy logic or unsafe HTML insertion.
- [x] Validate the per-template context contract list in [WIP/docs/11.1-JINJA2-CONTEXT-CONTRACTS.md](WIP/docs/11.1-JINJA2-CONTEXT-CONTRACTS.md).

Inventory notes (2026-02-07):
- Legacy Mako and Jinja2 templates remain 1:1 by logical name; Jinja2 files now use `.html.j2` in `server/fishtest/templates_jinja2`.
- Pages that still pull request-side data need explicit context builders: actions.html.j2, contributors.html.j2, nn_upload.html.j2, nns.html.j2, run_table.html.j2, sprt_calc.html.j2, tests.html.j2, tests_finished.html.j2, tests_live_elo.html.j2, tests_run.html.j2, tests_view.html.j2, user.html.j2.
- Pages with heavy helper/global dependencies that should move into the view context: actions.html.j2, contributors.html.j2, elo_results.html.j2, machines.html.j2, run_table.html.j2, run_tables.html.j2, tasks.html.j2, tests_run.html.j2, tests_stats.html.j2, user.html.j2, user_management.html.j2, workers.html.j2.
- Heavy logic or unsafe HTML remains concentrated in a few templates: actions.html.j2 (manual URL building + |safe), contributors.html.j2 (counts aggregation), machines.html.j2 (formatting + derived fields), run_table.html.j2 (JS state + derived row data), tasks.html.j2 (stats math and derived fields), tests_run.html.j2 (large JS + setup), tests_stats.html.j2 (statistical math), tests_view.html.j2 (large JS + conditional blocks).

## Template rewrite progress

### Phase 1 — Retire dual-renderer runtime wiring
Checklist:
- [x] Add view-level context builders for templates that still consume request/global dependencies (actions, contributors, machines, run_table, tasks, tests_run, tests_stats, user, user_management, workers).
- [x] Assemble the shared base context (`build_template_context`) and pass it into every UI render so navigation/CSRF/session helpers remain stable across pages.
- [x] Replace in-template URL construction with prebuilt `*_url` fields or `url_for` calls so templates stay declarative.
- [x] Preformat labels, counts, and derived numbers in the view layer (`*_label`, `*_sort`, `nps_m`) to reduce inline math.
- [x] Centralize derived stats/data shaping in `template_helpers`, keeping templates free of DB or request access.
- [x] Preserve the `TemplateResponse(request=..., name=..., context=...)` pattern and keep rendering off the event loop.
- [x] Run parity coverage for touched views (template parity scripts + context coverage reports) to lock down regressions.
- [x] Keep signatures and behavior comparable to the legacy twins so parity metrics stay predictable.
- [x] Keep HTTP helpers (`http/api.py`, `http/views.py`) surgical and pair every change with parity tooling.
- [x] Shape the actions, tasks, and machines payloads (including `nps_m`) so templates receive ready-to-render data.

#### Template context builders
| Template | View(s) | Key focus |
| --- | --- | --- |
| `actions.html.j2` | `actions()` | Rows carry `time_label`, `agent_url`, `target_url`, `pages`, and `is_approver` so templates render buttons without request accesses. |
| `contributors.html.j2` | `contributors()` / `contributors_monthly()` | Provide summary totals, per-user rows, monthly toggle data, and preformatted labels. |
| `machines.html.j2` | `tests_machines()` | Supply `nps_m`, worker URLs, label strings, and sorted timestamps. |
| `run_table.html.j2` | `tests_view()` / `tests_user()` | Deliver run rows with `elo_context`, preformatted labels, and the URLs needed for links. |
| `tasks.html.j2` | `tests_tasks()` | Stream derived stats, result cells, and worker links so the template avoids inline math. |
| `tests_run.html.j2` | `tests_run()` | Feed JS payloads via `tojson`, prebuilt URLs, and remove string interpolation from scripts. |
| `tests_stats.html.j2` | `tests_stats()` | Use `build_tests_stats_context` so normalized Elo math matches legacy Mako output. |
| `user.html.j2`, `user_management.html.j2` | `user()` / `user_management()` | Provide action URLs, role/status fields, and preformatted labels. |
| `workers.html.j2` | `workers()` | Render worker rows, run links, and display labels without request coupling. |

### Phase 2 — Idiomatic Starlette Jinja2 rendering
Checklist:
- [x] Use `Jinja2Templates` with an explicit `Environment` and `select_autoescape` configuration.
- [x] Keep `TemplateResponse(request=..., name=..., context=...)` as the UI return path and include `request` in the context.
- [x] Keep rendering synchronous and off the event loop; avoid adding new async calls inside templates.
- [x] Prefer view-built contexts and `|tojson` for JS payloads so templates stay declarative and safe.

### Phase 3 — Parity tooling + minimal API/view changes
Checklist:
- [x] Run `WIP/tools/template_context_coverage.py --engine jinja` after each context builder lands to catch missing keys. (2026-02-08)
- [x] Run `WIP/tools/compare_template_parity.py` for every template touched to keep legacy comparisons honest. (2026-02-08)
- [x] Run `WIP/tools/compare_template_response_parity.py` to validate status/header parity for touched endpoints. (2026-02-08)
- [x] Add whitespace-minified parity scoring to `compare_template_parity.py`. (2026-02-10)
- [x] Update `WIP/docs/11.3-TEMPLATES-METRICS.md` if diffs materially change output size or render time. (2026-02-08)
- [x] Keep HTTP helpers surgical and pair every change with parity scripts.
- [x] Ensure parity tooling still compares runtime Jinja2 output against the legacy Mako templates.

### Phase 4 — Fixup and tooling hygiene
Checklist:
- [x] Fix REPO_ROOT depth in template metrics scripts (`templates_jinja_metrics.py`, `templates_mako_metrics.py`). (2026-02-09)
- [x] Consolidate parity stubs into `WIP/tools/_stubs.py` and update parity scripts. (2026-02-09)
- [x] Update M10 report with fixup statuses and corrected findings. (2026-02-09)
- [x] Re-audit context coverage tooling for `static_url` false positives and align fixtures. (2026-02-09)
- [x] Add urls-dict parity check and run it against current routes. (2026-02-09)
- [x] Remove `url_for` shadowing from the base template context. (2026-02-09)
- [x] Use bounded static token cache for `static_url` tokens. (2026-02-09)
- [x] Add TemplateResponse metadata verification tool. (2026-02-09)
- [x] Add linting helper for WIP/tools scripts. (2026-02-09)

#### Progress updates
- 2026-02-07: Removed the extra Mako renderer and its helper wiring so only the legacy Mako path survives for parity, while runtime rendering now only invokes the Jinja2 set.
- 2026-02-08: Refactored `tests_stats` to consume the helper-built stats context and normalized Elo math so the Jinja2 output tightly tracks the legacy HTML.
- 2026-02-08: Base context now carries `static_url`, `url_for`, and flash/session queues for every template; parity scripts still report diffs on the usual suspects while `elo_results.html.j2` and `pagination.html.j2` match cleanly.
- 2026-02-08: Template coverage tooling flags a few remaining missing keys (mostly `static_url` plus toggles in `run_tables.html.j2`, `nns.html.j2`, `nn_upload.html.j2`, `tests_run.html.j2`, `tests_live_elo.html.j2`).
- 2026-02-08: Renamed Jinja2 templates to `.html.j2` and updated parity tooling to map logical `.mak` names to Jinja2 file names.
- 2026-02-08: Removed the dual-engine template renderer and legacy Mako runtime module; parity scripts now render legacy Mako directly from WIP/tools without importing runtime renderers.
- 2026-02-08: Parity runs with the new WIP/tools render path still report normalized diffs for most templates; only `elo_results.html.j2` and `pagination.html.j2` match cleanly.
- 2026-02-08: Parity scripts re-run: context coverage missing keys include `static_url` (login, signup, sprt_calc, tests_live_elo, tests_run, tests_view, user), plus `filters/network_name_filter/user_filter/pages` in `nns`, `cc0_url/nn_stats_url/testing_guidelines_url/upload_url` in `nn_upload`, and `height/max_height/min_height/nps_m` in `tests`. Normalized HTML parity still matches only `elo_results` and `pagination`; all other templates differ in both raw and normalized comparisons.
- 2026-02-08: Scoped linting for `server/fishtest/http` (excluding `api.py` and `views.py`) now passes for `ruff check --select ALL --fix` and `ty check` using targeted file lists.
- 2026-02-08: Parity runs refreshed from WIP/tools (context coverage + HTML parity + response parity). Mismatches remain for every template except `elo_results` and `pagination`, and response-level checks show status/headers are aligned while HTML diffs persist.
- 2026-02-08: Template metrics refreshed; legacy Mako totals rose slightly, Jinja2 totals decreased, and the new Mako template directory is empty (metrics zeroed).
- 2026-02-09: Fixup phase started; metrics REPO_ROOT corrected, parity stubs consolidated, and M10 report statuses updated.
- 2026-02-09: Full parity runs completed (HTML + response parity). Normalized matches remain limited to `elo_results` and `pagination`.
- 2026-02-09: Context coverage fix landed (`static_url` treated as base key). Re-run shows remaining gaps limited to `nns`, `nn_upload`, and `tests` page-specific keys.
- 2026-02-09: Urls-dict parity check updated to treat concrete paths as matches for parameterized routes (`/workers/show` matches `/workers/{worker_name}`), resolving the false positive.
- 2026-02-09: `url_for` shadowing removed from base context; static token cache uses a bounded in-memory map.
- 2026-02-09: TemplateResponse metadata verification tool and WIP/tools lint helper added.
- 2026-02-09: Parity AST checks now report coverage/missing/extra; latest run shows UI views coverage 1.000 with 12 http-only helpers and 25 body drifts, API coverage 1.000 with 3 body drifts and 2 expected drifts. Route parity still shows 24 renderer mismatches (Mako vs Jinja2), API route parity remains OK, urls-dict parity OK, hotspot similarity ratios at 0.7473 (views) and 0.6991 (api), template parity still only normalized-matches `elo_results`/`pagination`, and Jinja2 context coverage is clean.
- 2026-02-10: HTML parity tooling now reports a whitespace-minified score; latest snapshot is recorded in 11.3-TEMPLATES-METRICS.md.

### Script source handling

- Pros:
	- Centralizing every `src` into JS constants makes dependency paths explicit and repeatable across templates that share widgets.
	- Programmatic assignment opens the door for lazy loading or feature-gated scripts without touching template markup again.
	- The constant definitions themselves can live in a single helper, simplifying parity checks between Jinja2 and legacy Mako.
- Cons:
	- Moving `src` values into JS runtime logic trades simple markup for more indirection and increases the chance of timing bugs if scripts are injected too late.
	- It requires writing lightweight loader code in every template or view, which is more work than keeping static `<script src>` includes.
	- Browsers may no longer preload scripts automatically via standard markup hints, so we could regress perceived performance if not careful.

	## Appendix: Modern Starlette/Jinja2 practices (2026)

	- Use `Jinja2Templates` with a custom `Environment` and `select_autoescape` for `html`, `xml`, and `j2`.
	- Always pass `TemplateResponse(request=..., name=..., context=...)` with keyword args and include `request` in context.
	- Keep rendering sync and off the event loop; avoid any async or DB work inside templates.
	- Prefer explicit, view-built context over context processors; keep globals minimal and audited.
	- Pass JS data with `|tojson` and use `|safe` only on audited HTML.

## Runtime cleanup & parity housekeeping
- Remove the legacy Mako renderer modules from the runtime path so `http/views.py` and `http/api.py` only import Jinja2 helpers.
- Keep the legacy Mako templates in [server/fishtest/templates](server/fishtest/templates) read-only and referenced solely by the parity scripts that now live in WIP/tools.
- Point every parity helper (context coverage, HTML diff, response comparison) at WIP/tools so runtime modules do not carry parity-specific logic.
- Rename `server/fishtest/templates_jinja2` files to `.html.j2` so they stop mimicking Mako's `.mak` suffix. (done 2026-02-08)

## Deliverables
- Runtime renders only Jinja2 templates from `templates_jinja2`.
- Legacy Mako templates remain available for parity scripts.
- Parity tooling compares runtime Jinja2 output against legacy Mako.
- Documentation reflects the Jinja2-only runtime and parity-only legacy Mako.
- Parity helper scripts live under WIP/tools and target the read-only legacy Mako templates.
- Templates in `server/fishtest/templates_jinja2` use the `.html.j2` extension, not the legacy `.mak` suffix.
