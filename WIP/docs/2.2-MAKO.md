# Mako templates catalog (base + helpers, then lexicographic)

Date: 2026-02-03

This document describes every Mako template under [server/fishtest/templates](server/fishtest/templates) in a hierarchical order: base layout and helper templates first, then the remaining templates in lexicographic order. It focuses on purpose, key inputs, Mako-specific features, and embedded-Python hotspots. Use this as a reference during the Jinja2 migration.

## Status (authoritative)

- Legacy Mako templates under [server/fishtest/templates](server/fishtest/templates) are the parity anchor and remain read-only for rebase safety.
- Runtime rendering is Jinja2 only; Mako is used by parity scripts in WIP/tools.
- Rendering stays synchronous and is offloaded by the UI pipeline; response metadata (`template`, `context`) is attached by the response adapter.

## Tooling

- HTML parity: [WIP/tools/compare_template_parity.py](WIP/tools/compare_template_parity.py)
- Response parity (status, headers, debug metadata): [WIP/tools/compare_template_response_parity.py](WIP/tools/compare_template_response_parity.py)
- Context coverage (missing keys): [WIP/tools/template_context_coverage.py](WIP/tools/template_context_coverage.py)
- Metrics: [WIP/docs/11.3-TEMPLATES-METRICS.md](WIP/docs/11.3-TEMPLATES-METRICS.md)

## base.mak

- Purpose: Global base layout, navbar, offcanvas menus, flash messages, and page body slot.
- Inputs: `request` (session, cookies, static_url, userdb, authenticated_userid).
- Embedded Python:
  - Inline `if`/`for` blocks for navigation and flash messages.
  - Uses inline expressions for theme toggles and static_url calls.
  - Populates and consumes `request.session.pop_flash()`.
- Special cases:
  - Contains `<%block name="head"/>` for per-page head injection.
  - Uses request cookies to toggle dark theme assets.

## elo_results.mak

- Purpose: Inline Elo/LLR rendering for run tables (also used with gauges).
- Inputs: `run`, `show_gauge`, `results_info`.
- Embedded Python:
  - Module block: helper `results_pre_attrs`, imports from `fishtest.util`.
  - Complex inline Python to compute pentanomial stats and nElo details.
  - Defines macro-like `<%def name="list_info(run)">`.
- Special cases:
  - Conditional anchor wrapping for SPRT live elo links.
  - Uses `|n` for pre tag attributes.

## machines.mak

- Purpose: Machines table partial for workers page (loaded via fetch).
- Inputs: `machines_list`.
- Embedded Python:
  - Module block: helper `clip_long` and imports.
  - Inline code block per machine to compute formatted values.
  - `for` loop with `if` checks for country flag and empty list.
- Special cases:
  - Builds links to workers and tests with derived values.

## pagination.mak

- Purpose: Pagination component used by several pages.
- Inputs: `pages` list with `state`, `url`, `idx`.
- Embedded Python:
  - `if` guard for small page lists.
  - `for` loop over pages.

## run_table.mak

- Purpose: Table block for run lists, including actions and stats.
- Inputs: `runs`, `pages`, `show_delete`, `header`, `count`, `toggle`, `alt`, `title`, `request`.
- Embedded Python:
  - Namespace import for `base.mak`.
  - Module block: imports helpers from `fishtest.util`.
  - Inline `if`/`for` blocks and includes of `elo_results.mak`.
  - Uses cookie state for collapse toggles.
- Special cases:
  - Includes `pagination.mak` and `elo_results.mak`.

## run_tables.mak

- Purpose: Composition of several run_table blocks for pending/active/finished.
- Inputs: `runs`, `failed_runs`, `finished_runs`, `page_idx`, `username`.
- Embedded Python:
  - Inline code block to compute `prefix` for toggle cookies.
  - Inline code block to compute pending/paused lists.
  - Includes `run_table.mak` multiple times.

## tasks.mak

- Purpose: Task rows for a run (loaded via fetch on run view).
- Inputs: `run`, `show_task`, `approver`, `chi2`.
- Embedded Python:
  - Module block: imports `worker_name`, `display_residual`.
  - Heavy inline code per task (derivations, branching, formatting).
  - Conditional pentanomial display.
- Special cases:
  - Uses `|n` for unescaped output in places.

## actions.mak

- Purpose: Events log page with filters (action type, user, free-text) and a paginated table.
- Inputs: `actions`, `pages`, `action_param`, `username_param`, `text_param`, `run_id_param`, `approver`, `request.userdb`.
- Embedded Python:
  - Module block: imports `datetime`.
  - Inline code block: chooses agent link/label depending on `action` fields.
  - Mako control flow for `for`, `if`, `elif`, `else` in table rows.
- Special cases:
  - Uses `request.userdb.get_users()` in `<datalist>`.
  - Uses `|u` and `|n` filters for URLs and unescaped content.
  - Builds query links with `action['time']` and conditional `task_id`.

## contributors.mak

- Purpose: Contributors table and summary stats, with client-side search.
- Inputs: `users`, `approver`, `request.url`.
- Embedded Python:
  - Module block: imports `datetime`, `urllib`, `format_time_ago`.
  - Inline expressions for aggregates (sum of users, cpu hours, etc.).
  - `for` loop over users with `if` branches for approver links.
- Special cases:
  - Uses `format_time_ago` and `urllib.parse.quote` for links.

## login.mak

- Purpose: Login form page.
- Inputs: `request.static_url` for JS include.
- Embedded Python: minimal; only static_url expression.

## nn_upload.mak

- Purpose: Neural network upload form.
- Inputs: `request.url`.
- Embedded Python: minimal; only `request.url` expression.

## nns.mak

- Purpose: Neural network repository listing with filters and pagination.
- Inputs: `nns`, `pages`, `master_only`, `request.GET`.
- Embedded Python:
  - `for` loop with `if` branch for master-only rows.
  - Inline expressions for table values and links.
  - Sets a long-lived cookie via JS string interpolation.
- Special cases:
  - Uses `request.GET` to prefill filters.

## notfound.mak

- Purpose: 404 HTML page.
- Inputs: none.
- Embedded Python: none.

## rate_limits.mak

- Purpose: GitHub rate limit status page with polling logic.
- Inputs: none (JS fetches `/api/rate_limit`).
- Embedded Python: none.

## signup.mak

- Purpose: Registration form and recaptcha include.
- Inputs: `request.session` for CSRF, `request.static_url`.
- Embedded Python:
  - Uses `<%block name="head">` to inject recaptcha.
  - Inline expressions for CSRF and static_url.

## sprt_calc.mak

- Purpose: SPRT calculator with JS charts.
- Inputs: `request.static_url`.
- Embedded Python: minimal; static_url expressions only.

## tests.mak

- Purpose: Main tests overview with queue stats and machines panel.
- Inputs: `page_idx`, `cores`, `nps`, `games_per_minute`, `pending_hours`, `machines_shown`, `machines_count`.
- Embedded Python:
  - Inline code block to compute heights for skeleton layout.
  - `if page_idx == 0` and JS that embeds Mako expressions.
- Special cases:
  - Includes `run_tables.mak`.

## tests_finished.mak

- Purpose: Finished tests list with filters (LTC/Greens/Yellows).
- Inputs: `finished_runs`, `finished_runs_pages`, `title`, `request.url`.
- Embedded Python:
  - Inline code block to build `title` based on URL.
  - Conditional heading text.
  - Includes `run_table.mak`.

## tests_live_elo.mak

- Purpose: Live Elo chart page for a run.
- Inputs: `run`, `page_title`.
- Embedded Python: inline expressions for run id and title only.

## tests_run.mak

- Purpose: Create new test form (largest UI form).
- Inputs: `args`, `master_info`, `pt_info`, `supported_arches`, `supported_compilers`, `tests_repo`, `is_rerun`, `rescheduled_from`.
- Embedded Python:
  - Large module block with imports and defaults.
  - Inline code blocks for defaults, book/arch/compiler values.
  - Many inline expressions embedded in HTML attributes and JS.
- Special cases:
  - Extensive JS depends on interpolated template values.
  - Uses `|h` and `|n` filters.

## tests_stats.mak

- Purpose: Raw statistics page with extensive statistical computations.
- Inputs: `run`, `page_title`.
- Embedded Python:
  - Very large module block: many helper functions and statistical calculations.
  - Extensive inline logic for conditional tables and computed values.
- Special cases:
  - Heavy Mako compute surface; a prime candidate for migration into Python helpers.

## tests_user.mak

- Purpose: User-specific tests list.
- Inputs: `username`, `is_approver`.
- Embedded Python:
  - Simple `if` for approver link; includes `run_tables.mak`.

## tests_view.mak

- Purpose: Run detail page (largest and most complex view).
- Inputs: `run`, `page_title`, `run_args`, `warnings`, `notes`, `show_task`, `follow`, `use_3dot_diff`, `tasks_shown`, `approver`, `same_user`, `can_modify_run`.
- Embedded Python:
  - Module block with imports from `fishtest.github_api` and helpers.
  - Inline code blocks and conditionals across multiple sections.
  - Complex JS with template interpolation and control flow.
- Special cases:
  - Includes `elo_results.mak`.
  - Uses `|n` for unescaped HTML in multiple places.

## user.mak

- Purpose: Profile page and user management form (profile/admin modes).
- Inputs: `profile`, `user`, `limit`, `hours`, `format_date`, `extract_repo_from_link`.
- Embedded Python:
  - Module block for `format_group`.
  - Many `if` branches for profile vs admin view.
- Special cases:
  - Extensive HTML form and modal interactions.

## user_management.mak

- Purpose: User management dashboard (table with filters).
- Inputs: `all_users`, `pending_users`, `blocked_users`, `idle_users`, `approvers_users`.
- Embedded Python:
  - Module block for `format_group`.
  - `for` loops per table body; `if` for empty lists.

## workers.mak

- Purpose: Worker management and blocked worker list with filters.
- Inputs: `show_admin`, `worker_name`, `last_updated`, `blocked_workers`, `blocked`, `message`, `show_email`.
- Embedded Python:
  - Module block with `datetime`, `quote`, `format_time_ago`.
  - `if` branches for admin mode and table filters.
- Special cases:
  - Uses `mailto:` links with URL-encoded subject/body.

## Complexity table

Scoring model: statement lines (x3) + code-tag lines (x2) + expression count.

| Template | Lines | Statement lines | Code-tag lines | Expr count | Score |
| --- | --- | --- | --- | --- | --- |
| tests_view.mak | 997 | 76 | 5 | 73 | 311 |
| tests_stats.mak | 442 | 41 | 3 | 80 | 209 |
| run_table.mak | 147 | 27 | 7 | 38 | 133 |
| tests_run.mak | 1207 | 14 | 4 | 79 | 129 |
| tasks.mak | 93 | 24 | 5 | 29 | 111 |
| actions.mak | 189 | 20 | 5 | 28 | 98 |
| user_management.mak | 188 | 21 | 2 | 30 | 97 |
| base.mak | 572 | 20 | 4 | 14 | 82 |
| user.mak | 280 | 20 | 3 | 15 | 81 |
| elo_results.mak | 92 | 20 | 5 | 6 | 76 |
| nns.mak | 118 | 13 | 3 | 13 | 58 |
| contributors.mak | 173 | 10 | 2 | 20 | 54 |
| workers.mak | 150 | 12 | 2 | 13 | 53 |
| machines.mak | 71 | 8 | 2 | 18 | 46 |
| run_tables.mak | 52 | 5 | 8 | 0 | 31 |
| tests.mak | 141 | 3 | 3 | 15 | 30 |
| pagination.mak | 17 | 7 | 1 | 4 | 27 |
| tests_finished.mak | 32 | 5 | 3 | 1 | 22 |
| tests_user.mak | 14 | 3 | 2 | 4 | 17 |
| tests_live_elo.mak | 78 | 0 | 1 | 5 | 7 |
| signup.mak | 122 | 0 | 2 | 2 | 6 |
| sprt_calc.mak | 142 | 0 | 1 | 2 | 4 |
| login.mak | 63 | 0 | 1 | 1 | 3 |
| nn_upload.mak | 87 | 0 | 1 | 1 | 3 |
| notfound.mak | 51 | 0 | 1 | 0 | 2 |
| rate_limits.mak | 86 | 0 | 1 | 0 | 2 |
