# Iteration plan (Milestone 8 — templates: legacy Mako, new Mako, Jinja2)

Date: 2026-02-05
Status: Complete (2026-02-05)

Note: The new Mako track was retired in Milestone 10. References to
`templates_mako` and `mako_new` in this closed iteration are historical.

## Goals
- Keep three template engines in lockstep (legacy Mako, new Mako, Jinja2).
- Ensure renderer selection is controlled in Python (no env flag toggles).
- Maintain UI parity with normalized HTML diffs.
- Add metrics tooling to track complexity drift across engines.
- Assess template simplification by moving shared or clearer logic into helpers.

## Requirements
- Legacy templates remain in [server/fishtest/templates](server/fishtest/templates) for rebase safety.
- Legacy templates are read-only; make changes only in [server/fishtest/templates_mako](server/fishtest/templates_mako) and [server/fishtest/templates_jinja2](server/fishtest/templates_jinja2).
- Any template change is mirrored in legacy Mako, new Mako, and Jinja2.
- Parity scripts must pass before doc claims parity.
- ASCII-only source where practical; use HTML entities for symbols when needed.
- Template rendering stays off the event loop (threadpool boundary preserved).
- Add helper functions only when they simplify templates or reduce duplication.
- Do not move all Python out of templates by default; move shared logic, hard-to-read escapes, or complex formatting.

## References
- Templates: [server/fishtest/templates](server/fishtest/templates), [server/fishtest/templates_mako](server/fishtest/templates_mako), [server/fishtest/templates_jinja2](server/fishtest/templates_jinja2)
- Renderer: [server/fishtest/http/template_renderer.py](server/fishtest/http/template_renderer.py)
- Parity tooling: [WIP/tools/compare_template_parity.py](WIP/tools/compare_template_parity.py)
- Metrics doc: [WIP/docs/11.3-TEMPLATES-METRICS.md](WIP/docs/11.3-TEMPLATES-METRICS.md)

## Metrics
- Parity: legacy Mako vs new Mako and legacy Mako vs Jinja2 must match on normalized HTML.
- Template metrics: totals for statements, expressions, score, nesting, and escaping usage.
- When a metric does not apply to an engine, use N/A (not 0).

## Phases

### Phase 0 — Baseline parity and renderer selection
- Confirm parity for legacy Mako vs new Mako and legacy Mako vs Jinja2.
- Move renderer selection to a Python variable in the renderer module.

### Phase 1 — New templates and helpers
- Write the new Mako templates under [server/fishtest/templates_mako](server/fishtest/templates_mako).
- Write Jinja2 templates under [server/fishtest/templates_jinja2](server/fishtest/templates_jinja2).
- Add companion helpers where they reduce duplication or clarify escaping/formatting.

### Phase 2 — Parametric renderer switching
- Provide a clear, explicit switch between renderers in [server/fishtest/http/template_renderer.py](server/fishtest/http/template_renderer.py).
- Document how to set the renderer at runtime for parity checks and debugging.

### Phase 3 — Template metrics tooling
- Add template metrics scripts to [WIP/tools](WIP/tools) with a clear templates_* naming scheme.
- Document how to run metrics from [WIP/docs](WIP/docs).

### Phase 4 — Documentation pass
- Update template plan docs and the metrics snapshot.
- Keep the iteration record concise and aligned with the tooling paths.

### Phase 5 — Simplification assessment
- Review templates and identify logic that should move into helpers.
- Prioritize shared logic, complex escaping, and hard-to-read inline computation.
- Keep template code lean and idiomatic, without forcing all logic into Python.

## Phase results (current branch)

### Phase 0 — Complete (2026-02-05)
Deliverables:
- Renderer selection via Python variable in [server/fishtest/http/template_renderer.py](server/fishtest/http/template_renderer.py).
- Parity validation for legacy Mako vs new Mako and legacy Mako vs Jinja2.

Result:
- Renderer choice is no longer tied to environment flags.

### Phase 1 — Complete (2026-02-05)
Deliverables:
- New Mako templates in [server/fishtest/templates_mako](server/fishtest/templates_mako).
- Jinja2 templates in [server/fishtest/templates_jinja2](server/fishtest/templates_jinja2).
- Companion helpers shared across renderers where they simplify formatting or reuse logic.

Result:
- New templates exist with parity against legacy Mako output.

### Phase 2 — Complete (2026-02-05)
Deliverables:
- Renderer selection is driven by a Python variable in [server/fishtest/http/template_renderer.py](server/fishtest/http/template_renderer.py).
- Renderer switching is explicit for parity runs and debugging.

Result:
- Renderer selection is deterministic and does not require environment flags.

### Phase 3 — Complete (2026-02-05)
Deliverables:
- Metrics scripts added:
  - [WIP/tools/templates_mako_metrics.py](WIP/tools/templates_mako_metrics.py)
  - [WIP/tools/templates_jinja_metrics.py](WIP/tools/templates_jinja_metrics.py)
  - [WIP/tools/templates_comparative_metrics.py](WIP/tools/templates_comparative_metrics.py)

Result:
- Metrics can be run from [WIP/docs](WIP/docs) and produce JSON snapshots.

### Phase 4 — Complete (2026-02-05)
Deliverables:
- Metrics snapshot recorded in [WIP/docs/11.3-TEMPLATES-METRICS.md](WIP/docs/11.3-TEMPLATES-METRICS.md).
- Template plan docs updated with current parity status.

Result:
- Documentation reflects current template parity and metrics tooling.

### Phase 5 — Complete (2026-02-05)
Deliverables:
- Helper assessment completed with a short list of candidates to move into helpers.
- Templates simplified where helper extraction improves readability or reduces duplication.

Result:
- Helper consolidation done for Elo widget calculations and stats helpers.

## Tasks and deliverables
- [x] Parity checks for legacy/new Mako and legacy/Jinja2.
- [x] Renderer selection moved to Python variable.
- [x] Metrics scripts added and documented.
- [x] Metrics snapshot recorded.
- [x] Helper simplification assessment and targeted refactors.

## Tooling (run from WIP/docs)

Parity:

```
cd /home/usr00/_git/fishtest-fastapi/server
uv run python3 ../WIP/tools/compare_template_parity.py --left-engine mako --left-dir fishtest/templates \
  --right-engine mako --right-dir fishtest/templates_mako --context ../WIP/tools/template_parity_context.json
uv run python3 ../WIP/tools/compare_template_parity.py --left-engine mako --left-dir fishtest/templates \
  --right-engine jinja --right-dir fishtest/templates_jinja2 --context ../WIP/tools/template_parity_context.json
```

Metrics:

```
/home/usr00/_git/fishtest-fastapi/server/.venv/bin/python ../tools/templates_mako_metrics.py \
  --templates-dir ../../server/fishtest/templates --json
/home/usr00/_git/fishtest-fastapi/server/.venv/bin/python ../tools/templates_mako_metrics.py \
  --templates-dir ../../server/fishtest/templates_mako --json
/home/usr00/_git/fishtest-fastapi/server/.venv/bin/python ../tools/templates_jinja_metrics.py \
  --templates-dir ../../server/fishtest/templates_jinja2 --json
/home/usr00/_git/fishtest-fastapi/server/.venv/bin/python ../tools/templates_comparative_metrics.py --json
```

## Metrics snapshot (2026-02-05)

Parity comparisons:
- Legacy Mako vs new Mako: parity OK (normalized HTML).
- Legacy Mako vs Jinja2: parity OK (normalized HTML).

Totals (templates, lines, statements, code tags, expressions, score):
- Legacy Mako: templates=26, lines=5549, statements=349, code_tags=77, expressions=491, score=1692
- New Mako: templates=26, lines=5529, statements=347, code_tags=73, expressions=491, score=1678
- Jinja2: templates=26, lines=5538, statements=716, code_tags=N/A, expressions=489, score=2637

Heuristic complexity metrics:
- Max nesting (any template): legacy Mako=5, new Mako=5, Jinja2=6
- Avg max nesting: legacy Mako=1.58, new Mako=1.58, Jinja2=2.46
- Script interpolation lines: legacy Mako=56, new Mako=56, Jinja2=55
- Unescaped occurrences (|n / |safe): legacy Mako=14, new Mako=14, Jinja2=0

Notes:
- The score formula is statements*3 + code_tags*2 + expressions.
- Jinja2 does not have Mako code tags, so code_tags is N/A for Jinja2.
- The higher Jinja2 score reflects more statement tags, not necessarily worse readability.

## Helper assessment (analysis)
- Consolidated Elo widget math into shared helpers, removing duplicate stats math from templates.
- Reused shared formatting helpers (pdf/list stringification and t-conf) in stats templates.
- Switched nelo constant to the authoritative `LLRcalc.nelo_divided_by_nt` in stats templates.
- Ensured Jinja2 and new Mako use the same helper surface as legacy Mako.

Follow-up candidates (assessment and decision):

Candidate A — Task row worker metadata formatting helper
- Pros: reduces repeated formatting rules across Jinja2 and new Mako; simplifies templates and keeps worker metadata rendering consistent.
- Cons: risks overfitting to one template; requires careful parity validation on subtle string formatting and spacing.
- Decision: keep as a candidate, but only implement if a shared helper reduces complexity without changing formatting. Apply only in Jinja2 and new Mako.

Candidate B — Shared JS escaping helper for inline scripts
- Pros: centralizes escaping rules; lowers XSS risk; reduces hand-rolled string escaping in templates.
- Cons: behavior changes can be hard to detect; must preserve legacy HTML/JS parity exactly.
- Decision: keep as a candidate, but defer until a safe test harness exists to diff the generated JS. Apply only in Jinja2 and new Mako.

Clear list of helper export candidates:
- Worker metadata formatting helper used by task rows (Jinja2 + new Mako only).
- JS string escaping helper for inline scripts (Jinja2 + new Mako only).

## Verification
- Parity scripts: [WIP/tools/compare_template_parity.py](WIP/tools/compare_template_parity.py) for mako vs mako and mako vs jinja.
- Metrics scripts: [WIP/tools/templates_mako_metrics.py](WIP/tools/templates_mako_metrics.py), [WIP/tools/templates_jinja_metrics.py](WIP/tools/templates_jinja_metrics.py), [WIP/tools/templates_comparative_metrics.py](WIP/tools/templates_comparative_metrics.py).
