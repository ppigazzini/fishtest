# Jinja2 template context contracts (status quo)

Date: 2026-02-09
Status: Current

This document defines the **explicit context contract** for each Jinja2 template in
`server/fishtest/templates_jinja2/`. The intent is to remove hidden dependencies
on request internals and move all data shaping into the view layer or helpers.

## Conventions

- Templates should not fetch data. Views provide fully shaped context.
- The request object is not used directly in templates, except via `url_for` and
  `static_url` helpers passed in context.
- Prefer preformatted display strings (use `*_label`) and explicit URLs (`*_url`).
-- Prefer structured objects over ad-hoc dict access in templates.
-- JS data must be passed as JSON (`|tojson`) and not interpolated into JS strings.

## Base context rules

- Provide the shared base context in `build_template_context` (do not rely on implicit globals).
- Always pass `urls`, `csrf_token`, `current_user`, `theme`, and `pending_users_count` for base layout navigation and badges.
- Prefer view-shaped rows for actions, tasks, and machines; templates should not build URLs or derive labels.
- Preformat display strings (time labels and `nps_m`) with ASCII characters only.
- AJAX endpoints for tasks and machines must return the same shaped context as full-page renders.

## Shared base context (all pages)

Required keys (used by base layout):
- `static_url(path: str) -> str` for static asset URLs.
- `url_for(name: str, **params) -> str` for named routes.
- `csrf_token` (string) for meta tag and form hidden inputs.
- `theme` (string, `"dark"` or `"light"`, or empty) for theme toggles.
- `current_user` (object or null):
  - `username` (string) and `id` (string or int) if authenticated.
- `pending_users_count` (int) for the user-management badge.
- `flash` (dict): `error`, `warning`, `info` lists (each list contains strings).
- `urls` (dict of route names to URL strings) for primary navigation:
   - `home`, `tests`, `tests_finished`, `tests_finished_ltc`, `tests_finished_success`,
     `tests_finished_yellow`, `tests_run`, `tests_user_prefix`, `nn_upload`, `nns`,
     `contributors`, `contributors_monthly`, `actions`, `user_management`,
     `workers_blocked`, `sprt_calc`, `rate_limits`, `login`, `logout`, `signup`,
     `user_profile`.

Optional keys:
- `page_title` (string) if the base template owns the `<title>` block.
- `template_request` (TemplateRequest) for legacy helpers such as `static_url` and `authenticated_userid`.

---

## Template contracts

### base.html.j2
Required context keys:
- Uses **Shared base context** only.

---

### actions.html.j2
Required context keys:
- `actions` (list of action rows), each row has:
  - `time_unix` (int)
  - `time_label` (string, already formatted)
  - `event` (string)
  - `agent_name` (string)
  - `agent_url` (string or null)
  - `target_name` (string or empty)
  - `target_url` (string or null)
  - `message` (string or empty)
- `filters` (dict):
  - `action` (string)
  - `username` (string)
  - `text` (string)
  - `run_id` (string or empty)
- `usernames` (list of strings) for the datalist.
- `pages` (list of pagination items; see pagination.html.j2).
- `is_approver` (bool).

Optional keys:
- `action_url` (string) if the template uses a prebuilt URL for pagination links.

---

### contributors.html.j2
Required context keys:
- `is_monthly` (bool).
- `is_approver` (bool).
- `summary` (dict): `testers`, `developers`, `active_testers`, `cpu_years`, `games`, `tests`.
- `users` (list), each user has:
  - `username` (string)
  - `last_updated_label` (string)
  - `last_updated_sort` (number)
  - `games_per_hour` (int)
  - `cpu_hours` (int)
  - `games` (int)
  - `tests` (int)
  - `tests_repo` (string)
  - `tests_repo_url` (string)
  - `tests_user_url` (string)

---

### elo_results.html.j2
Required context keys:
- `elo` (dict):
  - `info_lines` (list of strings)
  - `pre_attrs` (string of HTML attributes for the `<pre>`)
  - `show_gauge` (bool)
  - `chart_div_id` (string)
  - `nelo_summary_html` (string or null, already safe HTML)
  - `live_elo_url` (string or null)
  - `is_sprt` (bool)

---

### login.html.j2
Required context keys:
- None beyond Shared base context.

---

### machines.html.j2
Required context keys:
- `machines` (list), each row has:
  - `username` (string)
  - `country_code` (string or null)
  - `concurrency` (int)
  - `worker_url` (string)
  - `worker_short` (string)
  - `nps_m` (string, preformatted)
  - `max_memory` (string)
  - `system` (string)
  - `worker_arch` (string)
  - `compiler_label` (string)
  - `python_label` (string)
  - `version_label` (string)
  - `run_url` (string)
  - `run_label` (string)
  - `last_active_label` (string)
  - `last_active_sort` (number)

---

### nn_upload.html.j2
Required context keys:
- `upload_url` (string)
- `testing_guidelines_url` (string)
- `cc0_url` (string)
- `nn_stats_url` (string)

---

### nns.html.j2
Required context keys:
- `filters` (dict): `network_name`, `user`, `master_only`.
- `pages` (list of pagination items; see pagination.html.j2).
- `nns` (list), each row has:
  - `time_label` (string)
  - `name` (string)
  - `name_url` (string)
  - `user` (string)
  - `first_test_label` (string or empty)
  - `first_test_url` (string or empty)
  - `last_test_label` (string or empty)
  - `last_test_url` (string or empty)
  - `downloads` (int)
  - `is_master` (bool)

---

### notfound.html.j2
Required context keys:
- None beyond Shared base context.

---

### pagination.html.j2
Required context keys:
- `pages` (list of items), each item has:
  - `idx` (string or int)
  - `url` (string)
  - `state` (string: `active`, `disabled`, or empty)

---

### rate_limits.html.j2
Required context keys:
- None beyond Shared base context.

---

### run_table.html.j2
Required context keys:
- `header` (string or null)
- `count` (int or null)
- `page_idx` (int)
- `username` (string or empty)
- `title_suffix` (string)
- `toggle` (string or null)
- `toggle_state` (string: `"Hide"` or `"Show"`)
- `pages` (list of pagination items; see pagination.html.j2)
- `show_delete` (bool)
- `alt` (string or null)
- `runs` (list), each run has:
  - `id` (string)
  - `start_date_label` (string)
  - `user_short` (string)
  - `user_name` (string)
  - `user_url` (string)
  - `is_finished` (bool)
  - `is_sprt` (bool)
  - `new_tag_short` (string)
  - `run_url` (string)
  - `diff_url` (string)
  - `elo_context` (dict for elo_results.html.j2)
  - `tc` (string)
  - `threads` (int)
  - `num_games` (int)
  - `cores_label` (string)
  - `info` (string)

---

### run_tables.html.j2
Required context keys:
- `page_idx` (int)
- `prefix` (string)
- `runs` (dict):
  - `pending` (list of run rows)
  - `active` (list of run rows)
- `failed_runs` (list of run rows)
- `finished_runs` (list of run rows)
- `num_finished_runs` (int)
- `finished_runs_pages` (list of pagination items)

---

### signup.html.j2
Required context keys:
- `csrf_token` (string)
- `recaptcha_site_key` (string)

---

### sprt_calc.html.j2
Required context keys:
- None beyond Shared base context.

---

### tasks.html.j2
Required context keys:
- `tasks` (list), each row has:
  - `task_id` (int)
  - `row_class` (string)
  - `worker_label` (string)
  - `worker_url` (string or empty)
  - `info_label` (string)
  - `last_updated_label` (string)
  - `played_label` (string)
  - `results_cells` (list of strings)
  - `crashes` (string)
  - `time_losses` (string)
  - `residual_label` (string or empty)
  - `residual_bg` (string or empty)
- `show_pentanomial` (bool)
- `show_residual` (bool)

---

### tests.html.j2
Required context keys:
- `page_idx` (int)
- `cores` (int)
- `nps_m` (string)
- `games_per_minute` (string)
- `pending_hours` (string)
- `machines_shown` (bool)
- `machines_count` (int)
- `run_tables_ctx` (dict for run_tables.html.j2)

---

### tests_finished.html.j2
Required context keys:
- `filters` (dict): `ltc_only`, `success_only`, `yellow_only` (bools)
- `title_suffix` (string)
- `finished_runs` (list of run rows)
- `num_finished_runs` (int)
- `finished_runs_pages` (list of pagination items)

---

### tests_live_elo.html.j2
Required context keys:
- `run_id` (string)
- `page_title` (string)
- `run_url` (string)

---

### tests_run.html.j2
Required context keys:
- `form` (dict):
  - `action_url` (string)
  - `csrf_token` (string)
- `is_rerun` (bool)
- `rescheduled_from` (string or empty)
- `preset_tests` (list of dicts) for test-type buttons, each with:
  - `id`, `label`, `title`, `checked` (bool), `options_json` (string), `collapsed` (bool)
- `form_values` (dict of explicit values used in inputs):
  - `tests_repo`, `new_tag`, `base_branch`, `new_signature`, `base_signature`
  - `new_options`, `base_options`, `info`
  - `stop_rule` (string: `sprt`, `games`, `spsa`)
  - `elo_model` (string)
  - `bounds` (string)
  - `sprt` (dict: `elo0`, `elo1`)
  - `spsa` (dict: `A`, `alpha`, `gamma`, `raw_params`)
  - `num_games`, `threads`, `tc`, `new_tc`, `priority`, `throughput`
  - `book`, `book_depth`, `arch_filter`, `compiler`
  - `adjudication` (bool)
  - `auto_purge` (bool)
  - `resolved_base`, `resolved_new`, `msg_base`, `msg_new` (strings or empty)
- `books` (dict):
  - `default_book`, `test_book`, `pt_book`, `valid_books`
- `pt_context` (dict):
  - `pt_branch`, `pt_signature`, `pt_version`, `master_message`, `master_date`
- `supported` (dict):
  - `compilers` (list of strings)
  - `arches` (list of strings)
- `flags` (dict):
  - `show_games_fields`, `show_sprt_fields`, `show_spsa_fields`
  - `show_book_fields`, `show_arch_filter`, `show_compiler`
  - `is_odds`, `arch_filter_enabled`, `compiler_enabled`, `custom_book_enabled`
- `bounds_labels` (dict):
  - `standard_stc`, `standard_ltc`, `regression_stc`, `regression_ltc`

---

### tests_stats.html.j2
Required context keys:
- `page_title` (string)
- `run_id` (string)
- `run_url` (string)
- `has_spsa` (bool)
- `has_sprt` (bool)
- `has_pentanomial` (bool)
- `context_rows` (list of `{label, value}` strings)
- `sprt_rows` (list of `{label, value}` strings) when `has_sprt`
- `draw_rows` (list of `{label, value}` strings)
- `pentanomial_sections` (list of sections), each section:
  - `title` (string)
  - `rows` (list of `{label, value}` strings)
  - `note` (string or null)
- `trinomial_sections` (list of sections), same structure as pentanomial
- `comparison_rows` (list of `{label, value}` strings) when `has_pentanomial`

---

### tests_user.html.j2
Required context keys:
- `username` (string)
- `is_approver` (bool)
- `run_tables_ctx` (dict for run_tables.html.j2)

---

### tests_view.html.j2
Required context keys:
- `page_title` (string)
- `run_id` (string)
- `run` (dict with display-ready fields):
  - `start_time_label`, `last_updated_label`, `finished` (bool)
  - `username`, `username_url`, `approver`, `approver_url`
  - `num_games`, `priority`, `throughput`, `auto_purge`
- `run_args_rows` (list of rows):
  - `name`, `value_html`, `link_url` (nullable)
- `document_size_label` (string)
- `warnings_html` (list of trusted HTML strings)
- `notes_html` (list of trusted HTML strings)
- `can_modify_run` (bool)
- `same_user` (bool)
- `chi2_rows` (list of `{label, value}` strings)
- `tasks_shown` (bool)
- `tasks_total_label` (string)
- `show_task` (int)
- `follow` (int)
- `spsa_data` (dict or null)
- `diff` (dict):
  - `url` (string)
  - `github_api_url` (string)
  - `tests_repo_api_url` (string)
  - `resolved_new_short` (string)
  - `resolved_base_short` (string)
  - `official_master_sha` (string or null)
  - `use_3dot` (bool)
  - `allow_github_api_calls` (bool)
- `urls` (dict):
  - `tests_view`, `tests_stats`, `tests_run`, `tests_user`, `user_info`,
    `tests_stop`, `tests_approve`, `tests_purge`, `tests_modify`,
    `tests_actions`, `api_run_pgns`, `tests_tasks`.

---

### user.html.j2
Required context keys:
- `profile` (bool)
- `page_title` (string)
- `user` (dict):
  - `username`, `tests_user_url`, `registration_time_label`
  - `tests_repo`, `tests_repo_url`, `tests_repo_label`
  - `email`, `email_url`, `groups_label`
  - `pending` (bool), `blocked` (bool)
- `limit` (string)
- `hours` (string)
- `post_url` (string)

---

### user_management.html.j2
Required context keys:
- `all_users`, `pending_users`, `blocked_users`, `idle_users`, `approvers_users` (lists)
- Each user entry has: `username`, `user_url`, `registration_time_label`, `groups_label`, `email`

---

### workers.html.j2
Required context keys:
- `show_admin` (bool)
- `worker_name` (string)
- `last_updated_label` (string or null)
- `message` (string)
- `blocked` (bool)
- `show_email` (bool)
- `blocked_workers` (list), each row has:
  - `worker_name` (string)
  - `worker_url` (string)
  - `last_updated_label` (string)
  - `actions_url` (string)
  - `actions_label` (string)
  - `owner_email` (string, optional)
  - `owner_email_url` (string, optional)
