# Iteration plan (Milestone 7 — HTTP boundary extraction without bloat)

Date: 2026-01-29

## Goals
- Extract shared HTTP plumbing into [server/fishtest/http/boundary.py](server/fishtest/http/boundary.py).
- Preserve external behavior: JSON shapes, HTML errors, redirects, cookie names/flags, CSRF rules, template context.
- Keep [server/fishtest/http/api.py](server/fishtest/http/api.py) and [server/fishtest/http/views.py](server/fishtest/http/views.py) readable with minimal helper hops and no duplication.

## Requirements
- Maintain protocol parity for worker APIs and UI routes.
- Preserve explicit `run_in_threadpool` boundaries.
- Keep HTML errors for UI and JSON errors for API unchanged.
- No router explosion; routes remain in current modules.
- Boundary module is import-safe (no app assembly side effects).
- Boundary name is [server/fishtest/http/boundary.py](server/fishtest/http/boundary.py); split only if required.
- No-duplication: shared HTTP plumbing must live in the boundary module.
- Do not move business logic into the boundary module.
- Avoid new middleware layers or implicit global wiring.

## References
- [WIP/docs/6-FASTAPI-REFERENCES.md](WIP/docs/6-FASTAPI-REFERENCES.md)
- [WIP/docs/7-STARLETTE-REFERENCES.md](WIP/docs/7-STARLETTE-REFERENCES.md)
- [server/fishtest/http/api.py](server/fishtest/http/api.py)
- [server/fishtest/http/views.py](server/fishtest/http/views.py)
- [server/fishtest/api.py](server/fishtest/api.py)
- [server/fishtest/views.py](server/fishtest/views.py)
- [__fishtest-bloat/server/fishtest/web/api/internal_shim.py](__fishtest-bloat/server/fishtest/web/api/internal_shim.py)
- [__fishtest-bloat/server/fishtest/web/ui/pipeline.py](__fishtest-bloat/server/fishtest/web/ui/pipeline.py)

## Metrics
- Hop count ≤ 1 helper hop per endpoint.
- Helper calls ≤ 2 per endpoint.
- 100% of shared request/response plumbing centralized in the boundary module.

## Phases
### Phase 0 — Inventory and interface guardrails
- Map plumbing in [server/fishtest/http/api.py](server/fishtest/http/api.py) and [server/fishtest/http/views.py](server/fishtest/http/views.py):
	- request shim fields, JSON parsing behavior, response headers, session flags, template context.
- Define `Annotated` dependency aliases (`RequestShimDep`, `JsonBodyDep`, `CsrfDep`, `UIContextDep`).
- Specify boundary exports checklist.
- Remove local copies when helpers are extracted (no duplication).

### Phase 1 — Boundary module (API shim)
- Implement boundary in [server/fishtest/http/boundary.py](server/fishtest/http/boundary.py).
- Provide `get_request_shim()` and `get_json_body()` with current error behavior preserved.
- Extract minimal helpers: request shim constructor, JSON parser with error mapping,
	`apply_response_headers()`, `commit_session_response()`, `build_template_context()`.
- Keep `run_in_threadpool` boundaries explicit in entrypoints.

### Phase 2 — Entrypoint refactor + UI dependency migration
- Replace duplicated plumbing in [server/fishtest/http/api.py](server/fishtest/http/api.py) and
	[server/fishtest/http/views.py](server/fishtest/http/views.py) with boundary imports.
- Apply `Depends`/`Annotated` aliases where they reduce duplication.
- Move UI request shim, CSRF extraction, and UI response/header helpers into the boundary only when it reduces duplication.
- Move view-config decorators/registry helpers into the boundary only if route registration stays explicit.
- Keep UI context assembly readable; no helper named “glue” or “pipeline”.

### Phase 3 — Session migration (safe rollout)
- Centralize session commit/remember/forget logic in the boundary module.
- Migrate entrypoints in small steps, keeping old paths until parity tests confirm behavior.
- Ensure cookie names/attributes and remember/forget flags match legacy semantics.

### Phase 4 — Template boundary
- Use boundary helpers (`build_template_context()`, `apply_response_headers()`, `commit_session_response()`).
- Add optional `render_html_ctx()` only if it shortens route code without increasing hop count.
- Add-on (recommended): align error renderers with `build_template_context()` and keep template rendering explicit
	(no new helper).
- Ensure template contexts include `request` and keep legacy defaults.
- Keep template rendering explicit in [server/fishtest/http/views.py](server/fishtest/http/views.py).

### Phase 5 — Behavior parity tests
- Add/update tests for:
	- shim parity (headers, params, cookies, URL/host, remote address)
	- JSON parsing errors
	- template context (CSRF, user, flash, static URL mapping)
	- session commit/remember/forget semantics
	- redirects and status codes unchanged for API/UI
	- others modules/functions added in this iteration that must be covered in test
- Run parity scripts after each sub-step.

### Phase 6 — Refactor/abstraction
- Scope: modules under [server/fishtest/http](server/fishtest/http) excluding
	[server/fishtest/http/api.py](server/fishtest/http/api.py) and
	[server/fishtest/http/views.py](server/fishtest/http/views.py).
- Review structure, naming, duplication, and import layering for clarity.
- Propose lean refactor options using idiomatic Python and best practices.
- Renames/merges are allowed when they make the code clearer with minimal churn.
- Split [server/fishtest/http/boundary.py](server/fishtest/http/boundary.py) into
	[server/fishtest/http/api_boundary.py](server/fishtest/http/api_boundary.py) and
	[server/fishtest/http/view_boundary.py](server/fishtest/http/view_boundary.py) only if it improves the interface.
- Update Phase 7 with the analysis outcome; no further user prompts.
- Implement a refactor only if benefits clearly outweigh churn.
- Run parity scripts.

### Phase 7 — Cleanup and documentation
- Remove dead code and stale comments in [server/fishtest/http/api.py](server/fishtest/http/api.py) and
	[server/fishtest/http/views.py](server/fishtest/http/views.py).
- Update this document with a final done checklist.
- Update all documentations to reflect the new code status (1-FATSAPI 2-ARCHITECTURE, 3-MILESTONE).

## Phase results (current branch)
### Phase 0 — Complete (2026-01-29)
Deliverables:
- Inventory captured (request shim fields, JSON parsing behavior, response headers, session flags, template context).
- Boundary exports checklist defined.

Result:
- Shared HTTP plumbing inventory finalized for Phase 1 extraction.

Parity:
- Not applicable (inventory phase).

Metrics:
- Not applicable.

### Phase 1 — Complete (2026-01-29)
Deliverables:
- Boundary module created at [server/fishtest/http/boundary.py](server/fishtest/http/boundary.py) with
	`ApiRequestShim`, `JsonBodyResult`, `get_request_shim()`, `get_json_body()`,
	`apply_response_headers()`, `commit_session_response()`, `build_template_context()`,
	and dependency aliases.
- Removed legacy [server/fishtest/http/plumbing.py](server/fishtest/http/plumbing.py).

Result:
- Shared HTTP plumbing centralized in the boundary module with explicit entrypoint usage.

Parity:
- Not applicable (module creation phase).

Metrics:
- Not applicable.

### Phase 2 — Complete (2026-01-29)
Deliverables:
- API entrypoints use boundary shims in [server/fishtest/http/api.py](server/fishtest/http/api.py).
- UI entrypoints use boundary response/session/template helpers in
	[server/fishtest/http/views.py](server/fishtest/http/views.py).
- CSRF enforcement now imports `csrf_or_403()` via the boundary re-export.

Result:
- UI request shim and view-config decorators remain in views because there is no cross-file duplication.

Parity:
- [WIP/tools/parity_check_api_ast.py](WIP/tools/parity_check_api_ast.py): OK (expected drift noted for downloads).
- [WIP/tools/parity_check_views_ast.py](WIP/tools/parity_check_views_ast.py): OK.

Metrics:
- Hop count ≤ 1 helper hop per endpoint.

### Phase 3 — Complete (2026-01-29)
Deliverables:
- Centralized session remember/forget helpers in the boundary module and used them from entrypoints.
- Session commit remains centralized via `commit_session_response()` and
	`commit_session_flags()` for UI error renderers.
- Boundary response shim simplified with `ResponseShim` and shared header/session helpers.

Result:
- Session commit/remember/forget logic is centralized at the boundary.

Parity:
- [WIP/tools/parity_check_api_ast.py](WIP/tools/parity_check_api_ast.py): OK (expected drift noted for downloads).
- [WIP/tools/parity_check_views_ast.py](WIP/tools/parity_check_views_ast.py): OK.

Metrics:
- Hop count ≤ 1 helper hop per endpoint.
- Helper calls ≤ 2 per endpoint.

### Phase 4 — Complete (2026-01-29)
Deliverables:
- Error renderers now use `build_template_context()` for `request`-aware context in
	[server/fishtest/http/views.py](server/fishtest/http/views.py).
- No `render_html_ctx()` helper added; template rendering remains explicit.

Result:
- Template context assembly is consistent across normal renders and error renders.

Parity:
- [WIP/tools/parity_check_api_ast.py](WIP/tools/parity_check_api_ast.py): OK (expected drift noted for downloads).
- [WIP/tools/parity_check_views_ast.py](WIP/tools/parity_check_views_ast.py): OK.

Metrics:
- Hop count ≤ 1 helper hop per endpoint.
- Helper calls ≤ 2 per endpoint.

### Phase 5 — Complete (2026-01-29)
Deliverables:
- Added HTTP boundary parity tests in
	[server/tests/test_http_boundary.py](server/tests/test_http_boundary.py) covering:
	- shim parity (headers, params, cookies, URL/host, remote address)
	- JSON parsing errors
	- template context (CSRF, user, flash, static_url mapping)
	- session remember/forget commit semantics
	- UI redirects and status codes unchanged

Result:
- Boundary behaviors validated via focused parity tests.

Parity:
- [WIP/tools/parity_check_api_ast.py](WIP/tools/parity_check_api_ast.py): OK (expected drift noted for downloads).
- [WIP/tools/parity_check_views_ast.py](WIP/tools/parity_check_views_ast.py): OK.

Metrics:
- New tests added: 6.

### Phase 6 — Complete (2026-01-29)
Deliverables:
- Removed unused `apply_session_cookie()` from [server/fishtest/http/ui_pipeline.py](server/fishtest/http/ui_pipeline.py).
- Removed duplicate `apply_response_headers()` from [server/fishtest/http/ui_pipeline.py](server/fishtest/http/ui_pipeline.py);
	boundary helper remains in [server/fishtest/http/boundary.py](server/fishtest/http/boundary.py).
- Moved UI error renderers into [server/fishtest/http/ui_errors.py](server/fishtest/http/ui_errors.py) and
	updated [server/fishtest/http/errors.py](server/fishtest/http/errors.py) to depend on it instead of
	[server/fishtest/http/views.py](server/fishtest/http/views.py).

Result:
- Duplicate/unused HTTP helpers removed and error rendering decoupled from views.

Parity:
- [WIP/tools/parity_check_api_ast.py](WIP/tools/parity_check_api_ast.py): OK (expected drift noted for downloads).
- [WIP/tools/parity_check_views_ast.py](WIP/tools/parity_check_views_ast.py): OK.

Metrics:
- Unused helpers removed: 2.
- New modules added: 1.

### Phase 7 — Complete (2026-01-29)
Deliverables:
- Cleanup completed: removed unused note block in [server/fishtest/http/api.py](server/fishtest/http/api.py).
- Cleanup completed: removed unused `Request` import in [server/fishtest/http/views.py](server/fishtest/http/views.py).
- Docs updated: [WIP/docs/1-FASTAPI-REFACTOR.md](WIP/docs/1-FASTAPI-REFACTOR.md),
	[WIP/docs/2-ARCHITECTURE.md](WIP/docs/2-ARCHITECTURE.md),
	[WIP/docs/3-MILESTONES.md](WIP/docs/3-MILESTONES.md).

Result:
- Cleanup and documentation finalized for Milestone 7.

Parity:
- Not applicable (documentation/cleanup only).

Metrics:
- Not applicable.

Final done checklist:
- [x] Boundary helpers centralized and entrypoints updated.
- [x] Session and template behavior parity preserved.
- [x] Parity tests and scripts pass with expected drift noted.
- [x] Cleanup completed and docs updated.
